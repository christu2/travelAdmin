<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2563eb;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-success {
            background: #059669;
            color: white;
        }
        .btn-success:hover {
            background: #047857;
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .day-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #f9fafb;
        }
        .day-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 16px;
        }
        .activity-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .activity-time {
            background: #eff6ff;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 8px;
        }
        .flight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .flight-details {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }
        .flight-segment {
            text-align: center;
        }
        .flight-arrow {
            font-size: 24px;
            color: #fbbf24;
        }
        .cost-summary {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 500;
        }
        .tab:hover {
            background: #f3f4f6;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // FlightAware API Configuration
        // SECURITY: Never hardcode API keys in source code
        const FLIGHTAWARE_CONFIG = {
            // Local proxy server to handle CORS issues
            proxyUrl: 'http://localhost:3001/api',
            directApiKey: '{{FLIGHTAWARE_API_KEY}}', // FlightAware API key - injected by start-services.sh
            freeCredit: 5 // $5 USD per month
        };

        // Hotel Content API Configuration
        const HOTEL_CONFIG = {
            proxyUrl: 'http://localhost:3002/api', // Hotel proxy server
            supportedSources: ['tripadvisor', 'foursquare'], // Fallback to mock if needed
        };

        // Clean flight number by removing spaces and converting to uppercase
        function cleanFlightNumber(flightNumber) {
            return flightNumber.replace(/\s+/g, '').toUpperCase();
        }

        // Search flight by flight number and date
        async function searchFlightByNumber(flightNumber, date) {
            try {
                // Clean the flight number first
                const cleanedFlightNumber = cleanFlightNumber(flightNumber);
                console.log(`Searching for flight ${flightNumber} → ${cleanedFlightNumber} on ${date}`);
                
                // Try FlightAware API via local proxy server first
                try {
                    console.log('Checking if proxy server is running...');
                    
                    // Check if proxy server is available
                    const healthCheck = await fetch(`${FLIGHTAWARE_CONFIG.proxyUrl}/health`);
                    
                    if (healthCheck.ok) {
                        console.log('Proxy server is running, making FlightAware API call...');
                        
                        // Convert date from MM/DD/YYYY to YYYY-MM-DD format
                        const formattedDate = convertDateFormat(date);
                        console.log('Original date:', date, 'Formatted date:', formattedDate);
                        
                        const apiUrl = `${FLIGHTAWARE_CONFIG.proxyUrl}/flight/${cleanedFlightNumber}?date=${formattedDate}`;
                        console.log('API URL:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Raw FlightAware API response:', JSON.stringify(data, null, 2));
                            
                            const flightData = parseFlightAwareData(data, formattedDate);
                            if (flightData) {
                                console.log('Successfully parsed FlightAware flight data:', flightData);
                                return flightData;
                            } else {
                                console.log('No matching flight found for date, trying mock data...');
                            }
                        } else {
                            const errorData = await response.json();
                            console.log('FlightAware API error via proxy:', response.status, errorData);
                        }
                    } else {
                        console.log('Proxy server not running, using mock data...');
                    }
                } catch (proxyError) {
                    console.log('Proxy server error, falling back to mock data:', proxyError.message);
                }
                
                // Fallback to comprehensive mock data
                const mockFlightData = getMockFlightData(cleanedFlightNumber, date);
                if (mockFlightData) {
                    console.log('Using mock flight data:', mockFlightData);
                    return mockFlightData;
                }

                return null;
            } catch (error) {
                console.error('Flight search error:', error);
                return null;
            }
        }

        // Mock flight data for testing (comprehensive set for demo)
        function getMockFlightData(flightNumber, date) {
            const mockFlights = {
                // American Airlines
                'AA1': {
                    airline: 'American Airlines',
                    departure: { airport: 'John F. Kennedy International Airport', airportCode: 'JFK', time: '08:00' },
                    arrival: { airport: 'Los Angeles International Airport', airportCode: 'LAX', time: '11:30', date: date },
                    duration: '5h 30m'
                },
                'AA123': {
                    airline: 'American Airlines',
                    departure: { airport: 'Dallas/Fort Worth International Airport', airportCode: 'DFW', time: '09:15' },
                    arrival: { airport: 'London Heathrow Airport', airportCode: 'LHR', time: '23:45', date: date },
                    duration: '8h 30m'
                },
                
                // United Airlines
                'UA1': {
                    airline: 'United Airlines',
                    departure: { airport: 'San Francisco International Airport', airportCode: 'SFO', time: '14:15' },
                    arrival: { airport: 'Tokyo Haneda Airport', airportCode: 'HND', time: '17:45', date: getNextDay(date) },
                    duration: '11h 30m'
                },
                'UA456': {
                    airline: 'United Airlines',
                    departure: { airport: 'Newark Liberty International Airport', airportCode: 'EWR', time: '18:30' },
                    arrival: { airport: 'Frankfurt Airport', airportCode: 'FRA', time: '07:20', date: getNextDay(date) },
                    duration: '7h 50m'
                },
                
                // Delta Air Lines
                'DL1': {
                    airline: 'Delta Air Lines',
                    departure: { airport: 'Hartsfield-Jackson Atlanta International Airport', airportCode: 'ATL', time: '06:30' },
                    arrival: { airport: 'Charles de Gaulle Airport', airportCode: 'CDG', time: '20:15', date: date },
                    duration: '8h 45m'
                },
                'DL789': {
                    airline: 'Delta Air Lines',
                    departure: { airport: 'Los Angeles International Airport', airportCode: 'LAX', time: '11:00' },
                    arrival: { airport: 'Sydney Kingsford Smith Airport', airportCode: 'SYD', time: '06:30', date: getNextDay(date, 2) },
                    duration: '15h 30m'
                },
                
                // British Airways
                'BA1': {
                    airline: 'British Airways',
                    departure: { airport: 'London Heathrow Airport', airportCode: 'LHR', time: '10:30' },
                    arrival: { airport: 'John F. Kennedy International Airport', airportCode: 'JFK', time: '13:45', date: date },
                    duration: '8h 15m'
                },
                
                // Lufthansa
                'LH1': {
                    airline: 'Lufthansa',
                    departure: { airport: 'Frankfurt Airport', airportCode: 'FRA', time: '13:40' },
                    arrival: { airport: 'Tokyo Narita International Airport', airportCode: 'NRT', time: '08:05', date: getNextDay(date) },
                    duration: '11h 25m'
                },
                
                // Emirates
                'EK1': {
                    airline: 'Emirates',
                    departure: { airport: 'Dubai International Airport', airportCode: 'DXB', time: '03:30' },
                    arrival: { airport: 'Los Angeles International Airport', airportCode: 'LAX', time: '09:45', date: date },
                    duration: '16h 15m'
                }
            };

            return mockFlights[flightNumber.toUpperCase()] || null;
        }

        // Helper function to get next day(s)
        function getNextDay(dateString, daysToAdd = 1) {
            const date = new Date(dateString);
            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }

        // Convert date from MM/DD/YYYY to YYYY-MM-DD format
        function convertDateFormat(dateString) {
            // Check if already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return dateString;
            }
            
            // Handle MM/DD/YYYY format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                const [month, day, year] = dateString.split('/');
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // Handle other formats by parsing with Date
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (error) {
                console.log('Date conversion error:', error);
            }
            
            return dateString; // Return original if conversion fails
        }

        // Normalize flight number for FlightAware API (UA123 -> UAL123)
        function normalizeFlightNumber(flightNumber) {
            const airlineMap = {
                'UA': 'UAL',
                'AA': 'AAL', 
                'DL': 'DAL',
                'WN': 'SWA',
                'B6': 'JBU',
                'AS': 'ASA',
                'NK': 'NKS',
                'F9': 'FFT',
                'G4': 'AAY'
            };
            
            const match = flightNumber.match(/^([A-Z]{2})(\d+)$/);
            if (match) {
                const [, airline, number] = match;
                const normalizedAirline = airlineMap[airline] || airline;
                return `${normalizedAirline}${number}`;
            }
            
            return flightNumber; // Return as-is if no match
        }

        // Parse FlightAware API response
        function parseFlightAwareData(apiData, searchDate) {
            try {
                console.log('Parsing FlightAware data structure:', Object.keys(apiData));
                
                if (!apiData || !apiData.flights || !apiData.flights.length) {
                    console.log('No flight data found in FlightAware response');
                    return null;
                }

                // Find flight for the specific date
                const targetDate = new Date(searchDate);
                const matchingFlight = apiData.flights.find(flight => {
                    if (flight.scheduled_out) {
                        const flightDate = new Date(flight.scheduled_out);
                        return flightDate.toDateString() === targetDate.toDateString();
                    }
                    return false;
                });

                const flight = matchingFlight || apiData.flights[0]; // Use first if no date match
                console.log('Selected flight:', JSON.stringify(flight, null, 2));
                
                const flightData = {
                    airline: getAirlineName(flight.operator_iata) || flight.operator || 'Unknown Airline',
                    departure: {
                        airport: flight.origin?.name || flight.origin?.airport_name || 'Unknown Airport',
                        airportCode: flight.origin?.code_iata || flight.origin?.code || 'UNK',
                        time: flight.scheduled_out ? formatTime(flight.scheduled_out, flight.origin?.timezone) : '00:00'
                    },
                    arrival: {
                        airport: flight.destination?.name || flight.destination?.airport_name || 'Unknown Airport', 
                        airportCode: flight.destination?.code_iata || flight.destination?.code || 'UNK',
                        time: flight.scheduled_in ? formatTime(flight.scheduled_in, flight.destination?.timezone) : '00:00',
                        date: flight.scheduled_in ? flight.scheduled_in.split('T')[0] : 
                              flight.scheduled_out ? flight.scheduled_out.split('T')[0] : ''
                    },
                    duration: calculateDuration(flight.scheduled_out, flight.scheduled_in) || 'Unknown'
                };

                console.log('Parsed FlightAware flight data:', flightData);
                
                // Only return if we have meaningful data
                if (flightData.airline !== 'Unknown Airline' || 
                    flightData.departure.airportCode !== 'UNK' || 
                    flightData.arrival.airportCode !== 'UNK') {
                    return flightData;
                }
                
                console.log('Parsed data appears to be incomplete, will use fallback');
                return null;
                
            } catch (error) {
                console.error('Error parsing FlightAware flight data:', error);
                return null;
            }
        }

        // Parse AviationStack API response (keeping for reference)
        function parseAviationStackFlightData(apiData, searchedFlightNumber) {
            try {
                console.log('Parsing AviationStack data structure:', Object.keys(apiData));
                
                if (!apiData || !apiData.data || !apiData.data.length) {
                    console.log('No flight data found in AviationStack response');
                    return null;
                }

                // Find the flight that matches our search (there might be multiple results)
                let flight = apiData.data.find(f => 
                    f.flight?.iata === searchedFlightNumber || 
                    f.flight?.icao === searchedFlightNumber ||
                    f.flight?.number === searchedFlightNumber
                );
                
                if (!flight) {
                    flight = apiData.data[0]; // Take first result if no exact match
                }
                
                console.log('Flight object structure:', Object.keys(flight));
                console.log('Flight details:', JSON.stringify(flight, null, 2));
                
                const flightData = {
                    airline: getAirlineName(flight.airline?.iata) || flight.airline?.name || 'Unknown Airline',
                    departure: {
                        airport: flight.departure?.airport || 'Unknown Airport',
                        airportCode: flight.departure?.iata || 'UNK',
                        time: flight.departure?.scheduled ? formatTime(flight.departure.scheduled) : '00:00'
                    },
                    arrival: {
                        airport: flight.arrival?.airport || 'Unknown Airport',
                        airportCode: flight.arrival?.iata || 'UNK',
                        time: flight.arrival?.scheduled ? formatTime(flight.arrival.scheduled) : '00:00',
                        date: flight.arrival?.scheduled ? flight.arrival.scheduled.split('T')[0] : 
                              flight.departure?.scheduled ? flight.departure.scheduled.split('T')[0] : ''
                    },
                    duration: calculateDuration(flight.departure?.scheduled, flight.arrival?.scheduled) || 'Unknown'
                };

                console.log('Parsed AviationStack flight data:', flightData);
                
                // Only return if we have meaningful data
                if (flightData.airline !== 'Unknown Airline' || 
                    flightData.departure.airportCode !== 'UNK' || 
                    flightData.arrival.airportCode !== 'UNK') {
                    return flightData;
                }
                
                console.log('Parsed data appears to be incomplete, will use fallback');
                return null;
                
            } catch (error) {
                console.error('Error parsing AviationStack flight data:', error);
                return null;
            }
        }

        // Helper function to get airline name from code
        function getAirlineName(code) {
            const airlineMap = {
                'AA': 'American Airlines',
                'UA': 'United Airlines', 
                'DL': 'Delta Air Lines',
                'BA': 'British Airways',
                'LH': 'Lufthansa',
                'AF': 'Air France',
                'KL': 'KLM',
                'VS': 'Virgin Atlantic',
                'EK': 'Emirates',
                'QR': 'Qatar Airways',
                'SQ': 'Singapore Airlines',
                'NH': 'ANA',
                'JL': 'Japan Airlines',
                'AZ': 'ITA Airways',
                'ITY': 'ITA Airways',
                'WN': 'Southwest Airlines',
                'B6': 'JetBlue Airways',
                'AS': 'Alaska Airlines',
                'NK': 'Spirit Airlines',
                'F9': 'Frontier Airlines'
            };
            return airlineMap[code] || null;
        }

        // Helper function to get airport name from code (basic mapping)
        function getAirportName(code) {
            const airportMap = {
                'JFK': 'John F. Kennedy International Airport',
                'LAX': 'Los Angeles International Airport',
                'SFO': 'San Francisco International Airport',
                'HND': 'Tokyo Haneda Airport',
                'NRT': 'Tokyo Narita International Airport',
                'ATL': 'Hartsfield-Jackson Atlanta International Airport',
                'CDG': 'Charles de Gaulle Airport',
                'LHR': 'London Heathrow Airport',
                'DXB': 'Dubai International Airport',
                'SIN': 'Singapore Changi Airport'
            };
            return airportMap[code] || `${code} Airport`;
        }

        // Helper function to format time from ISO string
        function formatTime(isoString, timezone = null) {
            try {
                const date = new Date(isoString);
                
                // If timezone is provided, format in that timezone
                if (timezone) {
                    return date.toLocaleTimeString('en-US', {
                        timeZone: timezone,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // Default: use UTC time formatted as HH:MM
                return date.toTimeString().slice(0, 5);
            } catch (error) {
                return '00:00';
            }
        }

        // Helper function to calculate flight duration
        function calculateDuration(departureTime, arrivalTime) {
            try {
                const departure = new Date(departureTime);
                const arrival = new Date(arrivalTime);
                const diffMs = arrival - departure;
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}h ${minutes}m`;
            } catch (error) {
                return 'Unknown';
            }
        }

        // Search airports by city/code (for future hotel integration)
        async function searchAirports(query) {
            try {
                // TODO: Implement Amadeus Airport Search API
                console.log(`Searching airports for: ${query}`);
                return [];
            } catch (error) {
                console.error('Airport search error:', error);
                return [];
            }
        }

        // Hotel search function - integrates with hotel proxy server
        async function searchHotels(location, checkIn, checkOut, guests = 2) {
            try {
                console.log(`🏨 Searching hotels in ${location} from ${checkIn} to ${checkOut} for ${guests} guests`);
                
                // Check if hotel proxy server is running
                try {
                    const healthCheck = await fetch(`${HOTEL_CONFIG.proxyUrl}/health`);
                    
                    if (healthCheck.ok) {
                        console.log('✅ Hotel proxy server is running');
                        
                        const searchUrl = `${HOTEL_CONFIG.proxyUrl}/hotels/search?location=${encodeURIComponent(location)}&checkIn=${checkIn}&checkOut=${checkOut}&guests=${guests}`;
                        const response = await fetch(searchUrl);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('✅ Hotel search successful:', data);
                            
                            if (data.success && data.hotels && data.hotels.length > 0) {
                                return data.hotels;
                            } else {
                                console.log('ℹ️ No hotels found in search results');
                                return [];
                            }
                        } else {
                            const errorData = await response.text();
                            console.log('❌ Hotel API error:', response.status, errorData);
                        }
                    } else {
                        console.log('❌ Hotel proxy server health check failed');
                    }
                } catch (proxyError) {
                    console.log('❌ Hotel proxy server not available:', proxyError.message);
                }

                // Fallback to empty array if API fails
                console.log('ℹ️ Hotel search failed - returning empty results');
                return [];
                
            } catch (error) {
                console.error('❌ Error in searchHotels:', error);
                return [];
            }
        }

        // Convert hotel search result to accommodation format
        function convertHotelToAccommodation(hotel, checkIn, checkOut) {
            return {
                id: `acc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: hotel.name,
                type: hotel.hotelChain ? 'hotel' : 'boutique',
                checkIn: checkIn,
                checkOut: checkOut,
                nights: calculateNights(checkIn, checkOut),
                location: {
                    name: hotel.name,
                    address: hotel.address,
                    coordinates: null,
                    nearbyLandmarks: ''
                },
                roomType: 'Standard Room',
                amenities: hotel.amenities || [],
                cost: {
                    paymentType: 'cash',
                    cashAmount: estimateHotelCost(hotel.priceLevel, calculateNights(checkIn, checkOut)),
                    pointsAmount: null,
                    pointsProgram: null,
                    totalCashValue: estimateHotelCost(hotel.priceLevel, calculateNights(checkIn, checkOut)),
                    notes: `Based on ${hotel.priceLevel} price level`
                },
                bookingUrl: hotel.directBookingUrl || hotel.website || '',
                bookingInstructions: hotel.bookingInstructions || 'Check rates and book directly',
                cancellationPolicy: 'Please check with hotel for cancellation policy',
                contactInfo: {
                    phone: hotel.phone || '',
                    email: '',
                    website: hotel.website || ''
                }
            };
        }

        // Helper function to calculate nights between dates
        function calculateNights(checkIn, checkOut) {
            if (!checkIn || !checkOut) return 1;
            
            const startDate = new Date(checkIn);
            const endDate = new Date(checkOut);
            const timeDiff = endDate - startDate;
            const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            
            return Math.max(daysDiff, 1);
        }

        // Helper function to estimate hotel cost from price level
        function estimateHotelCost(priceLevel, nights) {
            const baseCost = {
                '$': 80,
                '$$': 150,
                '$$$': 250,
                '$$$$': 400
            };
            
            const perNightCost = baseCost[priceLevel] || 180;
            return perNightCost * nights;
        }

        // Date Utilities for Timezone-Agnostic Handling
        const DateUtils = {
            // Format Firebase Timestamp to date string without timezone issues
            formatFirebaseDate(timestamp) {
                if (!timestamp || !timestamp.seconds) return 'TBD';
                
                // Create date from timestamp
                const date = new Date(timestamp.seconds * 1000);
                
                // Extract date components to avoid timezone shifts
                const year = date.getUTCFullYear();
                const month = date.getUTCMonth();
                const day = date.getUTCDate();
                
                // Create a new date in local timezone with same calendar date
                const localDate = new Date(year, month, day);
                
                return localDate.toLocaleDateString();
            },

            // Format date string (YYYY-MM-DD) to display string
            formatDateString(dateString) {
                if (!dateString) return 'TBD';
                
                // Parse YYYY-MM-DD format
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                const day = parseInt(parts[2]);
                
                // Create date in local timezone
                const date = new Date(year, month, day);
                
                return date.toLocaleDateString();
            },

            // Calculate days between two Firebase timestamps
            daysBetween(startTimestamp, endTimestamp) {
                if (!startTimestamp?.seconds || !endTimestamp?.seconds) return 0;
                
                const start = new Date(startTimestamp.seconds * 1000);
                const end = new Date(endTimestamp.seconds * 1000);
                
                // Use UTC date values to avoid timezone issues
                const startUTC = new Date(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate());
                const endUTC = new Date(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate());
                
                const diffTime = Math.abs(endUTC - startUTC);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },

            // Format date range
            formatDateRange(startTimestamp, endTimestamp) {
                const startDate = this.formatFirebaseDate(startTimestamp);
                const endDate = this.formatFirebaseDate(endTimestamp);
                
                if (startDate === 'TBD' || endDate === 'TBD') {
                    return 'TBD';
                }
                
                return `${startDate} - ${endDate}`;
            }
        };

        // Flexible Cost Input Component
        function FlexibleCostInput({ label, cost, onChange }) {
            const updateCost = (field, value) => {
                const updatedCost = { ...cost, [field]: value };
                
                // Auto-calculate totalCashValue based on payment type
                if (updatedCost.paymentType === 'cash') {
                    updatedCost.totalCashValue = updatedCost.cashAmount;
                    updatedCost.pointsAmount = null;
                    updatedCost.pointsProgram = null;
                } else if (updatedCost.paymentType === 'points') {
                    updatedCost.cashAmount = 0;
                    // Keep totalCashValue as the cash equivalent for comparison
                } else if (updatedCost.paymentType === 'hybrid') {
                    updatedCost.totalCashValue = updatedCost.cashAmount;
                }
                
                onChange(updatedCost);
            };

            return (
                <div className="form-group">
                    <label className="form-label">{label}</label>
                    <div style={{border: '1px solid #d1d5db', borderRadius: '6px', padding: '12px', background: '#f9fafb'}}>
                        <div style={{marginBottom: '12px'}}>
                            <label className="form-label" style={{fontSize: '12px', marginBottom: '4px'}}>Payment Type</label>
                            <select
                                className="form-select"
                                style={{fontSize: '14px'}}
                                value={cost.paymentType || 'cash'}
                                onChange={(e) => updateCost('paymentType', e.target.value)}
                            >
                                <option value="cash">💵 Cash Only</option>
                                <option value="points">⭐ Points Only</option>
                                <option value="hybrid">💵+⭐ Cash + Points</option>
                            </select>
                        </div>

                        {(cost.paymentType === 'cash' || cost.paymentType === 'hybrid') && (
                            <div style={{marginBottom: '8px'}}>
                                <label className="form-label" style={{fontSize: '12px', marginBottom: '4px'}}>Cash Amount ($)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    style={{fontSize: '14px'}}
                                    placeholder="0"
                                    value={cost.cashAmount || ''}
                                    onChange={(e) => updateCost('cashAmount', parseFloat(e.target.value) || 0)}
                                />
                            </div>
                        )}

                        {(cost.paymentType === 'points' || cost.paymentType === 'hybrid') && (
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px'}}>
                                <div>
                                    <label className="form-label" style={{fontSize: '12px', marginBottom: '4px'}}>Points</label>
                                    <input
                                        type="number"
                                        className="form-input"
                                        style={{fontSize: '14px'}}
                                        placeholder="0"
                                        value={cost.pointsAmount || ''}
                                        onChange={(e) => updateCost('pointsAmount', parseInt(e.target.value) || 0)}
                                    />
                                </div>
                                <div>
                                    <label className="form-label" style={{fontSize: '12px', marginBottom: '4px'}}>Program</label>
                                    <select
                                        className="form-select"
                                        style={{fontSize: '14px'}}
                                        value={cost.pointsProgram || ''}
                                        onChange={(e) => updateCost('pointsProgram', e.target.value)}
                                    >
                                        <option value="">Select Program</option>
                                        <option value="United">United MileagePlus</option>
                                        <option value="Delta">Delta SkyMiles</option>
                                        <option value="American">American AAdvantage</option>
                                        <option value="Chase">Chase Ultimate Rewards</option>
                                        <option value="Amex">Amex Membership Rewards</option>
                                        <option value="Citi">Citi ThankYou</option>
                                        <option value="Capital One">Capital One Miles</option>
                                        <option value="Hyatt">World of Hyatt</option>
                                        <option value="Marriott">Marriott Bonvoy</option>
                                        <option value="Hilton">Hilton Honors</option>
                                        <option value="IHG">IHG Rewards</option>
                                    </select>
                                </div>
                            </div>
                        )}

                        {cost.paymentType === 'points' && (
                            <div style={{marginBottom: '8px'}}>
                                <label className="form-label" style={{fontSize: '12px', marginBottom: '4px'}}>Cash Value Equivalent ($)</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    style={{fontSize: '14px'}}
                                    placeholder="Estimated cash value"
                                    value={cost.totalCashValue || ''}
                                    onChange={(e) => updateCost('totalCashValue', parseFloat(e.target.value) || 0)}
                                />
                            </div>
                        )}

                        <div>
                            <label className="form-label" style={{fontSize: '12px', marginBottom: '4px'}}>Notes (Optional)</label>
                            <input
                                type="text"
                                className="form-input"
                                style={{fontSize: '14px'}}
                                placeholder="Booking tips, availability notes, etc."
                                value={cost.notes || ''}
                                onChange={(e) => updateCost('notes', e.target.value)}
                            />
                        </div>

                        <div style={{marginTop: '8px', padding: '8px', background: '#e0f2fe', borderRadius: '4px'}}>
                            <strong style={{fontSize: '14px', color: '#0277bd'}}>
                                Preview: {formatCostDisplay(cost)}
                            </strong>
                        </div>
                    </div>
                </div>
            );
        }

        function formatCostDisplay(cost) {
            if (!cost) return '$0';
            
            switch (cost.paymentType) {
                case 'cash':
                    return `$${cost.cashAmount || 0}`;
                case 'points':
                    return `${(cost.pointsAmount || 0).toLocaleString()} ${cost.pointsProgram || 'points'}`;
                case 'hybrid':
                    return `$${cost.cashAmount || 0} + ${(cost.pointsAmount || 0).toLocaleString()} ${cost.pointsProgram || 'pts'}`;
                default:
                    return `$${cost.cashAmount || 0}`;
            }
        }

        // Firebase configuration - using environment variables
        // SECURITY: Never hardcode API keys in source code
        const firebaseConfig = {
            apiKey: "{{FIREBASE_API_KEY}}", // Firebase API key - injected by start-services.sh
            authDomain: "travel-consulting-app-1.firebaseapp.com",
            projectId: "travel-consulting-app-1",
            storageBucket: "travel-consulting-app-1.firebasestorage.app",
            messagingSenderId: "123591590128",
            appId: "1:123591590128:ios:ef15580e6e03d5e6160235",
            databaseURL: "https://travel-consulting-app-1-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [tripId, setTripId] = useState(new URLSearchParams(window.location.search).get('tripId'));

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setUser(user);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            const signIn = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider);
            };

            if (loading) {
                return <div style={{padding: '20px'}}>Loading...</div>;
            }

            if (!user) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Itinerary Builder</h1>
                            <p>Please sign in to access the itinerary builder.</p>
                            <button className="btn btn-primary" onClick={signIn}>
                                Sign in with Google
                            </button>
                        </div>
                    </div>
                );
            }

            if (user.email !== 'nchristus93@gmail.com') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Access Denied</h1>
                            <p>You don't have permission to access this tool.</p>
                            <button className="btn btn-primary" onClick={() => auth.signOut()}>
                                Sign Out
                            </button>
                        </div>
                    </div>
                );
            }

            if (!tripId) {
                return <TripSelector onSelectTrip={setTripId} user={user} />;
            }

            return <ItineraryBuilder tripId={tripId} user={user} onBack={() => setTripId(null)} />;
        }

        function TripSelector({ onSelectTrip, user }) {
            const [trips, setTrips] = useState([]);
            const [usersData, setUsersData] = useState({});
            const [userPointsData, setUserPointsData] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('trips')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(async (snapshot) => {
                        const tripsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        // Fetch user data for each trip
                        const userIds = [...new Set(tripsData.map(trip => trip.userId))];
                        const usersInfo = {};
                        const pointsInfo = {};
                        
                        for (const userId of userIds) {
                            try {
                                // Fetch user profile
                                const userDoc = await db.collection('users').doc(userId).get();
                                if (userDoc.exists) {
                                    usersInfo[userId] = userDoc.data();
                                }
                                
                                // Fetch user points
                                const pointsDoc = await db.collection('userPoints').doc(userId).get();
                                if (pointsDoc.exists) {
                                    const pointsData = pointsDoc.data();
                                    const creditCardTotal = Object.values(pointsData.creditCardPoints || {}).reduce((sum, points) => sum + (points || 0), 0);
                                    const hotelTotal = Object.values(pointsData.hotelPoints || {}).reduce((sum, points) => sum + (points || 0), 0);
                                    const airlineTotal = Object.values(pointsData.airlinePoints || {}).reduce((sum, points) => sum + (points || 0), 0);
                                    
                                    pointsInfo[userId] = {
                                        ...pointsData,
                                        totalPoints: creditCardTotal + hotelTotal + airlineTotal,
                                        creditCardTotal,
                                        hotelTotal,
                                        airlineTotal
                                    };
                                } else {
                                    pointsInfo[userId] = { totalPoints: 0 };
                                }
                            } catch (error) {
                                console.warn(`Failed to fetch data for user ${userId}:`, error);
                                usersInfo[userId] = { email: 'Unknown', name: 'Unknown User' };
                                pointsInfo[userId] = { totalPoints: 0 };
                            }
                        }
                        
                        setTrips(tripsData);
                        setUsersData(usersInfo);
                        setUserPointsData(pointsInfo);
                        setLoading(false);
                    });

                return unsubscribe;
            }, []);

            if (loading) {
                return <div style={{padding: '20px'}}>Loading trips...</div>;
            }

            return (
                <div className="container">
                    <div className="header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1>Select Trip to Build Itinerary</h1>
                                <p>Choose a trip to create a detailed day-by-day itinerary</p>
                            </div>
                            <button className="btn btn-secondary" onClick={() => auth.signOut()}>
                                Sign Out
                            </button>
                        </div>
                    </div>

                    <div className="section">
                        {trips.length === 0 ? (
                            <div style={{padding: '40px', textAlign: 'center', color: '#666'}}>
                                No trips found
                            </div>
                        ) : (
                            trips.map(trip => {
                                const destinations = trip.destinations?.join(', ') || trip.destination || 'Unknown';
                                const userData = usersData[trip.userId] || {};
                                const pointsData = userPointsData[trip.userId] || {};
                                const statusColors = {
                                    pending: '#f59e0b',
                                    processing: '#3b82f6',
                                    completed: '#10b981',
                                    cancelled: '#ef4444'
                                };
                                
                                return (
                                    <div 
                                        key={trip.id}
                                        onClick={() => onSelectTrip(trip.id)}
                                        style={{
                                            background: 'white',
                                            border: '1px solid #e5e7eb',
                                            borderRadius: '8px',
                                            padding: '20px',
                                            marginBottom: '16px',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'}
                                        onMouseLeave={(e) => e.target.style.boxShadow = 'none'}
                                    >
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px'}}>
                                            <div>
                                                <h3 style={{margin: '0 0 8px 0', color: '#1e40af'}}>{destinations}</h3>
                                                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '4px'}}>
                                                    <span style={{fontSize: '16px', fontWeight: '600', color: '#374151'}}>
                                                        👤 {userData.name || userData.displayName || 'Unknown User'}
                                                    </span>
                                                    <span style={{fontSize: '14px', color: '#6b7280'}}>
                                                        📧 {userData.email || 'Unknown Email'}
                                                    </span>
                                                </div>
                                                <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                                                    <span style={{
                                                        fontSize: '18px', 
                                                        fontWeight: 'bold', 
                                                        color: '#059669',
                                                        background: '#ecfdf5',
                                                        padding: '4px 8px',
                                                        borderRadius: '6px'
                                                    }}>
                                                        ⭐ {pointsData.totalPoints?.toLocaleString() || '0'} total pts
                                                    </span>
                                                    {pointsData.creditCardTotal > 0 && (
                                                        <span style={{fontSize: '12px', color: '#7c3aed'}}>
                                                            💳 {pointsData.creditCardTotal.toLocaleString()}
                                                        </span>
                                                    )}
                                                    {pointsData.hotelTotal > 0 && (
                                                        <span style={{fontSize: '12px', color: '#dc2626'}}>
                                                            🏨 {pointsData.hotelTotal.toLocaleString()}
                                                        </span>
                                                    )}
                                                    {pointsData.airlineTotal > 0 && (
                                                        <span style={{fontSize: '12px', color: '#2563eb'}}>
                                                            ✈️ {pointsData.airlineTotal.toLocaleString()}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            <span style={{
                                                background: statusColors[trip.status] || '#6b7280',
                                                color: 'white',
                                                padding: '6px 12px',
                                                borderRadius: '12px',
                                                fontSize: '12px',
                                                fontWeight: '500'
                                            }}>
                                                {trip.status || 'Unknown'}
                                            </span>
                                        </div>
                                        <div style={{color: '#666', fontSize: '14px', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px'}}>
                                            <div><strong>Dates:</strong> {DateUtils.formatDateRange(trip.startDate, trip.endDate)}</div>
                                            <div><strong>Duration:</strong> {(() => {
                                                if (trip.tripDuration) return `${trip.tripDuration} days`;
                                                if (trip.startDate?.seconds && trip.endDate?.seconds) {
                                                    const duration = DateUtils.daysBetween(trip.startDate, trip.endDate);
                                                    return `${duration} days`;
                                                }
                                                return 'Not specified';
                                            })()}</div>
                                            <div><strong>Group Size:</strong> {trip.groupSize || 1} people</div>
                                            <div><strong>Budget:</strong> {trip.budget || 'Not specified'}</div>
                                            <div><strong>Travel Style:</strong> {trip.travelStyle || 'Not specified'}</div>
                                            {trip.flexibleDates && <div style={{color: '#059669', fontWeight: '500'}}>📅 Flexible Dates</div>}
                                            {trip.flightClass && <div><strong>Flight Class:</strong> {trip.flightClass}</div>}
                                            {trip.interests && trip.interests.length > 0 && (
                                                <div style={{gridColumn: '1 / -1'}}><strong>Interests:</strong> {trip.interests.join(', ')}</div>
                                            )}
                                            {trip.specialRequests && (
                                                <div style={{gridColumn: '1 / -1'}}><strong>Special Requests:</strong> {trip.specialRequests}</div>
                                            )}
                                            
                                            {/* Detailed Points Breakdown */}
                                            {pointsData.totalPoints > 0 && (
                                                <div style={{gridColumn: '1 / -1', marginTop: '12px', padding: '12px', background: '#f0f9ff', borderRadius: '6px', border: '1px solid #bae6fd'}}>
                                                    <div style={{fontWeight: '600', marginBottom: '8px', color: '#0369a1'}}>💳 Points & Miles Breakdown:</div>
                                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '4px', fontSize: '13px'}}>
                                                        {Object.entries(pointsData.creditCardPoints || {}).map(([program, points]) => points > 0 && (
                                                            <div key={program} style={{color: '#7c3aed'}}>💳 {program}: {points.toLocaleString()}</div>
                                                        ))}
                                                        {Object.entries(pointsData.hotelPoints || {}).map(([program, points]) => points > 0 && (
                                                            <div key={program} style={{color: '#dc2626'}}>🏨 {program}: {points.toLocaleString()}</div>
                                                        ))}
                                                        {Object.entries(pointsData.airlinePoints || {}).map(([program, points]) => points > 0 && (
                                                            <div key={program} style={{color: '#2563eb'}}>✈️ {program}: {points.toLocaleString()}</div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <div style={{gridColumn: '1 / -1', fontSize: '12px', color: '#999', marginTop: '8px'}}>
                                                Created: {DateUtils.formatFirebaseDate(trip.createdAt)}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        }

        function ItineraryBuilder({ tripId, user, onBack }) {
            const [trip, setTrip] = useState(null);
            const [userData, setUserData] = useState({});
            const [userPoints, setUserPoints] = useState({});
            const [activeTab, setActiveTab] = useState('overview');
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            
            // Itinerary state
            const [overview, setOverview] = useState('');
            const [flights, setFlights] = useState([]);
            const [transportation, setTransportation] = useState([]);
            const [dailyPlans, setDailyPlans] = useState([]);
            const [accommodations, setAccommodations] = useState([]);

            useEffect(() => {
                const unsubscribe = db.collection('trips').doc(tripId)
                    .onSnapshot(async (doc) => {
                        if (doc.exists) {
                            const tripData = { id: doc.id, ...doc.data() };
                            setTrip(tripData);
                            
                            // Fetch user data for this trip
                            if (tripData.userId) {
                                try {
                                    const userDoc = await db.collection('users').doc(tripData.userId).get();
                                    if (userDoc.exists) {
                                        setUserData(userDoc.data());
                                    }
                                    
                                    const pointsDoc = await db.collection('userPoints').doc(tripData.userId).get();
                                    if (pointsDoc.exists) {
                                        const pointsData = pointsDoc.data();
                                        const creditCardTotal = Object.values(pointsData.creditCardPoints || {}).reduce((sum, points) => sum + (points || 0), 0);
                                        const hotelTotal = Object.values(pointsData.hotelPoints || {}).reduce((sum, points) => sum + (points || 0), 0);
                                        const airlineTotal = Object.values(pointsData.airlinePoints || {}).reduce((sum, points) => sum + (points || 0), 0);
                                        
                                        setUserPoints({
                                            ...pointsData,
                                            totalPoints: creditCardTotal + hotelTotal + airlineTotal,
                                            creditCardTotal,
                                            hotelTotal,
                                            airlineTotal
                                        });
                                    }
                                } catch (error) {
                                    console.warn('Failed to fetch user data:', error);
                                }
                            }
                            
                            // Load existing recommendation if available
                            if (tripData.recommendation) {
                                setOverview(tripData.recommendation.overview || '');
                                if (tripData.recommendation.itinerary) {
                                    const itinerary = tripData.recommendation.itinerary;
                                    
                                    // Handle multiple flight formats for backward compatibility
                                    if (itinerary.flights) {
                                        if (Array.isArray(itinerary.flights)) {
                                            // New format - array of flights with segments
                                            setFlights(itinerary.flights);
                                        } else if (itinerary.flights.segments) {
                                            // Previous format - single flight with segments
                                            setFlights([{
                                                id: 'flight_1',
                                                title: 'Flight 1',
                                                segments: itinerary.flights.segments,
                                                bookingInstructions: itinerary.flights.bookingInstructions || ''
                                            }]);
                                        } else if (itinerary.flights.outbound || itinerary.flights.return) {
                                            // Old format - convert outbound/return to segments in a single flight
                                            const segments = [];
                                            if (itinerary.flights.outbound) {
                                                segments.push({
                                                    id: 'outbound',
                                                    ...itinerary.flights.outbound
                                                });
                                            }
                                            if (itinerary.flights.return) {
                                                segments.push({
                                                    id: 'return',
                                                    ...itinerary.flights.return
                                                });
                                            }
                                            setFlights([{
                                                id: 'flight_1',
                                                title: 'Flight 1',
                                                segments,
                                                bookingInstructions: itinerary.flights.bookingInstructions || ''
                                            }]);
                                        }
                                    }
                                    
                                    setTransportation(itinerary.transportation || []);
                                    setDailyPlans(itinerary.dailyPlans || []);
                                    setAccommodations(itinerary.accommodations || []);
                                }
                            }
                        }
                        setLoading(false);
                    });

                return unsubscribe;
            }, [tripId]);

            const saveItinerary = async () => {
                setSaving(true);
                try {
                    // Auto-calculate total costs
                    const calculatedCosts = calculateTotalCosts(flights, transportation, dailyPlans, accommodations);
                    const totalCost = {
                        totalEstimate: calculatedCosts.total,
                        flights: calculatedCosts.flights,
                        transportation: calculatedCosts.transportation,
                        accommodation: calculatedCosts.accommodations,
                        activities: calculatedCosts.activities,
                        food: 0,
                        localTransport: 0,
                        miscellaneous: 0,
                        currency: 'USD'
                    };

                    const detailedItinerary = {
                        id: `itinerary_${Date.now()}`,
                        flights,
                        transportation,
                        dailyPlans,
                        accommodations,
                        totalCost,
                        bookingInstructions: {
                            overallInstructions: 'Please book all components as soon as possible to ensure availability.',
                            flightBookingTips: ['Book directly with airline for best customer service', 'Consider travel insurance'],
                            accommodationBookingTips: ['Read cancellation policies carefully', 'Check-in time is usually 3 PM'],
                            activityBookingTips: ['Book popular attractions in advance', 'Bring confirmation numbers'],
                            paymentMethods: ['Credit Card', 'PayPal', 'Bank Transfer'],
                            cancellationPolicies: 'Cancellation policies vary by provider. Check individual booking terms.',
                            travelInsuranceRecommendation: 'Consider comprehensive travel insurance for international trips.'
                        },
                        emergencyInfo: {
                            emergencyContacts: [],
                            localEmergencyNumbers: {},
                            nearestEmbassy: null,
                            medicalFacilities: [],
                            importantPhrases: {}
                        }
                    };

                    const recommendation = {
                        id: `rec_${Date.now()}`,
                        destination: trip.destinations?.[0] || trip.destination || 'Unknown',
                        overview,
                        itinerary: detailedItinerary,
                        activities: [],
                        accommodations: [],
                        transportation: null,
                        estimatedCost: totalCost,
                        bestTimeToVisit: '',
                        tips: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('trips').doc(tripId).update({
                        recommendation,
                        status: 'completed',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert('Itinerary saved successfully!');
                } catch (error) {
                    console.error('Error saving itinerary:', error);
                    alert('Failed to save itinerary');
                }
                setSaving(false);
            };

            if (loading) {
                return <div style={{padding: '20px'}}>Loading trip details...</div>;
            }

            if (!trip) {
                return <div style={{padding: '20px'}}>Trip not found</div>;
            }

            const destinations = trip.destinations?.join(', ') || trip.destination || 'Unknown';

            return (
                <div className="container">
                    <div className="header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                            <div>
                                <h1>Detailed Itinerary Builder</h1>
                                <p style={{fontSize: '18px', margin: '8px 0', color: '#1e40af'}}>
                                    Creating itinerary for: <strong>{destinations}</strong>
                                </p>
                                
                                <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', margin: '12px 0', border: '1px solid #e2e8f0'}}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '12px'}}>
                                        <span style={{fontSize: '16px', fontWeight: '600', color: '#374151'}}>
                                            👤 {userData.name || userData.displayName || 'Unknown User'}
                                        </span>
                                        <span style={{fontSize: '14px', color: '#6b7280'}}>
                                            📧 {userData.email || 'Unknown Email'}
                                        </span>
                                        <span style={{
                                            fontSize: '16px', 
                                            fontWeight: 'bold', 
                                            color: '#059669',
                                            background: '#ecfdf5',
                                            padding: '4px 8px',
                                            borderRadius: '6px'
                                        }}>
                                            ⭐ {userPoints.totalPoints?.toLocaleString() || '0'} total pts
                                        </span>
                                    </div>
                                    
                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px', fontSize: '14px', color: '#4b5563'}}>
                                        <div><strong>Dates:</strong> {DateUtils.formatDateRange(trip.startDate, trip.endDate)}</div>
                                        <div><strong>Duration:</strong> {(() => {
                                            if (trip.tripDuration) return `${trip.tripDuration} days`;
                                            if (trip.startDate?.seconds && trip.endDate?.seconds) {
                                                const duration = DateUtils.daysBetween(trip.startDate, trip.endDate);
                                                return `${duration} days`;
                                            }
                                            return 'Not specified';
                                        })()}</div>
                                        <div><strong>Group Size:</strong> {trip.groupSize || 1} people</div>
                                        <div><strong>Budget:</strong> {trip.budget || 'Not specified'}</div>
                                        <div><strong>Travel Style:</strong> {trip.travelStyle || 'Not specified'}</div>
                                        {trip.flexibleDates && <div style={{color: '#059669', fontWeight: '500'}}>📅 Flexible Dates</div>}
                                        {trip.flightClass && <div><strong>Flight Class:</strong> {trip.flightClass}</div>}
                                        {trip.interests && trip.interests.length > 0 && (
                                            <div style={{gridColumn: '1 / -1'}}><strong>Interests:</strong> {trip.interests.join(', ')}</div>
                                        )}
                                        {trip.specialRequests && (
                                            <div style={{gridColumn: '1 / -1'}}><strong>Special Requests:</strong> {trip.specialRequests}</div>
                                        )}
                                    </div>
                                    
                                    {/* Detailed Points Breakdown in Itinerary Builder */}
                                    {userPoints.totalPoints > 0 && (
                                        <div style={{marginTop: '16px', padding: '12px', background: '#f0f9ff', borderRadius: '6px', border: '1px solid #bae6fd'}}>
                                            <div style={{fontWeight: '600', marginBottom: '8px', color: '#0369a1', fontSize: '14px'}}>💳 Available Points & Miles:</div>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '6px', fontSize: '13px'}}>
                                                {Object.entries(userPoints.creditCardPoints || {}).map(([program, points]) => points > 0 && (
                                                    <div key={program} style={{color: '#7c3aed', fontWeight: '500'}}>💳 {program}: {points.toLocaleString()}</div>
                                                ))}
                                                {Object.entries(userPoints.hotelPoints || {}).map(([program, points]) => points > 0 && (
                                                    <div key={program} style={{color: '#dc2626', fontWeight: '500'}}>🏨 {program}: {points.toLocaleString()}</div>
                                                ))}
                                                {Object.entries(userPoints.airlinePoints || {}).map(([program, points]) => points > 0 && (
                                                    <div key={program} style={{color: '#2563eb', fontWeight: '500'}}>✈️ {program}: {points.toLocaleString()}</div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div style={{display: 'flex', gap: '12px'}}>
                                <button className="btn btn-secondary" onClick={onBack}>
                                    ← Back to Trips
                                </button>
                                <button 
                                    className="btn btn-success" 
                                    onClick={saveItinerary}
                                    disabled={saving}
                                >
                                    {saving ? 'Saving...' : '💾 Save Itinerary'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="section">
                        <div className="tabs">
                            <div 
                                className={`tab ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                📝 Overview
                            </div>
                            <div 
                                className={`tab ${activeTab === 'flights' ? 'active' : ''}`}
                                onClick={() => setActiveTab('flights')}
                            >
                                ✈️ Flights
                            </div>
                            <div 
                                className={`tab ${activeTab === 'transportation' ? 'active' : ''}`}
                                onClick={() => setActiveTab('transportation')}
                            >
                                🚆 Transportation
                            </div>
                            <div 
                                className={`tab ${activeTab === 'daily' ? 'active' : ''}`}
                                onClick={() => setActiveTab('daily')}
                            >
                                📅 Daily Plans
                            </div>
                            <div 
                                className={`tab ${activeTab === 'accommodations' ? 'active' : ''}`}
                                onClick={() => setActiveTab('accommodations')}
                            >
                                🏨 Accommodations
                            </div>
                            <div 
                                className={`tab ${activeTab === 'logistics' ? 'active' : ''}`}
                                onClick={() => setActiveTab('logistics')}
                            >
                                🗓️ Logistics View
                            </div>
                            <div 
                                className={`tab ${activeTab === 'timeline' ? 'active' : ''}`}
                                onClick={() => setActiveTab('timeline')}
                            >
                                📋 Activities View
                            </div>
                        </div>

                        {activeTab === 'overview' && (
                            <OverviewTab overview={overview} setOverview={setOverview} />
                        )}
                        
                        {activeTab === 'flights' && (
                            <FlightsTab flights={flights} setFlights={setFlights} />
                        )}
                        
                        {activeTab === 'transportation' && (
                            <TransportationTab transportation={transportation} setTransportation={setTransportation} />
                        )}
                        
                        {activeTab === 'daily' && (
                            <DailyPlansTab dailyPlans={dailyPlans} setDailyPlans={setDailyPlans} trip={trip} />
                        )}
                        
                        {activeTab === 'accommodations' && (
                            <AccommodationsTab accommodations={accommodations} setAccommodations={setAccommodations} />
                        )}
                        
                        {activeTab === 'logistics' && (
                            <LogisticsView flights={flights} transportation={transportation} accommodations={accommodations} />
                        )}
                        
                        {activeTab === 'timeline' && (
                            <TimelineView dailyPlans={dailyPlans} />
                        )}
                    </div>

                    {/* Auto-calculated Cost Summary */}
                    <CostSummary flights={flights} transportation={transportation} dailyPlans={dailyPlans} accommodations={accommodations} />
                </div>
            );
        }

        function OverviewTab({ overview, setOverview }) {
            return (
                <div>
                    <h3>Trip Overview</h3>
                    <p>Provide a general overview of the trip that will be displayed to the user.</p>
                    <div className="form-group">
                        <label className="form-label">Overview Description</label>
                        <textarea
                            className="form-textarea"
                            placeholder="Welcome to your personalized travel itinerary! This comprehensive guide includes..."
                            value={overview}
                            onChange={(e) => setOverview(e.target.value)}
                            style={{minHeight: '200px'}}
                        />
                    </div>
                </div>
            );
        }

        function FlightsTab({ flights, setFlights }) {
            const addFlight = () => {
                const newFlight = {
                    id: Date.now().toString(),
                    title: `Flight ${flights.length + 1}`,
                    segments: [],
                    bookingInstructions: ''
                };
                setFlights(prev => [...prev, newFlight]);
            };

            const removeFlight = (flightId) => {
                setFlights(prev => prev.filter(flight => flight.id !== flightId));
            };

            const updateFlight = (flightId, field, value) => {
                setFlights(prev => prev.map(flight => 
                    flight.id === flightId 
                        ? { ...flight, [field]: value }
                        : flight
                ));
            };

            const addSegmentToFlight = (flightId) => {
                const newSegment = {
                    id: Date.now().toString(),
                    flightNumber: '',
                    airline: '',
                    departure: { airport: '', airportCode: '', date: '', time: '' },
                    arrival: { airport: '', airportCode: '', date: '', time: '' },
                    duration: '',
                    cost: { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null }
                };
                setFlights(prev => prev.map(flight => 
                    flight.id === flightId 
                        ? { ...flight, segments: [...flight.segments, newSegment] }
                        : flight
                ));
            };

            const removeSegmentFromFlight = (flightId, segmentId) => {
                setFlights(prev => prev.map(flight => 
                    flight.id === flightId 
                        ? { ...flight, segments: flight.segments.filter(segment => segment.id !== segmentId) }
                        : flight
                ));
            };

            const updateFlightSegment = (flightId, segmentId, field, value) => {
                setFlights(prev => prev.map(flight => 
                    flight.id === flightId 
                        ? {
                            ...flight,
                            segments: flight.segments.map(segment => 
                                segment.id === segmentId 
                                    ? { ...segment, [field]: value }
                                    : segment
                            )
                        }
                        : flight
                ));
            };

            const updateFlightSegmentNested = (flightId, segmentId, category, field, value) => {
                setFlights(prev => prev.map(flight => 
                    flight.id === flightId 
                        ? {
                            ...flight,
                            segments: flight.segments.map(segment => 
                                segment.id === segmentId 
                                    ? { 
                                        ...segment, 
                                        [category]: {
                                            ...segment[category],
                                            [field]: value
                                        }
                                    }
                                    : segment
                            )
                        }
                        : flight
                ));
            };

            return (
                <div>
                    <h3>Flights</h3>
                    
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <p>Add flights (each flight can have multiple segments for connections)</p>
                        <button 
                            className="btn btn-primary"
                            onClick={addFlight}
                        >
                            ➕ Add Flight
                        </button>
                    </div>

                    {flights.map((flight, flightIndex) => (
                        <FlightForm 
                            key={flight.id}
                            flight={flight}
                            flightIndex={flightIndex}
                            onUpdateFlight={(field, value) => updateFlight(flight.id, field, value)}
                            onRemoveFlight={() => removeFlight(flight.id)}
                            onAddSegment={() => addSegmentToFlight(flight.id)}
                            onRemoveSegment={(segmentId) => removeSegmentFromFlight(flight.id, segmentId)}
                            onUpdateSegment={(segmentId, field, value) => updateFlightSegment(flight.id, segmentId, field, value)}
                            onUpdateSegmentNested={(segmentId, category, field, value) => updateFlightSegmentNested(flight.id, segmentId, category, field, value)}
                        />
                    ))}

                    {flights.length === 0 && (
                        <div style={{padding: '40px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px'}}>
                            No flights yet. Click "Add Flight" to get started.
                        </div>
                    )}
                </div>
            );
        }

        function FlightForm({ flight, flightIndex, onUpdateFlight, onRemoveFlight, onAddSegment, onRemoveSegment, onUpdateSegment, onUpdateSegmentNested }) {
            return (
                <div style={{background: '#ffffff', border: '2px solid #3b82f6', borderRadius: '12px', padding: '24px', marginBottom: '24px'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <div>
                            <input
                                type="text"
                                className="form-input"
                                style={{fontSize: '18px', fontWeight: 'bold', border: 'none', background: 'transparent', color: '#1e40af'}}
                                placeholder={`Flight ${flightIndex + 1}`}
                                value={flight.title}
                                onChange={(e) => onUpdateFlight('title', e.target.value)}
                            />
                        </div>
                        <button 
                            className="btn btn-danger"
                            onClick={onRemoveFlight}
                            style={{fontSize: '12px', padding: '6px 12px'}}
                        >
                            🗑️ Remove Flight
                        </button>
                    </div>

                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                        <h4 style={{margin: 0, color: '#374151'}}>Flight Segments</h4>
                        <button 
                            className="btn btn-secondary"
                            onClick={onAddSegment}
                            style={{fontSize: '14px', padding: '6px 12px'}}
                        >
                            ➕ Add Segment
                        </button>
                    </div>

                    {flight.segments.map((segment, segmentIndex) => (
                        <FlightSegmentForm 
                            key={segment.id}
                            segment={segment}
                            index={segmentIndex}
                            onUpdate={(field, value) => onUpdateSegment(segment.id, field, value)}
                            onUpdateNested={(category, field, value) => onUpdateSegmentNested(segment.id, category, field, value)}
                            onRemove={() => onRemoveSegment(segment.id)}
                        />
                    ))}

                    {flight.segments.length === 0 && (
                        <div style={{padding: '20px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px', border: '1px dashed #d1d5db'}}>
                            No segments yet. Click "Add Segment" to add flight details.
                        </div>
                    )}

                    <div className="form-group" style={{marginTop: '20px'}}>
                        <label className="form-label">Booking Instructions</label>
                        <textarea
                            className="form-textarea"
                            placeholder="How to book this flight..."
                            value={flight.bookingInstructions || ''}
                            onChange={(e) => onUpdateFlight('bookingInstructions', e.target.value)}
                        />
                    </div>
                </div>
            );
        }

        function FlightSegmentForm({ segment, index, onUpdate, onUpdateNested, onRemove }) {
            const [isLoadingFlightData, setIsLoadingFlightData] = React.useState(false);
            const [apiStatus, setApiStatus] = React.useState('');

            const autoFillFlightData = async () => {
                if (!segment.flightNumber || !segment.departure?.date) {
                    setApiStatus('Please enter flight number and departure date first');
                    return;
                }

                setIsLoadingFlightData(true);
                setApiStatus('Searching flight data...');

                try {
                    const flightData = await searchFlightByNumber(segment.flightNumber, segment.departure.date);
                    
                    if (flightData) {
                        // Auto-populate airline
                        if (flightData.airline && !segment.airline) {
                            onUpdate('airline', flightData.airline);
                        }
                        
                        // Auto-populate departure info
                        if (flightData.departure) {
                            if (flightData.departure.airport && !segment.departure.airport) {
                                onUpdateNested('departure', 'airport', flightData.departure.airport);
                            }
                            if (flightData.departure.airportCode && !segment.departure.airportCode) {
                                onUpdateNested('departure', 'airportCode', flightData.departure.airportCode);
                            }
                            if (flightData.departure.time && !segment.departure.time) {
                                onUpdateNested('departure', 'time', flightData.departure.time);
                            }
                        }
                        
                        // Auto-populate arrival info
                        if (flightData.arrival) {
                            if (flightData.arrival.airport && !segment.arrival.airport) {
                                onUpdateNested('arrival', 'airport', flightData.arrival.airport);
                            }
                            if (flightData.arrival.airportCode && !segment.arrival.airportCode) {
                                onUpdateNested('arrival', 'airportCode', flightData.arrival.airportCode);
                            }
                            if (flightData.arrival.time && !segment.arrival.time) {
                                onUpdateNested('arrival', 'time', flightData.arrival.time);
                            }
                            if (flightData.arrival.date && !segment.arrival.date) {
                                onUpdateNested('arrival', 'date', flightData.arrival.date);
                            }
                        }
                        
                        // Auto-populate duration
                        if (flightData.duration && !segment.duration) {
                            onUpdate('duration', flightData.duration);
                        }

                        setApiStatus('✅ Flight data populated successfully!');
                    } else {
                        setApiStatus('ℹ️ No flight data found - check console for details');
                    }
                } catch (error) {
                    console.error('Flight search error:', error);
                    setApiStatus('❌ Error searching flight data');
                } finally {
                    setIsLoadingFlightData(false);
                    setTimeout(() => setApiStatus(''), 3000);
                }
            };

            return (
                <div style={{background: '#f8fafc', padding: '16px', borderRadius: '8px', marginBottom: '12px', border: '1px solid #e2e8f0'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                        <h5 style={{margin: 0, color: '#6b7280'}}>Segment {index + 1}</h5>
                        <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                            <button 
                                className="btn btn-primary"
                                onClick={autoFillFlightData}
                                disabled={isLoadingFlightData}
                                style={{fontSize: '11px', padding: '4px 8px', backgroundColor: '#3b82f6'}}
                            >
                                {isLoadingFlightData ? '🔄' : '✈️'} Auto-Fill
                            </button>
                            <button 
                                className="btn btn-danger"
                                onClick={onRemove}
                                style={{fontSize: '11px', padding: '3px 6px'}}
                            >
                                Remove
                            </button>
                        </div>
                    </div>

                    {apiStatus && (
                        <div style={{
                            padding: '8px 12px',
                            marginBottom: '12px',
                            borderRadius: '4px',
                            fontSize: '12px',
                            backgroundColor: apiStatus.includes('✅') ? '#dcfce7' : 
                                            apiStatus.includes('❌') ? '#fef2f2' : '#fef3c7',
                            color: apiStatus.includes('✅') ? '#166534' : 
                                   apiStatus.includes('❌') ? '#dc2626' : '#d97706',
                            border: `1px solid ${apiStatus.includes('✅') ? '#bbf7d0' : 
                                                 apiStatus.includes('❌') ? '#fecaca' : '#fed7aa'}`
                        }}>
                            {apiStatus}
                        </div>
                    )}

                    <div className="form-grid">
                        <div className="form-group">
                            <label className="form-label">Flight Number</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="AA123 or AZ 629"
                                value={segment.flightNumber || ''}
                                onChange={(e) => onUpdate('flightNumber', e.target.value)}
                                style={{backgroundColor: segment.flightNumber ? '#f0f9ff' : 'white'}}
                            />
                            <small style={{color: '#6b7280', fontSize: '11px'}}>
                                Flight number (spaces OK: "AZ 629" → "AZ629")
                            </small>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Departure Date</label>
                            <input
                                type="date"
                                className="form-input"
                                value={segment.departure?.date || ''}
                                onChange={(e) => onUpdateNested('departure', 'date', e.target.value)}
                                style={{backgroundColor: segment.departure?.date ? '#f0fdf4' : 'white'}}
                            />
                            <small style={{color: '#6b7280', fontSize: '11px'}}>
                                Then click Auto-Fill button below
                            </small>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Airline</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="American Airlines"
                                value={segment.airline || ''}
                                onChange={(e) => onUpdate('airline', e.target.value)}
                                style={{backgroundColor: segment.airline ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Duration</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="5h 30m"
                                value={segment.duration || ''}
                                onChange={(e) => onUpdate('duration', e.target.value)}
                                style={{backgroundColor: segment.duration ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <FlexibleCostInput
                            label="Cost"
                            cost={segment.cost || { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null }}
                            onChange={(newCost) => onUpdate('cost', newCost)}
                        />
                    </div>

                    <h5>Departure</h5>
                    <div className="form-grid">
                        <div className="form-group">
                            <label className="form-label">Airport</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="John F. Kennedy International"
                                value={segment.departure?.airport || ''}
                                onChange={(e) => onUpdateNested('departure', 'airport', e.target.value)}
                                style={{backgroundColor: segment.departure?.airport ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Airport Code</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="JFK"
                                value={segment.departure?.airportCode || ''}
                                onChange={(e) => onUpdateNested('departure', 'airportCode', e.target.value)}
                                style={{backgroundColor: segment.departure?.airportCode ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Time (Local)</label>
                            <input
                                type="time"
                                className="form-input"
                                value={segment.departure?.time || ''}
                                onChange={(e) => onUpdateNested('departure', 'time', e.target.value)}
                                style={{backgroundColor: segment.departure?.time ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                    </div>

                    <h5>Arrival</h5>
                    <div className="form-grid">
                        <div className="form-group">
                            <label className="form-label">Airport</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="Tokyo Haneda Airport"
                                value={segment.arrival?.airport || ''}
                                onChange={(e) => onUpdateNested('arrival', 'airport', e.target.value)}
                                style={{backgroundColor: segment.arrival?.airport ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Airport Code</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="HND"
                                value={segment.arrival?.airportCode || ''}
                                onChange={(e) => onUpdateNested('arrival', 'airportCode', e.target.value)}
                                style={{backgroundColor: segment.arrival?.airportCode ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Date</label>
                            <input
                                type="date"
                                className="form-input"
                                value={segment.arrival?.date || ''}
                                onChange={(e) => onUpdateNested('arrival', 'date', e.target.value)}
                                style={{backgroundColor: segment.arrival?.date ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                        <div className="form-group">
                            <label className="form-label">Time (Local)</label>
                            <input
                                type="time"
                                className="form-input"
                                value={segment.arrival?.time || ''}
                                onChange={(e) => onUpdateNested('arrival', 'time', e.target.value)}
                                style={{backgroundColor: segment.arrival?.time ? '#f0fdf4' : 'white'}}
                            />
                        </div>
                    </div>
                </div>
            );
        }

        function DailyPlansTab({ dailyPlans, setDailyPlans, trip }) {
            const addDay = () => {
                const newDay = {
                    id: `day_${Date.now()}`,
                    dayNumber: dailyPlans.length + 1,
                    date: '',
                    title: `Day ${dailyPlans.length + 1}`,
                    activities: [],
                    meals: [],
                    transportation: [],
                    estimatedCost: 0,
                    notes: ''
                };
                setDailyPlans([...dailyPlans, newDay]);
            };

            const updateDay = (dayId, field, value) => {
                setDailyPlans(prev => prev.map(day => 
                    day.id === dayId ? { ...day, [field]: value } : day
                ));
            };

            const removeDay = (dayId) => {
                setDailyPlans(prev => prev.filter(day => day.id !== dayId));
            };

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h3>Daily Plans</h3>
                        <button className="btn btn-primary" onClick={addDay}>
                            + Add Day
                        </button>
                    </div>

                    {dailyPlans.map(day => (
                        <DayCard 
                            key={day.id}
                            day={day}
                            onUpdate={(field, value) => updateDay(day.id, field, value)}
                            onRemove={() => removeDay(day.id)}
                        />
                    ))}

                    {dailyPlans.length === 0 && (
                        <div style={{padding: '40px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px'}}>
                            No daily plans yet. Click "Add Day" to get started.
                        </div>
                    )}
                </div>
            );
        }

        function DayCard({ day, onUpdate, onRemove }) {
            const addActivity = () => {
                const newActivity = {
                    id: `activity_${Date.now()}`,
                    time: '',
                    duration: '',
                    title: '',
                    description: '',
                    location: { name: '', address: '', coordinates: null, nearbyLandmarks: '' },
                    cost: { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null },
                    bookingRequired: false,
                    bookingUrl: '',
                    bookingInstructions: '',
                    tips: [],
                    category: 'sightseeing'
                };
                onUpdate('activities', [...day.activities, newActivity]);
            };

            return (
                <div className="day-card">
                    <div className="day-header">
                        <div style={{flex: 1}}>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label className="form-label">Day Title</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Day 1: Arrival in Tokyo"
                                        value={day.title}
                                        onChange={(e) => onUpdate('title', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={day.date}
                                        onChange={(e) => onUpdate('date', e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>
                        <button className="btn btn-danger" onClick={onRemove} style={{marginLeft: '12px'}}>
                            Remove Day
                        </button>
                    </div>

                    <div style={{marginBottom: '16px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                            <h4>Activities</h4>
                            <button className="btn btn-primary" onClick={addActivity}>
                                + Add Activity
                            </button>
                        </div>
                        
                        {day.activities.map(activity => (
                            <div key={activity.id} className="activity-card">
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label className="form-label">Time</label>
                                        <input
                                            type="time"
                                            className="form-input"
                                            value={activity.time}
                                            onChange={(e) => {
                                                const updatedActivities = day.activities.map(a => 
                                                    a.id === activity.id ? { ...a, time: e.target.value } : a
                                                );
                                                onUpdate('activities', updatedActivities);
                                            }}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Activity Title</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Visit Senso-ji Temple"
                                            value={activity.title}
                                            onChange={(e) => {
                                                const updatedActivities = day.activities.map(a => 
                                                    a.id === activity.id ? { ...a, title: e.target.value } : a
                                                );
                                                onUpdate('activities', updatedActivities);
                                            }}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Duration</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="2 hours"
                                            value={activity.duration}
                                            onChange={(e) => {
                                                const updatedActivities = day.activities.map(a => 
                                                    a.id === activity.id ? { ...a, duration: e.target.value } : a
                                                );
                                                onUpdate('activities', updatedActivities);
                                            }}
                                        />
                                    </div>
                                    <FlexibleCostInput
                                        label="Cost"
                                        cost={activity.cost || { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null }}
                                        onChange={(newCost) => {
                                            const updatedActivities = day.activities.map(a => 
                                                a.id === activity.id ? { ...a, cost: newCost } : a
                                            );
                                            onUpdate('activities', updatedActivities);
                                        }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Description</label>
                                    <textarea
                                        className="form-textarea"
                                        placeholder="Explore Tokyo's oldest temple..."
                                        value={activity.description}
                                        onChange={(e) => {
                                            const updatedActivities = day.activities.map(a => 
                                                a.id === activity.id ? { ...a, description: e.target.value } : a
                                            );
                                            onUpdate('activities', updatedActivities);
                                        }}
                                        style={{minHeight: '80px'}}
                                    />
                                </div>
                                <button 
                                    className="btn btn-danger"
                                    onClick={() => {
                                        const updatedActivities = day.activities.filter(a => a.id !== activity.id);
                                        onUpdate('activities', updatedActivities);
                                    }}
                                >
                                    Remove Activity
                                </button>
                            </div>
                        ))}
                    </div>

                    <div className="form-group">
                        <label className="form-label">Day Notes</label>
                        <textarea
                            className="form-textarea"
                            placeholder="Additional notes for this day..."
                            value={day.notes || ''}
                            onChange={(e) => onUpdate('notes', e.target.value)}
                        />
                    </div>
                </div>
            );
        }

        function AccommodationsTab({ accommodations, setAccommodations }) {
            const [showHotelSearch, setShowHotelSearch] = useState(false);
            const [hotelSearchResults, setHotelSearchResults] = useState([]);
            const [isSearchingHotels, setIsSearchingHotels] = useState(false);
            const [hotelSearchParams, setHotelSearchParams] = useState({
                location: '',
                checkIn: '',
                checkOut: '',
                guests: 2
            });

            const addAccommodation = () => {
                const newAccommodation = {
                    id: `acc_${Date.now()}`,
                    name: '',
                    type: 'hotel',
                    checkIn: '',
                    checkOut: '',
                    nights: 1,
                    location: { name: '', address: '', coordinates: null, nearbyLandmarks: '' },
                    roomType: '',
                    amenities: [],
                    cost: { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null },
                    bookingUrl: '',
                    bookingInstructions: '',
                    cancellationPolicy: '',
                    contactInfo: { phone: '', email: '', website: '' }
                };
                setAccommodations([...accommodations, newAccommodation]);
            };

            const performHotelSearch = async () => {
                if (!hotelSearchParams.location || !hotelSearchParams.checkIn || !hotelSearchParams.checkOut) {
                    alert('Please fill in location, check-in, and check-out dates');
                    return;
                }

                setIsSearchingHotels(true);
                try {
                    const results = await searchHotels(
                        hotelSearchParams.location,
                        hotelSearchParams.checkIn,
                        hotelSearchParams.checkOut,
                        hotelSearchParams.guests
                    );
                    setHotelSearchResults(results);
                } catch (error) {
                    console.error('Hotel search failed:', error);
                    alert('Hotel search failed. Please try again.');
                } finally {
                    setIsSearchingHotels(false);
                }
            };

            const selectHotel = (hotel) => {
                const newAccommodation = convertHotelToAccommodation(
                    hotel, 
                    hotelSearchParams.checkIn, 
                    hotelSearchParams.checkOut
                );
                setAccommodations([...accommodations, newAccommodation]);
                setShowHotelSearch(false);
                setHotelSearchResults([]);
            };

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h3>Accommodations</h3>
                        <div style={{display: 'flex', gap: '10px'}}>
                            <button className="btn btn-secondary" onClick={() => setShowHotelSearch(true)}>
                                🏨 Search Hotels
                            </button>
                            <button className="btn btn-primary" onClick={addAccommodation}>
                                + Add Accommodation
                            </button>
                        </div>
                    </div>

                    {/* Hotel Search Modal */}
                    {showHotelSearch && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0,0,0,0.5)',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            zIndex: 1000
                        }}>
                            <div style={{
                                backgroundColor: 'white',
                                borderRadius: '12px',
                                padding: '30px',
                                width: '90%',
                                maxWidth: '800px',
                                maxHeight: '80vh',
                                overflow: 'auto',
                                boxShadow: '0 20px 40px rgba(0,0,0,0.3)'
                            }}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                    <h2 style={{margin: 0, color: '#2563eb'}}>🏨 Search Hotels</h2>
                                    <button
                                        onClick={() => setShowHotelSearch(false)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            fontSize: '24px',
                                            cursor: 'pointer',
                                            color: '#6b7280'
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>

                                {/* Search Form */}
                                <div className="form-grid" style={{marginBottom: '20px'}}>
                                    <div className="form-group">
                                        <label className="form-label">Location (City or Address)</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="New York, Paris, Tokyo..."
                                            value={hotelSearchParams.location}
                                            onChange={(e) => setHotelSearchParams({...hotelSearchParams, location: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Check-in Date</label>
                                        <input
                                            type="date"
                                            className="form-input"
                                            value={hotelSearchParams.checkIn}
                                            onChange={(e) => setHotelSearchParams({...hotelSearchParams, checkIn: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Check-out Date</label>
                                        <input
                                            type="date"
                                            className="form-input"
                                            value={hotelSearchParams.checkOut}
                                            onChange={(e) => setHotelSearchParams({...hotelSearchParams, checkOut: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Guests</label>
                                        <select
                                            className="form-select"
                                            value={hotelSearchParams.guests}
                                            onChange={(e) => setHotelSearchParams({...hotelSearchParams, guests: parseInt(e.target.value)})}
                                        >
                                            <option value={1}>1 Guest</option>
                                            <option value={2}>2 Guests</option>
                                            <option value={3}>3 Guests</option>
                                            <option value={4}>4 Guests</option>
                                            <option value={5}>5+ Guests</option>
                                        </select>
                                    </div>
                                </div>

                                <div style={{textAlign: 'center', marginBottom: '20px'}}>
                                    <button
                                        className="btn btn-primary"
                                        onClick={performHotelSearch}
                                        disabled={isSearchingHotels}
                                        style={{fontSize: '16px', padding: '12px 24px'}}
                                    >
                                        {isSearchingHotels ? '🔄 Searching...' : '🔍 Search Hotels'}
                                    </button>
                                </div>

                                {/* Search Results */}
                                {hotelSearchResults.length > 0 && (
                                    <div>
                                        <h3 style={{marginBottom: '15px', color: '#374151'}}>
                                            Found {hotelSearchResults.length} hotels
                                        </h3>
                                        <div style={{maxHeight: '400px', overflow: 'auto'}}>
                                            {hotelSearchResults.map((hotel, index) => (
                                                <div
                                                    key={hotel.id}
                                                    style={{
                                                        border: '1px solid #e5e7eb',
                                                        borderRadius: '8px',
                                                        padding: '15px',
                                                        marginBottom: '10px',
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s',
                                                        backgroundColor: '#f9fafb'
                                                    }}
                                                    onMouseOver={(e) => e.target.style.backgroundColor = '#f3f4f6'}
                                                    onMouseOut={(e) => e.target.style.backgroundColor = '#f9fafb'}
                                                    onClick={() => selectHotel(hotel)}
                                                >
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                                        <div style={{flex: 1}}>
                                                            <h4 style={{margin: '0 0 8px 0', color: '#1f2937', fontSize: '18px'}}>
                                                                {hotel.name}
                                                                {hotel.hotelChain && (
                                                                    <span style={{
                                                                        backgroundColor: '#2563eb',
                                                                        color: 'white',
                                                                        padding: '2px 6px',
                                                                        borderRadius: '4px',
                                                                        fontSize: '12px',
                                                                        marginLeft: '10px'
                                                                    }}>
                                                                        {hotel.hotelChain.toUpperCase()}
                                                                    </span>
                                                                )}
                                                            </h4>
                                                            <p style={{margin: '0 0 8px 0', color: '#6b7280', fontSize: '14px'}}>
                                                                📍 {hotel.address}
                                                            </p>
                                                            <div style={{display: 'flex', alignItems: 'center', gap: '15px', marginBottom: '8px'}}>
                                                                <span style={{color: '#f59e0b', fontWeight: 'bold'}}>
                                                                    ⭐ {hotel.rating.toFixed(1)} ({hotel.numReviews} reviews)
                                                                </span>
                                                                <span style={{color: '#059669', fontWeight: 'bold'}}>
                                                                    {hotel.priceLevel}
                                                                </span>
                                                            </div>
                                                            {hotel.amenities && hotel.amenities.length > 0 && (
                                                                <p style={{margin: '0 0 8px 0', color: '#6b7280', fontSize: '13px'}}>
                                                                    🎯 {hotel.amenities.slice(0, 3).join(', ')}
                                                                    {hotel.amenities.length > 3 && ` +${hotel.amenities.length - 3} more`}
                                                                </p>
                                                            )}
                                                            <p style={{margin: 0, color: '#059669', fontSize: '13px', fontStyle: 'italic'}}>
                                                                💡 {hotel.bookingInstructions}
                                                            </p>
                                                        </div>
                                                        <button
                                                            className="btn btn-primary"
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                selectHotel(hotel);
                                                            }}
                                                            style={{marginLeft: '15px', padding: '8px 16px'}}
                                                        >
                                                            Select Hotel
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {hotelSearchResults.length === 0 && !isSearchingHotels && hotelSearchParams.location && (
                                    <div style={{textAlign: 'center', padding: '20px', color: '#6b7280'}}>
                                        <p>No hotels found for your search criteria.</p>
                                        <p style={{fontSize: '14px'}}>Try adjusting your location or dates.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {accommodations.map(accommodation => (
                        <div key={accommodation.id} style={{background: '#f9fafb', padding: '16px', borderRadius: '8px', marginBottom: '16px'}}>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label className="form-label">Hotel Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Hotel New Otani Tokyo"
                                        value={accommodation.name}
                                        onChange={(e) => {
                                            const updated = accommodations.map(a => 
                                                a.id === accommodation.id ? { ...a, name: e.target.value } : a
                                            );
                                            setAccommodations(updated);
                                        }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Check-in Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={accommodation.checkIn}
                                        onChange={(e) => {
                                            const updated = accommodations.map(a => 
                                                a.id === accommodation.id ? { ...a, checkIn: e.target.value } : a
                                            );
                                            setAccommodations(updated);
                                        }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Check-out Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={accommodation.checkOut}
                                        onChange={(e) => {
                                            const updated = accommodations.map(a => 
                                                a.id === accommodation.id ? { ...a, checkOut: e.target.value } : a
                                            );
                                            setAccommodations(updated);
                                        }}
                                    />
                                </div>
                                <FlexibleCostInput
                                    label="Cost per Night"
                                    cost={accommodation.cost || { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null }}
                                    onChange={(newCost) => {
                                        const updated = accommodations.map(a => 
                                            a.id === accommodation.id ? { ...a, cost: newCost } : a
                                        );
                                        setAccommodations(updated);
                                    }}
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Booking Instructions</label>
                                <textarea
                                    className="form-textarea"
                                    placeholder="How to book this hotel..."
                                    value={accommodation.bookingInstructions}
                                    onChange={(e) => {
                                        const updated = accommodations.map(a => 
                                            a.id === accommodation.id ? { ...a, bookingInstructions: e.target.value } : a
                                        );
                                        setAccommodations(updated);
                                    }}
                                />
                            </div>
                            <button 
                                className="btn btn-danger"
                                onClick={() => {
                                    setAccommodations(accommodations.filter(a => a.id !== accommodation.id));
                                }}
                            >
                                Remove Accommodation
                            </button>
                        </div>
                    ))}

                    {accommodations.length === 0 && (
                        <div style={{padding: '40px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px'}}>
                            No accommodations yet. Click "Add Accommodation" to get started.
                        </div>
                    )}
                </div>
            );
        }

        // Auto-calculate costs from all components
        function calculateTotalCosts(flights, transportation, dailyPlans, accommodations) {
            let totalFlights = 0;
            let totalTransportation = 0;
            let totalAccommodations = 0;
            let totalActivities = 0;
            
            // Calculate flight costs from all flights and their segments
            flights?.forEach(flight => {
                flight.segments?.forEach(segment => {
                    if (segment.cost?.cashAmount) {
                        totalFlights += segment.cost.cashAmount;
                    }
                });
            });
            
            // Calculate transportation costs
            transportation?.forEach(transport => {
                if (transport.cost?.cashAmount) {
                    totalTransportation += transport.cost.cashAmount;
                }
            });
            
            // Calculate accommodation costs
            accommodations?.forEach(acc => {
                if (acc.cost?.cashAmount) {
                    totalAccommodations += acc.cost.cashAmount;
                }
            });
            
            // Calculate activity costs from daily plans
            dailyPlans?.forEach(day => {
                day.activities?.forEach(activity => {
                    if (activity.cost?.cashAmount) {
                        totalActivities += activity.cost.cashAmount;
                    }
                });
            });
            
            return {
                flights: totalFlights,
                transportation: totalTransportation,
                accommodations: totalAccommodations,
                activities: totalActivities,
                total: totalFlights + totalTransportation + totalAccommodations + totalActivities
            };
        }

        function CostSummary({ flights, transportation, dailyPlans, accommodations }) {
            const costs = calculateTotalCosts(flights, transportation, dailyPlans, accommodations);
            
            return (
                <div style={{
                    background: '#f0fdf4', 
                    border: '1px solid #bbf7d0', 
                    borderRadius: '8px', 
                    padding: '20px', 
                    margin: '20px 0'
                }}>
                    <h3 style={{color: '#166534', margin: '0 0 16px 0'}}>💰 Total Cost Summary</h3>
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '12px', marginBottom: '16px'}}>
                        <div style={{textAlign: 'center'}}>
                            <div style={{fontSize: '24px', fontWeight: 'bold', color: '#2563eb'}}>
                                ${costs.flights.toLocaleString()}
                            </div>
                            <div style={{fontSize: '14px', color: '#6b7280'}}>Flights</div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                            <div style={{fontSize: '24px', fontWeight: 'bold', color: '#059669'}}>
                                ${costs.transportation.toLocaleString()}
                            </div>
                            <div style={{fontSize: '14px', color: '#6b7280'}}>Transportation</div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                            <div style={{fontSize: '24px', fontWeight: 'bold', color: '#dc2626'}}>
                                ${costs.accommodations.toLocaleString()}
                            </div>
                            <div style={{fontSize: '14px', color: '#6b7280'}}>Accommodations</div>
                        </div>
                        <div style={{textAlign: 'center'}}>
                            <div style={{fontSize: '24px', fontWeight: 'bold', color: '#7c3aed'}}>
                                ${costs.activities.toLocaleString()}
                            </div>
                            <div style={{fontSize: '14px', color: '#6b7280'}}>Activities</div>
                        </div>
                    </div>
                    <div style={{
                        borderTop: '2px solid #16a34a', 
                        paddingTop: '16px', 
                        textAlign: 'center'
                    }}>
                        <div style={{fontSize: '32px', fontWeight: 'bold', color: '#166534'}}>
                            ${costs.total.toLocaleString()}
                        </div>
                        <div style={{fontSize: '16px', color: '#166534'}}>Total Estimated Cost</div>
                    </div>
                </div>
            );
        }

        // Transportation Tab Component
        function TransportationTab({ transportation, setTransportation }) {
            const addTransportation = () => {
                const newTransport = {
                    id: Date.now().toString(),
                    type: 'train',
                    title: '',
                    from: '',
                    to: '',
                    departureDate: '',
                    departureTime: '',
                    arrivalDate: '',
                    arrivalTime: '',
                    provider: '',
                    bookingReference: '',
                    cost: { paymentType: 'cash', cashAmount: 0, pointsAmount: null, pointsProgram: null, totalCashValue: 0, notes: null },
                    bookingInstructions: '',
                    notes: ''
                };
                setTransportation(prev => [...prev, newTransport]);
            };

            const removeTransportation = (transportId) => {
                setTransportation(prev => prev.filter(transport => transport.id !== transportId));
            };

            const updateTransportation = (transportId, field, value) => {
                setTransportation(prev => prev.map(transport => 
                    transport.id === transportId 
                        ? { ...transport, [field]: value }
                        : transport
                ));
            };

            const transportTypes = [
                { value: 'train', label: '🚆 Train', icon: '🚆' },
                { value: 'car_rental', label: '🚗 Car Rental', icon: '🚗' },
                { value: 'ferry', label: '⛴️ Ferry', icon: '⛴️' },
                { value: 'bus', label: '🚌 Bus', icon: '🚌' },
                { value: 'taxi', label: '🚕 Taxi/Rideshare', icon: '🚕' },
                { value: 'metro', label: '🚇 Metro/Subway', icon: '🚇' },
                { value: 'other', label: '🚛 Other', icon: '🚛' }
            ];

            return (
                <div>
                    <h3>Ground Transportation</h3>
                    
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <p>Add trains, car rentals, ferries, and other transportation</p>
                        <button 
                            className="btn btn-primary"
                            onClick={addTransportation}
                        >
                            ➕ Add Transportation
                        </button>
                    </div>

                    {transportation.map((transport, index) => (
                        <div key={transport.id} style={{background: '#ffffff', border: '2px solid #059669', borderRadius: '12px', padding: '20px', marginBottom: '20px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                                    <select
                                        className="form-select"
                                        value={transport.type}
                                        onChange={(e) => updateTransportation(transport.id, 'type', e.target.value)}
                                        style={{fontSize: '16px', fontWeight: '500'}}
                                    >
                                        {transportTypes.map(type => (
                                            <option key={type.value} value={type.value}>{type.label}</option>
                                        ))}
                                    </select>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Transportation title..."
                                        value={transport.title}
                                        onChange={(e) => updateTransportation(transport.id, 'title', e.target.value)}
                                        style={{fontSize: '16px', fontWeight: '500', border: 'none', background: 'transparent'}}
                                    />
                                </div>
                                <button 
                                    className="btn btn-danger"
                                    onClick={() => removeTransportation(transport.id)}
                                    style={{fontSize: '12px', padding: '6px 12px'}}
                                >
                                    🗑️ Remove
                                </button>
                            </div>

                            <div className="form-grid">
                                <div className="form-group">
                                    <label className="form-label">From</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Origin"
                                        value={transport.from}
                                        onChange={(e) => updateTransportation(transport.id, 'from', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">To</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Destination"
                                        value={transport.to}
                                        onChange={(e) => updateTransportation(transport.id, 'to', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Departure Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={transport.departureDate}
                                        onChange={(e) => updateTransportation(transport.id, 'departureDate', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Departure Time</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={transport.departureTime}
                                        onChange={(e) => updateTransportation(transport.id, 'departureTime', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Arrival Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={transport.arrivalDate}
                                        onChange={(e) => updateTransportation(transport.id, 'arrivalDate', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Arrival Time</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={transport.arrivalTime}
                                        onChange={(e) => updateTransportation(transport.id, 'arrivalTime', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Provider</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="e.g., Amtrak, Hertz, etc."
                                        value={transport.provider}
                                        onChange={(e) => updateTransportation(transport.id, 'provider', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Booking Reference</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Confirmation number"
                                        value={transport.bookingReference}
                                        onChange={(e) => updateTransportation(transport.id, 'bookingReference', e.target.value)}
                                    />
                                </div>
                            </div>

                            <FlexibleCostInput
                                label="Cost"
                                cost={transport.cost}
                                onChange={(newCost) => updateTransportation(transport.id, 'cost', newCost)}
                            />

                            <div className="form-group">
                                <label className="form-label">Booking Instructions</label>
                                <textarea
                                    className="form-textarea"
                                    placeholder="How to book or use this transportation..."
                                    value={transport.bookingInstructions}
                                    onChange={(e) => updateTransportation(transport.id, 'bookingInstructions', e.target.value)}
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Notes</label>
                                <textarea
                                    className="form-textarea"
                                    placeholder="Additional notes..."
                                    value={transport.notes}
                                    onChange={(e) => updateTransportation(transport.id, 'notes', e.target.value)}
                                />
                            </div>
                        </div>
                    ))}

                    {transportation.length === 0 && (
                        <div style={{padding: '40px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px'}}>
                            No transportation yet. Click "Add Transportation" to get started.
                        </div>
                    )}
                </div>
            );
        }

        // Logistics View Component
        function LogisticsView({ flights, transportation, accommodations }) {
            // Combine all logistics items and sort by date
            const logisticsItems = [];

            // Add flights
            flights?.forEach(flight => {
                flight.segments?.forEach((segment, segmentIndex) => {
                    if (segment.departure?.date) {
                        logisticsItems.push({
                            type: 'flight',
                            date: segment.departure.date,
                            time: segment.departure.time || '00:00',
                            title: `${flight.title} - Segment ${segmentIndex + 1}`,
                            details: `${segment.flightNumber || 'Flight'} from ${segment.departure?.airportCode || segment.departure?.airport} to ${segment.arrival?.airportCode || segment.arrival?.airport}`,
                            provider: segment.airline,
                            cost: segment.cost,
                            icon: '✈️'
                        });
                    }
                });
            });

            // Add transportation
            transportation?.forEach(transport => {
                if (transport.departureDate) {
                    const typeIcons = {
                        train: '🚆', car_rental: '🚗', ferry: '⛴️', bus: '🚌', 
                        taxi: '🚕', metro: '🚇', other: '🚛'
                    };
                    logisticsItems.push({
                        type: 'transport',
                        date: transport.departureDate,
                        time: transport.departureTime || '00:00',
                        title: transport.title || `${typeIcons[transport.type]} Transport`,
                        details: `${transport.from} to ${transport.to}`,
                        provider: transport.provider,
                        cost: transport.cost,
                        icon: typeIcons[transport.type] || '🚛'
                    });
                }
            });

            // Add accommodations
            accommodations?.forEach(acc => {
                if (acc.checkIn) {
                    logisticsItems.push({
                        type: 'accommodation',
                        date: acc.checkIn,
                        time: '15:00',
                        title: `Check-in: ${acc.name}`,
                        details: `${acc.roomType || 'Room'} - ${acc.nights || 1} nights`,
                        provider: acc.name,
                        cost: acc.cost,
                        icon: '🏨'
                    });
                }
                if (acc.checkOut) {
                    logisticsItems.push({
                        type: 'accommodation',
                        date: acc.checkOut,
                        time: '11:00',
                        title: `Check-out: ${acc.name}`,
                        details: `End of stay`,
                        provider: acc.name,
                        cost: null,
                        icon: '🧳'
                    });
                }
            });

            // Sort by date and time (timezone-safe)
            logisticsItems.sort((a, b) => {
                // Parse date components to avoid timezone issues
                const [yearA, monthA, dayA] = a.date.split('-').map(Number);
                const [yearB, monthB, dayB] = b.date.split('-').map(Number);
                
                // Compare dates first
                if (yearA !== yearB) return yearA - yearB;
                if (monthA !== monthB) return monthA - monthB;
                if (dayA !== dayB) return dayA - dayB;
                
                // If dates are equal, compare times
                const [hourA, minuteA] = (a.time || '00:00').split(':').map(Number);
                const [hourB, minuteB] = (b.time || '00:00').split(':').map(Number);
                
                if (hourA !== hourB) return hourA - hourB;
                return minuteA - minuteB;
            });

            return (
                <div>
                    <h3>📋 Logistics Timeline</h3>
                    <p>Chronological view of all transportation and accommodations</p>

                    {logisticsItems.length === 0 ? (
                        <div style={{padding: '40px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px'}}>
                            No logistics items yet. Add flights, transportation, or accommodations to see the timeline.
                        </div>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                            {logisticsItems.map((item, index) => (
                                <div key={index} style={{
                                    background: 'white',
                                    border: `2px solid ${item.type === 'flight' ? '#3b82f6' : item.type === 'transport' ? '#059669' : '#dc2626'}`,
                                    borderRadius: '8px',
                                    padding: '16px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '16px'
                                }}>
                                    <div style={{fontSize: '24px'}}>{item.icon}</div>
                                    <div style={{flex: 1}}>
                                        <div style={{fontWeight: 'bold', fontSize: '16px', marginBottom: '4px'}}>
                                            {item.title}
                                        </div>
                                        <div style={{color: '#666', fontSize: '14px', marginBottom: '4px'}}>
                                            {item.details}
                                        </div>
                                        {item.provider && (
                                            <div style={{color: '#888', fontSize: '12px'}}>
                                                Provider: {item.provider}
                                            </div>
                                        )}
                                    </div>
                                    <div style={{textAlign: 'right'}}>
                                        <div style={{fontWeight: 'bold', fontSize: '14px'}}>
                                            {DateUtils.formatDateString(item.date)}
                                        </div>
                                        <div style={{color: '#666', fontSize: '12px'}}>
                                            {item.time}
                                        </div>
                                        {item.cost && item.cost.cashAmount > 0 && (
                                            <div style={{color: '#059669', fontSize: '12px', fontWeight: 'bold'}}>
                                                ${item.cost.cashAmount.toLocaleString()}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Timeline View Component
        function TimelineView({ dailyPlans }) {
            const sortedDays = [...(dailyPlans || [])].sort((a, b) => {
                if (a.date && b.date) {
                    // Parse date components to avoid timezone issues
                    const [yearA, monthA, dayA] = a.date.split('-').map(Number);
                    const [yearB, monthB, dayB] = b.date.split('-').map(Number);
                    
                    if (yearA !== yearB) return yearA - yearB;
                    if (monthA !== monthB) return monthA - monthB;
                    return dayA - dayB;
                }
                return a.dayNumber - b.dayNumber;
            });

            return (
                <div>
                    <h3>📅 Daily Activities Timeline</h3>
                    <p>Chronological view of all daily activities and plans</p>

                    {sortedDays.length === 0 ? (
                        <div style={{padding: '40px', textAlign: 'center', color: '#666', background: '#f9fafb', borderRadius: '8px'}}>
                            No daily plans yet. Add daily plans to see the activity timeline.
                        </div>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '20px'}}>
                            {sortedDays.map((day, dayIndex) => (
                                <div key={day.id} style={{
                                    background: 'white',
                                    border: '2px solid #7c3aed',
                                    borderRadius: '12px',
                                    padding: '20px'
                                }}>
                                    <div style={{marginBottom: '16px'}}>
                                        <h4 style={{margin: '0 0 4px 0', color: '#7c3aed', fontSize: '18px'}}>
                                            Day {day.dayNumber}: {day.title}
                                        </h4>
                                        {day.date && (
                                            <div style={{color: '#666', fontSize: '14px'}}>
                                                {DateUtils.formatDateString(day.date)}
                                            </div>
                                        )}
                                    </div>

                                    {day.activities && day.activities.length > 0 ? (
                                        <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                                            {day.activities.map((activity, actIndex) => (
                                                <div key={actIndex} style={{
                                                    background: '#f8fafc',
                                                    borderRadius: '8px',
                                                    padding: '12px',
                                                    borderLeft: '4px solid #7c3aed'
                                                }}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px'}}>
                                                        <div>
                                                            <div style={{fontWeight: 'bold', fontSize: '14px', marginBottom: '4px'}}>
                                                                {activity.time && <span style={{color: '#666'}}>{activity.time} - </span>}
                                                                {activity.title}
                                                            </div>
                                                            {activity.description && (
                                                                <div style={{color: '#666', fontSize: '12px', marginBottom: '4px'}}>
                                                                    {activity.description}
                                                                </div>
                                                            )}
                                                            {activity.duration && (
                                                                <div style={{color: '#888', fontSize: '11px'}}>
                                                                    Duration: {activity.duration}
                                                                </div>
                                                            )}
                                                        </div>
                                                        {activity.cost && activity.cost.cashAmount > 0 && (
                                                            <div style={{color: '#059669', fontSize: '12px', fontWeight: 'bold'}}>
                                                                ${activity.cost.cashAmount.toLocaleString()}
                                                            </div>
                                                        )}
                                                    </div>
                                                    {activity.bookingRequired && (
                                                        <div style={{
                                                            background: '#fef3c7',
                                                            color: '#d97706',
                                                            padding: '4px 8px',
                                                            borderRadius: '4px',
                                                            fontSize: '11px',
                                                            fontWeight: '500'
                                                        }}>
                                                            ⚠️ Advance booking required
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div style={{
                                            padding: '20px',
                                            textAlign: 'center',
                                            color: '#666',
                                            background: '#f9fafb',
                                            borderRadius: '8px',
                                            fontStyle: 'italic'
                                        }}>
                                            No activities planned for this day
                                        </div>
                                    )}

                                    {day.estimatedCost > 0 && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '8px',
                                            background: '#ecfdf5',
                                            borderRadius: '4px',
                                            color: '#059669',
                                            fontWeight: 'bold',
                                            textAlign: 'right'
                                        }}>
                                            Day Total: ${day.estimatedCost.toLocaleString()}
                                        </div>
                                    )}

                                    {day.notes && (
                                        <div style={{
                                            marginTop: '12px',
                                            padding: '8px',
                                            background: '#eff6ff',
                                            borderRadius: '4px',
                                            fontSize: '12px',
                                            color: '#1e40af'
                                        }}>
                                            <strong>Notes:</strong> {day.notes}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>