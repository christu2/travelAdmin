<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destination-Based Travel Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            line-height: 1.6;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 600;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .section h2 {
            margin-top: 0;
            margin-bottom: 25px;
            color: #2d3748;
            font-size: 24px;
            font-weight: 600;
            border-bottom: 3px solid #e2e8f0;
            padding-bottom: 15px;
        }
        .trip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .trip-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .trip-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .trip-meta {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }
        .trip-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }
        .trip-destinations {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 12px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-submitted {
            background: #fef5e7;
            color: #d69e2e;
        }
        .status-pending {
            background: #e6fffa;
            color: #319795;
        }
        .status-completed {
            background: #f0fff4;
            color: #38a169;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .form-section h3 {
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-row.full-width {
            grid-template-columns: 1fr;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #edf2f7;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        .btn-danger:hover {
            background: #c53030;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .tab-nav {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab-nav button {
            padding: 15px 25px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #718096;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-nav button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-nav button:hover {
            color: #4a5568;
        }
        .destination-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .destination-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .destination-header h4 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }
        .accommodation-options {
            margin-bottom: 20px;
        }
        .accommodation-option {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .itinerary-day {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .transport-segment {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .priority-selector {
            display: inline-block;
            margin-left: 10px;
        }
        .priority-selector select {
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
        }
        .success-message {
            background: #f0fff4;
            color: #38a169;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #9ae6b4;
        }
        .error-message {
            background: #fed7d7;
            color: #e53e3e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #feb2b2;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        .array-input {
            margin-bottom: 10px;
        }
        .array-input input {
            margin-bottom: 5px;
        }
        .add-button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
        }
        .remove-button {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "{{FIREBASE_API_KEY}}",
            authDomain: "travel-consulting-app-1.firebaseapp.com",
            projectId: "travel-consulting-app-1",
            storageBucket: "travel-consulting-app-1.firebasestorage.app",
            messagingSenderId: "123591590128",
            appId: "1:123591590128:ios:ef15580e6e03d5e6160235"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Authentication Component
        const AuthenticationView = ({ onSignIn }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSignIn = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');

                try {
                    const result = await auth.signInWithEmailAndPassword(email, password);
                    console.log('User signed in:', result.user.uid);
                    onSignIn(result.user);
                } catch (error) {
                    console.error('Authentication error:', error);
                    setError(error.message);
                }
                setIsLoading(false);
            };

            return (
                <div style={{
                    minHeight: '100vh',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                }}>
                    <div style={{
                        background: 'white',
                        padding: '40px',
                        borderRadius: '12px',
                        boxShadow: '0 20px 40px rgba(0,0,0,0.1)',
                        width: '100%',
                        maxWidth: '400px'
                    }}>
                        <h2 style={{textAlign: 'center', marginBottom: '30px', color: '#2d3748'}}>
                            Admin Dashboard
                        </h2>
                        
                        {error && (
                            <div style={{
                                background: '#fed7d7',
                                color: '#e53e3e',
                                padding: '12px',
                                borderRadius: '6px',
                                marginBottom: '20px',
                                fontSize: '14px'
                            }}>
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSignIn}>
                            <div className="form-group">
                                <label>Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    style={{width: '100%', padding: '12px', border: '1px solid #e2e8f0', borderRadius: '6px'}}
                                />
                            </div>
                            <div className="form-group">
                                <label>Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    style={{width: '100%', padding: '12px', border: '1px solid #e2e8f0', borderRadius: '6px'}}
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={isLoading}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    background: '#667eea',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    fontSize: '16px',
                                    cursor: isLoading ? 'not-allowed' : 'pointer'
                                }}
                            >
                                {isLoading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // Utility functions
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const formatDate = (date) => {
            return new Date(date.seconds * 1000).toLocaleDateString();
        };

        const createEmptyDestination = (cityName = '') => ({
            id: generateId(),
            cityName,
            accommodationOptions: [createEmptyAccommodation()],
            dailyItinerary: [createEmptyDailyPlan()],
            localTransportation: [createEmptyLocalTransport()]
        });

        const createEmptyAccommodation = () => ({
            id: generateId(),
            priority: 1,
            hotel: {
                name: '',
                rating: 4,
                pricePerNight: createEmptyFlexibleCost(),
                totalNights: 1,
                totalCost: createEmptyFlexibleCost(),
                location: '',
                detailedDescription: '',
                amenities: [''],
                bookingUrl: '',
                tripadvisorId: ''
            }
        });

        const createEmptyDailyPlan = () => ({
            id: generateId(),
            dayNumber: 1,
            date: '',
            title: '',
            activities: [createEmptyActivity()],
            meals: [],
            transportation: [],
            estimatedCost: createEmptyFlexibleCost(),
            notes: null
        });

        const createEmptyActivity = () => ({
            id: generateId(),
            time: '',
            duration: '',
            title: '',
            description: '',
            location: {
                name: '',
                address: '',
                coordinates: null,
                nearbyLandmarks: null
            },
            cost: createEmptyFlexibleCost(),
            bookingRequired: false,
            bookingUrl: null,
            bookingInstructions: null,
            tips: [],
            category: 'sightseeing'
        });

        const createEmptyLocalTransport = () => ({
            id: generateId(),
            type: 'metro',
            name: '',
            costPerDay: 0,
            description: '',
            bookingInfo: ''
        });

        const createEmptyActivityRecommendation = () => ({
            id: generateId(),
            name: '',
            description: '',
            category: 'sightseeing',
            location: {
                name: '',
                address: '',
                coordinates: null,
                nearbyLandmarks: null
            },
            estimatedDuration: '',
            estimatedCost: createEmptyFlexibleCost(),
            bestTimeToVisit: '',
            bookingRequired: false,
            bookingUrl: null,
            bookingInstructions: null,
            tips: [],
            priority: 'medium'
        });

        const createEmptyRestaurantRecommendation = () => ({
            id: generateId(),
            name: '',
            cuisine: '',
            description: '',
            location: {
                name: '',
                address: '',
                coordinates: null,
                nearbyLandmarks: null
            },
            priceRange: '$$',
            mealType: 'dinner',
            estimatedCost: createEmptyFlexibleCost(),
            reservationRequired: false,
            reservationUrl: null,
            reservationInstructions: null,
            specialties: [],
            tips: [],
            priority: 'medium'
        });

        const createEmptyFlexibleCost = () => ({
            paymentType: 'cash',
            cashAmount: 0,
            pointsAmount: null,
            pointsProgram: null,
            totalCashValue: 0,
            notes: null
        });

        const createEmptyFlightSegment = (airport = '', airportCode = '', city = '') => ({
            airport: airport,
            airportCode: airportCode,
            city: city,
            date: '',
            time: '',
            terminal: null,
            gate: null
        });

        const createEmptyTransportSegment = () => ({
            id: generateId(),
            date: '',
            route: '', // "Madrid ‚Üí Rome" format expected by iOS
            transportOptions: [createEmptyTransportOption()], // renamed from options
            selectedOptionId: null,
            bookingGroups: []
        });

        const createEmptyTransportOption = () => ({
            id: generateId(),
            transportType: 'flight',
            details: createEmptyTransportDetails('flight'),
            cost: createEmptyFlexibleCost(),
            duration: '',
            bookingUrl: null,
            notes: null,
            isSelected: false,
            isBooked: false,
            bookingReference: null,
            bookedDate: null,
            priority: 1
        });

        const createEmptyTransportDetails = (type) => {
            // iOS expects TransportDetails enum structure with type and details
            switch (type) {
                case 'flight':
                    return {
                        type: 'flight',
                        details: {
                            flightNumber: '',
                            airline: '',
                            departure: createEmptyFlightSegment(),
                            arrival: createEmptyFlightSegment(),
                            duration: '',
                            aircraft: '',
                            cost: createEmptyFlexibleCost(),
                            bookingClass: 'economy',
                            bookingUrl: null,
                            seatRecommendations: null,
                            bookingInstructions: null,
                            notes: null,
                            isBooked: null,
                            bookingReference: null,
                            bookedDate: null,
                            seatNumbers: null
                        }
                    };
                case 'train':
                    return {
                        type: 'train',
                        details: {
                            trainNumber: '',
                            operatorName: '',
                            departure: createEmptyFlightSegment(),
                            arrival: createEmptyFlightSegment(),
                            duration: '',
                            trainType: '',
                            cost: createEmptyFlexibleCost(),
                            bookingClass: '',
                            bookingUrl: null,
                            bookingInstructions: null,
                            notes: null
                        }
                    };
                case 'bus':
                    return {
                        type: 'bus',
                        details: {
                            busNumber: null,
                            operatorName: '',
                            departure: createEmptyFlightSegment(),
                            arrival: createEmptyFlightSegment(),
                            duration: '',
                            busType: '',
                            cost: createEmptyFlexibleCost(),
                            bookingUrl: null,
                            bookingInstructions: null,
                            notes: null
                        }
                    };
                case 'ferry':
                    return {
                        type: 'ferry',
                        details: {
                            ferryNumber: null,
                            operatorName: '',
                            departure: createEmptyFlightSegment(),
                            arrival: createEmptyFlightSegment(),
                            duration: '',
                            ferryType: '',
                            cost: createEmptyFlexibleCost(),
                            vehicleSpace: null,
                            bookingUrl: null,
                            bookingInstructions: null,
                            notes: null
                        }
                    };
                case 'car':
                    return {
                        type: 'car',
                        details: {
                            company: '',
                            pickupLocation: '',
                            dropoffLocation: '',
                            pickupDate: '',
                            pickupTime: '',
                            dropoffDate: '',
                            dropoffTime: '',
                            carType: '',
                            cost: createEmptyFlexibleCost(),
                            bookingUrl: null,
                            bookingInstructions: null,
                            notes: null
                        }
                    };
                default:
                    return {
                        type: 'flight',
                        details: {
                            flightNumber: '',
                            airline: '',
                            departure: createEmptyFlightSegment(),
                            arrival: createEmptyFlightSegment(),
                            duration: '',
                            aircraft: '',
                            cost: createEmptyFlexibleCost(),
                            bookingClass: 'economy',
                            bookingUrl: null,
                            seatRecommendations: null,
                            bookingInstructions: null,
                            notes: null,
                            isBooked: null,
                            bookingReference: null,
                            bookedDate: null,
                            seatNumbers: null
                        }
                    };
            }
        };

        const createEmptyRecommendation = () => ({
            id: generateId(),
            tripOverview: '',
            destinations: [createEmptyDestination()],
            logistics: {
                transportSegments: [createEmptyTransportSegment()],
                bookingDeadlines: [],
                generalInstructions: ''
            },
            totalCost: {
                totalEstimate: 0,
                flights: 0,
                accommodation: 0,
                activities: 0,
                food: 0,
                localTransport: 0,
                miscellaneous: 0,
                currency: 'USD'
            },
            bestTimeToVisit: '',
            generalTips: [],
            createdAt: null
        });

        const createEmptyBookingGroup = () => ({
            id: generateId(),
            title: '',
            description: '',
            transportOptionIds: [],
            bookingUrl: null,
            totalCost: null,
            notes: null,
            isRoundTrip: false,
            bookingDeadline: null,
            isSelected: false,
            isBooked: false,
            bookingReference: null,
            bookedDate: null
        });

        // TripAdvisor Lookup Component
        const TripAdvisorLookup = ({ destIndex, accIndex, updateRecommendation, currentHotel }) => {
            const [tripadvisorId, setTripadvisorId] = useState(currentHotel.tripadvisorId || '');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const lookupHotelDetails = async () => {
                if (!tripadvisorId.trim()) {
                    setError('Please enter a TripAdvisor ID');
                    return;
                }

                setIsLoading(true);
                setError('');
                setSuccess('');

                try {
                    console.log(`Looking up TripAdvisor hotel details for ID: ${tripadvisorId}`);
                    
                    const response = await fetch(`http://localhost:3002/api/hotels/details/${tripadvisorId}`);
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('TripAdvisor API response:', data);
                    
                    if (data.success && data.hotel) {
                        const hotel = data.hotel;
                        
                        // Auto-fill hotel details
                        updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.tripadvisorId`, tripadvisorId);
                        updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.name`, hotel.name);
                        updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.location`, hotel.address);
                        updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.detailedDescription`, hotel.description);
                        
                        if (hotel.rating) {
                            updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.rating`, hotel.rating);
                        }
                        
                        if (hotel.amenities && hotel.amenities.length > 0) {
                            updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.amenities`, hotel.amenities);
                        }
                        
                        if (hotel.tripadvisorUrl) {
                            updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.bookingUrl`, hotel.tripadvisorUrl);
                        }
                        
                        setSuccess(`Hotel details loaded successfully! Found ${hotel.name} with ${hotel.numReviews} reviews.`);
                    } else {
                        setError(data.error || 'Hotel details not found');
                    }
                } catch (error) {
                    console.error('TripAdvisor lookup error:', error);
                    setError(`Failed to lookup hotel: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div>
                    <div className="form-row">
                        <div className="form-group">
                            <label>TripAdvisor Location ID</label>
                            <input
                                type="text"
                                value={tripadvisorId}
                                onChange={(e) => setTripadvisorId(e.target.value)}
                                placeholder="e.g., 60763 (from TripAdvisor URL)"
                                style={{flex: 1}}
                            />
                        </div>
                        <div className="form-group">
                            <label>Auto-Fill Hotel Info</label>
                            <button 
                                type="button"
                                className="btn btn-primary"
                                onClick={lookupHotelDetails}
                                disabled={isLoading}
                                style={{width: '100%', marginTop: '8px'}}
                            >
                                {isLoading ? 'üîç Looking up...' : 'üîç Get Hotel Details'}
                            </button>
                        </div>
                    </div>
                    
                    {error && (
                        <div style={{
                            background: '#fed7d7',
                            color: '#e53e3e',
                            padding: '10px',
                            borderRadius: '6px',
                            marginTop: '10px',
                            fontSize: '14px'
                        }}>
                            {error}
                        </div>
                    )}
                    
                    {success && (
                        <div style={{
                            background: '#f0fff4',
                            color: '#38a169',
                            padding: '10px',
                            borderRadius: '6px',
                            marginTop: '10px',
                            fontSize: '14px'
                        }}>
                            {success}
                        </div>
                    )}
                    
                    <div style={{fontSize: '12px', color: '#718096', marginTop: '10px'}}>
                        <strong>üí° How to find TripAdvisor ID:</strong>
                        <br />1. Go to the hotel's TripAdvisor page
                        <br />2. Look at the URL: https://www.tripadvisor.com/Hotel_Review-<strong>d60763</strong>-...
                        <br />3. Copy the number after the "d" (e.g., "60763")
                    </div>
                </div>
            );
        };

        // Main Dashboard Component
        const Dashboard = ({ currentUser, onSignOut }) => {
            const [trips, setTrips] = useState([]);
            const [selectedTrip, setSelectedTrip] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('overview');
            const [newRecommendation, setNewRecommendation] = useState(null);
            const [saveStatus, setSaveStatus] = useState('');
            const [isFullScreenMode, setIsFullScreenMode] = useState(false);

            useEffect(() => {
                // Verify admin access before loading trips
                if (currentUser && currentUser.email === 'nchristus93@gmail.com') {
                    loadTrips();
                } else {
                    setLoading(false);
                }
            }, [currentUser]);

            const loadTrips = async () => {
                try {
                    const snapshot = await db.collection('trips')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const tripsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    setTrips(tripsData);
                } catch (error) {
                    console.error('Error loading trips:', error);
                } finally {
                    setLoading(false);
                }
            };

            const selectTrip = (trip) => {
                setSelectedTrip(trip);
                setNewRecommendation(trip.destinationRecommendation || createEmptyRecommendation());
                setActiveTab('overview');
                setIsFullScreenMode(true);
            };

            const goBackToTripList = () => {
                setIsFullScreenMode(false);
                setSelectedTrip(null);
                setNewRecommendation(null);
            };

            const saveRecommendation = async () => {
                if (!selectedTrip || !newRecommendation) return;

                setSaveStatus('saving');
                try {
                    await db.collection('trips').doc(selectedTrip.id).update({
                        destinationRecommendation: newRecommendation,
                        status: 'completed',
                        updatedAt: firebase.firestore.Timestamp.now()
                    });
                    
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus(''), 3000);
                    await loadTrips();
                } catch (error) {
                    console.error('Error saving recommendation:', error);
                    setSaveStatus('error');
                    setTimeout(() => setSaveStatus(''), 3000);
                }
            };

            const updateRecommendation = (path, value) => {
                const pathParts = path.split('.');
                const newRec = { ...newRecommendation };
                let current = newRec;
                
                for (let i = 0; i < pathParts.length - 1; i++) {
                    const part = pathParts[i];
                    if (part.includes('[') && part.includes(']')) {
                        const [arrayName, indexStr] = part.split('[');
                        const index = parseInt(indexStr.replace(']', ''));
                        current = current[arrayName][index];
                    } else {
                        current = current[part];
                    }
                }
                
                const lastPart = pathParts[pathParts.length - 1];
                if (lastPart.includes('[') && lastPart.includes(']')) {
                    const [arrayName, indexStr] = lastPart.split('[');
                    const index = parseInt(indexStr.replace(']', ''));
                    current[arrayName][index] = value;
                } else {
                    current[lastPart] = value;
                }
                
                setNewRecommendation(newRec);
            };

            const addDestination = () => {
                const updated = { ...newRecommendation };
                updated.destinations.push(createEmptyDestination());
                setNewRecommendation(updated);
            };

            const removeDestination = (index) => {
                const updated = { ...newRecommendation };
                updated.destinations.splice(index, 1);
                setNewRecommendation(updated);
            };

            const addAccommodation = (destIndex) => {
                const updated = { ...newRecommendation };
                updated.destinations[destIndex].accommodationOptions.push(createEmptyAccommodation());
                setNewRecommendation(updated);
            };

            const removeAccommodation = (destIndex, accIndex) => {
                const updated = { ...newRecommendation };
                updated.destinations[destIndex].accommodationOptions.splice(accIndex, 1);
                setNewRecommendation(updated);
            };

            const addTransportSegment = () => {
                const updated = { ...newRecommendation };
                updated.logistics.transportSegments.push(createEmptyTransportSegment());
                setNewRecommendation(updated);
            };

            const removeTransportSegment = (index) => {
                const updated = { ...newRecommendation };
                updated.logistics.transportSegments.splice(index, 1);
                setNewRecommendation(updated);
            };

            const addTransportOption = (segmentIndex) => {
                const updated = { ...newRecommendation };
                updated.logistics.transportSegments[segmentIndex].transportOptions.push(createEmptyTransportOption());
                setNewRecommendation(updated);
            };

            const removeTransportOption = (segmentIndex, optionIndex) => {
                const updated = { ...newRecommendation };
                updated.logistics.transportSegments[segmentIndex].transportOptions.splice(optionIndex, 1);
                setNewRecommendation(updated);
            };

            const addBookingGroup = (segmentIndex) => {
                const updated = { ...newRecommendation };
                updated.logistics.transportSegments[segmentIndex].bookingGroups.push(createEmptyBookingGroup());
                setNewRecommendation(updated);
            };

            const removeBookingGroup = (segmentIndex, groupIndex) => {
                const updated = { ...newRecommendation };
                updated.logistics.transportSegments[segmentIndex].bookingGroups.splice(groupIndex, 1);
                setNewRecommendation(updated);
            };

            const addActivityToDay = (destIndex, dayIndex) => {
                const updated = { ...newRecommendation };
                if (!updated.destinations[destIndex].dailyItinerary[dayIndex].activities) {
                    updated.destinations[destIndex].dailyItinerary[dayIndex].activities = [];
                }
                updated.destinations[destIndex].dailyItinerary[dayIndex].activities.push({
                    time: '',
                    duration: '',
                    title: '',
                    description: '',
                    location: {
                        name: '',
                        address: ''
                    },
                    category: 'sightseeing',
                    cost: {
                        paymentType: 'cash',
                        cashAmount: 0,
                        pointsAmount: 0,
                        pointsType: ''
                    }
                });
                setNewRecommendation(updated);
            };

            const removeActivityFromDay = (destIndex, dayIndex, activityIndex) => {
                const updated = { ...newRecommendation };
                if (updated.destinations[destIndex].dailyItinerary[dayIndex].activities) {
                    updated.destinations[destIndex].dailyItinerary[dayIndex].activities.splice(activityIndex, 1);
                }
                setNewRecommendation(updated);
            };

            const addActivity = (destIndex, dayIndex) => {
                // This function is an alias for addActivityToDay for backward compatibility
                addActivityToDay(destIndex, dayIndex);
            };

            const removeActivity = (destIndex, dayIndex) => {
                // This function removes an entire day (as seen in the button label "Remove Day")
                const updated = { ...newRecommendation };
                updated.destinations[destIndex].dailyItinerary.splice(dayIndex, 1);
                setNewRecommendation(updated);
            };

            if (loading) {
                return <div className="loading">Loading trips...</div>;
            }

            // Check if user is admin
            if (!currentUser || currentUser.email !== 'nchristus93@gmail.com') {
                return (
                    <div className="container">
                        <div className="header" style={{textAlign: 'center'}}>
                            <h1>Access Denied</h1>
                            <p>You do not have permission to access this admin dashboard.</p>
                            <button 
                                className="btn btn-secondary" 
                                onClick={onSignOut}
                                style={{marginTop: '20px'}}
                            >
                                Sign Out
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1>Destination-Based Travel Admin Dashboard</h1>
                                <p>Manage multi-city trips with destination-centric recommendations</p>
                            </div>
                            <div style={{textAlign: 'right', color: 'white'}}>
                                <div style={{marginBottom: '8px', opacity: 0.9}}>
                                    Signed in as: {currentUser.email}
                                </div>
                                <button 
                                    className="btn btn-secondary" 
                                    onClick={onSignOut}
                                    style={{background: 'rgba(255,255,255,0.2)', border: '1px solid rgba(255,255,255,0.3)'}}
                                >
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>

                    {!isFullScreenMode ? (
                        <div className="section">
                            <h2>Trip Requests</h2>
                            <div className="trip-grid">
                                {trips.map(trip => (
                                    <div 
                                        key={trip.id} 
                                        className="trip-card"
                                        onClick={() => selectTrip(trip)}
                                    >
                                        <div className="trip-meta">
                                            {formatDate(trip.createdAt)} ‚Ä¢ ID: {trip.id.substring(0, 8)}
                                        </div>
                                        <div className="trip-title">
                                            {trip.destinations ? trip.destinations.join(' ‚Üí ') : trip.destination}
                                        </div>
                                        <div className="trip-destinations">
                                            {trip.startDate && formatDate(trip.startDate)} - {trip.endDate && formatDate(trip.endDate)}
                                        </div>
                                        <span className={`status-badge status-${trip.status}`}>
                                            {trip.status}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        selectedTrip && newRecommendation && (
                            <div className="section">
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                    <div style={{display: 'flex', alignItems: 'center'}}>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={goBackToTripList}
                                            style={{marginRight: '20px'}}
                                        >
                                            ‚Üê Back to Trips
                                        </button>
                                        <h2 style={{margin: 0}}>Create Destination-Based Recommendation</h2>
                                    </div>
                                    <div>
                                        {saveStatus === 'saving' && <span style={{marginRight: '10px', color: '#718096'}}>Saving...</span>}
                                        {saveStatus === 'saved' && <span style={{marginRight: '10px', color: '#38a169'}}>Saved!</span>}
                                        {saveStatus === 'error' && <span style={{marginRight: '10px', color: '#e53e3e'}}>Error saving</span>}
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={saveRecommendation}
                                            disabled={saveStatus === 'saving'}
                                        >
                                            Save Recommendation
                                        </button>
                                    </div>
                                </div>

                                <div className="tab-nav">
                                    <button 
                                        className={activeTab === 'overview' ? 'active' : ''}
                                        onClick={() => setActiveTab('overview')}
                                    >
                                        Overview
                                    </button>
                                    <button 
                                        className={activeTab === 'destinations' ? 'active' : ''}
                                        onClick={() => setActiveTab('destinations')}
                                    >
                                        Destinations
                                    </button>
                                    <button 
                                        className={activeTab === 'activities' ? 'active' : ''}
                                        onClick={() => setActiveTab('activities')}
                                    >
                                        Activities
                                    </button>
                                    <button 
                                        className={activeTab === 'logistics' ? 'active' : ''}
                                        onClick={() => setActiveTab('logistics')}
                                    >
                                        Logistics
                                    </button>
                                    <button 
                                        className={activeTab === 'costs' ? 'active' : ''}
                                        onClick={() => setActiveTab('costs')}
                                    >
                                        Costs
                                    </button>
                                </div>

                                {activeTab === 'overview' && (
                                    <OverviewTab 
                                        recommendation={newRecommendation}
                                        updateRecommendation={updateRecommendation}
                                    />
                                )}

                                {activeTab === 'destinations' && (
                                    <DestinationsTab 
                                        recommendation={newRecommendation}
                                        updateRecommendation={updateRecommendation}
                                        addDestination={addDestination}
                                        removeDestination={removeDestination}
                                        addAccommodation={addAccommodation}
                                        removeAccommodation={removeAccommodation}
                                    />
                                )}

                                {activeTab === 'activities' && (
                                    <ActivitiesTab 
                                        recommendation={newRecommendation}
                                        updateRecommendation={updateRecommendation}
                                        addActivity={addActivity}
                                        removeActivity={removeActivity}
                                    />
                                )}

                                {activeTab === 'logistics' && (
                                    <LogisticsTab 
                                        recommendation={newRecommendation}
                                        updateRecommendation={updateRecommendation}
                                        addTransportSegment={addTransportSegment}
                                        removeTransportSegment={removeTransportSegment}
                                        addTransportOption={addTransportOption}
                                        removeTransportOption={removeTransportOption}
                                    />
                                )}

                                {activeTab === 'costs' && (
                                    <CostsTab 
                                        recommendation={newRecommendation}
                                        updateRecommendation={updateRecommendation}
                                    />
                                )}
                            </div>
                        )
                    )}
                </div>
            );
        };

        // Overview Tab Component
        const OverviewTab = ({ recommendation, updateRecommendation }) => (
            <div className="form-section">
                <div className="form-group">
                    <label>Trip Overview</label>
                    <textarea
                        value={recommendation.tripOverview}
                        onChange={(e) => updateRecommendation('tripOverview', e.target.value)}
                        placeholder="Provide a comprehensive overview of this multi-city trip..."
                        rows="6"
                    />
                </div>
            </div>
        );

        // Destinations Tab Component
        const DestinationsTab = ({ 
            recommendation, 
            updateRecommendation, 
            addDestination, 
            removeDestination,
            addAccommodation,
            removeAccommodation 
        }) => (
            <div>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                    <h3>Destinations ({recommendation.destinations.length})</h3>
                    <button className="btn btn-secondary" onClick={addDestination}>
                        Add Destination
                    </button>
                </div>

                {recommendation.destinations.map((destination, destIndex) => (
                    <div key={destination.id} className="destination-card">
                        <div className="destination-header">
                            <h4>Destination {destIndex + 1}</h4>
                            {recommendation.destinations.length > 1 && (
                                <button 
                                    className="btn btn-danger"
                                    onClick={() => removeDestination(destIndex)}
                                >
                                    Remove
                                </button>
                            )}
                        </div>

                        <div className="form-group">
                            <label>City Name</label>
                            <input
                                type="text"
                                value={destination.cityName}
                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].cityName`, e.target.value)}
                                placeholder="e.g., Madrid, Barcelona, Rome"
                            />
                        </div>

                        <div className="accommodation-options">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                <h5>Hotel Options ({destination.accommodationOptions.length})</h5>
                                <button 
                                    className="add-button"
                                    onClick={() => addAccommodation(destIndex)}
                                >
                                    Add Hotel Option
                                </button>
                            </div>

                            {destination.accommodationOptions.map((option, accIndex) => (
                                <div key={option.id} className="accommodation-option">
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                                        <h6>Hotel Option {accIndex + 1}</h6>
                                        <div style={{display: 'flex', alignItems: 'center'}}>
                                            <div className="priority-selector">
                                                <label style={{marginRight: '5px', fontSize: '12px'}}>Priority:</label>
                                                <select
                                                    value={option.priority}
                                                    onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].priority`, parseInt(e.target.value))}
                                                >
                                                    <option value={1}>1 (Highest)</option>
                                                    <option value={2}>2</option>
                                                    <option value={3}>3</option>
                                                </select>
                                            </div>
                                            {destination.accommodationOptions.length > 1 && (
                                                <button 
                                                    className="remove-button"
                                                    onClick={() => removeAccommodation(destIndex, accIndex)}
                                                >
                                                    Remove
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* TripAdvisor ID Lookup Section */}
                                    <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '8px', marginBottom: '20px'}}>
                                        <h6 style={{margin: '0 0 15px 0', color: '#2d3748'}}>üîç TripAdvisor Auto-Fill</h6>
                                        <TripAdvisorLookup 
                                            destIndex={destIndex}
                                            accIndex={accIndex}
                                            updateRecommendation={updateRecommendation}
                                            currentHotel={option.hotel}
                                        />
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>
                                                Hotel Name
                                                {option.hotel.tripadvisorId && (
                                                    <span style={{
                                                        fontSize: '11px', 
                                                        color: '#38a169', 
                                                        marginLeft: '8px',
                                                        background: '#f0fff4',
                                                        padding: '2px 6px',
                                                        borderRadius: '4px'
                                                    }}>
                                                        ‚úÖ From TripAdvisor
                                                    </span>
                                                )}
                                            </label>
                                            <input
                                                type="text"
                                                value={option.hotel.name}
                                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.name`, e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Rating</label>
                                            <select
                                                value={option.hotel.rating}
                                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.rating`, parseFloat(e.target.value))}
                                            >
                                                <option value={3}>3 Stars</option>
                                                <option value={3.5}>3.5 Stars</option>
                                                <option value={4}>4 Stars</option>
                                                <option value={4.5}>4.5 Stars</option>
                                                <option value={5}>5 Stars</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Price per Night ($)</label>
                                            <input
                                                type="number"
                                                value={option.hotel.pricePerNight}
                                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.pricePerNight`, parseFloat(e.target.value))}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Total Nights</label>
                                            <input
                                                type="number"
                                                value={option.hotel.totalNights}
                                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.totalNights`, parseInt(e.target.value))}
                                            />
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Location</label>
                                            <input
                                                type="text"
                                                value={option.hotel.location}
                                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.location`, e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Booking URL</label>
                                            <input
                                                type="url"
                                                value={option.hotel.bookingUrl}
                                                onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.bookingUrl`, e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    <div className="form-group">
                                        <label>Description</label>
                                        <textarea
                                            value={option.hotel.detailedDescription}
                                            onChange={(e) => updateRecommendation(`destinations[${destIndex}].accommodationOptions[${accIndex}].hotel.detailedDescription`, e.target.value)}
                                            rows="3"
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
        );

        // Logistics Tab Component
        const LogisticsTab = ({ 
            recommendation, 
            updateRecommendation,
            addTransportSegment,
            removeTransportSegment,
            addTransportOption,
            removeTransportOption
        }) => (
            <div>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                    <h3>Inter-City Transportation ({recommendation.logistics.transportSegments.length})</h3>
                    <button className="btn btn-secondary" onClick={addTransportSegment}>
                        Add Transport Segment
                    </button>
                </div>

                {recommendation.logistics.transportSegments.map((segment, segmentIndex) => (
                    <div key={segment.id} className="transport-segment">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                            <h4>Transport Segment {segmentIndex + 1}</h4>
                            {recommendation.logistics.transportSegments.length > 1 && (
                                <button 
                                    className="btn btn-danger"
                                    onClick={() => removeTransportSegment(segmentIndex)}
                                >
                                    Remove Segment
                                </button>
                            )}
                        </div>

                        <div style={{marginTop: '20px'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                <h5>Transport Options ({segment.transportOptions.length})</h5>
                                <button 
                                    className="add-button"
                                    onClick={() => addTransportOption(segmentIndex)}
                                >
                                    Add Option
                                </button>
                            </div>

                            {segment.transportOptions.map((option, optionIndex) => (
                                <div key={option.id} style={{border: '1px solid #e2e8f0', borderRadius: '6px', padding: '15px', marginBottom: '10px', background: '#f9f9f9'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                                        <h6>Option {optionIndex + 1}</h6>
                                        <div style={{display: 'flex', alignItems: 'center'}}>
                                            <div className="priority-selector">
                                                <label style={{marginRight: '5px', fontSize: '12px'}}>Priority:</label>
                                                <select
                                                    value={option.priority}
                                                    onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].transportOptions[${optionIndex}].priority`, parseInt(e.target.value))}
                                                >
                                                    <option value={1}>1 (Highest)</option>
                                                    <option value={2}>2</option>
                                                    <option value={3}>3</option>
                                                </select>
                                            </div>
                                            {segment.transportOptions.length > 1 && (
                                                <button 
                                                    className="remove-button"
                                                    onClick={() => removeTransportOption(segmentIndex, optionIndex)}
                                                >
                                                    Remove
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    <TransportOptionForm 
                                        option={option}
                                        basePath={`logistics.transportSegments[${segmentIndex}].transportOptions[${optionIndex}]`}
                                        updateRecommendation={updateRecommendation}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                ))}

            </div>
        );

        // Transport Option Form Component
        const TransportOptionForm = ({ option, basePath, updateRecommendation }) => {
            const transportType = option.transportType || 'flight';
            const [flightSearchResults, setFlightSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [searchError, setSearchError] = useState('');
            
            // Helper function to format duration from minutes to "Xh Ym" format
            const formatDuration = (durationInMinutes) => {
                if (!durationInMinutes || isNaN(durationInMinutes)) return '';
                
                const minutes = parseInt(durationInMinutes);
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                
                if (hours > 0 && remainingMinutes > 0) {
                    return `${hours}h ${remainingMinutes}m`;
                } else if (hours > 0) {
                    return `${hours}h`;
                } else {
                    return `${remainingMinutes}m`;
                }
            };

            // Flight search function using SerpAPI
            const searchFlights = async () => {
                const departureCode = option.details.details?.departure?.airportCode || '';
                const arrivalCode = option.details.details?.arrival?.airportCode || '';
                const searchDate = option.details.details?.departure?.date || '';
                
                if (!departureCode || !arrivalCode || !searchDate) {
                    setSearchError('Please enter departure airport, arrival airport, and date first');
                    return;
                }
                
                setIsSearching(true);
                setSearchError('');
                setFlightSearchResults([]);
                
                try {
                    console.log(`Searching flights: ${departureCode} ‚Üí ${arrivalCode} on ${searchDate}`);
                    
                    // Use local proxy server to avoid CORS issues
                    const apiUrl = `http://localhost:3003/api/flights/search?departure_id=${departureCode}&arrival_id=${arrivalCode}&outbound_date=${searchDate}&currency=USD&hl=en`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`SerpAPI error: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('SerpAPI response:', data);
                    console.log('First flight booking data:', data.best_flights?.[0] || data.other_flights?.[0]);
                    
                    if (data.best_flights || data.other_flights) {
                        const allFlights = [...(data.best_flights || []), ...(data.other_flights || [])];
                        
                        const processedFlights = allFlights.slice(0, 10).map((flight, index) => {
                            const firstSegment = flight.flights[0];
                            const lastSegment = flight.flights[flight.flights.length - 1];
                            
                            // Build route description with layovers
                            const routeParts = flight.flights.map(segment => segment.departure_airport.id);
                            routeParts.push(lastSegment.arrival_airport.id);
                            const routeDescription = routeParts.join(' ‚Üí ');
                            
                            // Get layover airports and duration details
                            const layoverAirports = flight.flights.slice(0, -1).map(s => s.arrival_airport.id);
                            
                            // Check for overnight indicators and date changes
                            const departureDate = new Date(firstSegment.departure_airport.time);
                            const arrivalDate = new Date(lastSegment.arrival_airport.time);
                            const hasDateChange = departureDate.toDateString() !== arrivalDate.toDateString();
                            
                            // Check for overnight layovers (layovers > 6 hours)
                            let hasOvernightLayover = false;
                            if (flight.flights.length > 1) {
                                for (let i = 0; i < flight.flights.length - 1; i++) {
                                    const currentArrival = new Date(flight.flights[i].arrival_airport.time);
                                    const nextDeparture = new Date(flight.flights[i + 1].departure_airport.time);
                                    const layoverHours = (nextDeparture - currentArrival) / (1000 * 60 * 60);
                                    if (layoverHours >= 6) {
                                        hasOvernightLayover = true;
                                        break;
                                    }
                                }
                            }
                            
                            // Check if it's a red-eye flight (departure between 9 PM - 6 AM)
                            const depHour = departureDate.getHours();
                            const isRedEye = depHour >= 21 || depHour <= 6;
                            
                            const segments = flight.flights.map((segment, segIndex) => {
                                const segDepDate = new Date(segment.departure_airport.time);
                                const segArrDate = new Date(segment.arrival_airport.time);
                                const segHasDateChange = segDepDate.toDateString() !== segArrDate.toDateString();
                                
                                return {
                                    from: segment.departure_airport.id,
                                    fromName: segment.departure_airport.name,
                                    to: segment.arrival_airport.id,
                                    toName: segment.arrival_airport.name,
                                    airline: segment.airline,
                                    flightNumber: segment.flight_number,
                                    duration: formatDuration(segment.duration),
                                    aircraft: segment.airplane || 'N/A',
                                    departureDate: segDepDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                                    arrivalDate: segArrDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                                    hasDateChange: segHasDateChange
                                };
                            });
                            
                            return {
                                id: `serpapi-${index}`,
                                // Primary airline (usually first segment)
                                airline: firstSegment.airline,
                                flightNumber: flight.flights.length > 1 ? 
                                    flight.flights.map(seg => seg.flight_number).join(', ') : 
                                    firstSegment.flight_number,
                                // Full journey endpoints
                                departure: {
                                    airport: firstSegment.departure_airport.id,
                                    airportName: firstSegment.departure_airport.name,
                                    time: firstSegment.departure_airport.time,
                                    localTime: new Date(firstSegment.departure_airport.time).toLocaleTimeString('en-US', {
                                        hour12: false,
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    }),
                                    date: departureDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                                },
                                arrival: {
                                    airport: lastSegment.arrival_airport.id,
                                    airportName: lastSegment.arrival_airport.name,
                                    time: lastSegment.arrival_airport.time,
                                    localTime: new Date(lastSegment.arrival_airport.time).toLocaleTimeString('en-US', {
                                        hour12: false,
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    }),
                                    date: arrivalDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                                },
                                // Enhanced connection details
                                route: routeDescription,
                                totalDuration: formatDuration(flight.total_duration),
                                segments: segments,
                                layovers: flight.flights.length - 1,
                                layoverAirports: layoverAirports,
                                aircraft: segments.map(s => s.aircraft).join(', '),
                                price: flight.price,
                                carbonEmissions: flight.carbon_emissions?.this_flight || 0,
                                travelClass: flight.travel_class || 'Economy',
                                // Booking information
                                bookingToken: flight.booking_token,
                                bookingUrl: flight.booking?.url || flight.booking_url,
                                // Overnight indicators
                                hasDateChange: hasDateChange,
                                hasOvernightLayover: hasOvernightLayover,
                                isRedEye: isRedEye
                            };
                        });
                        
                        setFlightSearchResults(processedFlights);
                        console.log(`Found ${processedFlights.length} flights`);
                    } else {
                        setSearchError('No flights found for this route and date');
                    }
                } catch (error) {
                    console.error('Flight search error:', error);
                    setSearchError(`Search failed: ${error.message}`);
                } finally {
                    setIsSearching(false);
                }
            };
            
            // Apply selected flight data to form
            const selectFlight = (flight) => {
                updateRecommendation(`${basePath}.details.details.flightNumber`, flight.flightNumber);
                updateRecommendation(`${basePath}.details.details.airline`, flight.airline);
                updateRecommendation(`${basePath}.details.details.departure.airportCode`, flight.departure.airport);
                updateRecommendation(`${basePath}.details.details.arrival.airportCode`, flight.arrival.airport);
                updateRecommendation(`${basePath}.details.details.departure.airport`, flight.departure.airportName);
                updateRecommendation(`${basePath}.details.details.arrival.airport`, flight.arrival.airportName);
                updateRecommendation(`${basePath}.details.details.departure.time`, flight.departure.localTime);
                updateRecommendation(`${basePath}.details.details.arrival.time`, flight.arrival.localTime);
                updateRecommendation(`${basePath}.details.details.departure.date`, flight.departure.date);
                updateRecommendation(`${basePath}.details.details.arrival.date`, flight.arrival.date);
                updateRecommendation(`${basePath}.duration`, flight.totalDuration || flight.duration);
                updateRecommendation(`${basePath}.cost.cashAmount`, flight.price);
                updateRecommendation(`${basePath}.cost.totalCashValue`, flight.price);
                updateRecommendation(`${basePath}.details.details.aircraft`, flight.aircraft);
                
                // Store booking information
                if (flight.bookingUrl) {
                    updateRecommendation(`${basePath}.bookingUrl`, flight.bookingUrl);
                }
                
                // Store enhanced connection data
                if (flight.route) {
                    updateRecommendation(`${basePath}.details.details.route`, flight.route);
                }
                if (flight.segments) {
                    updateRecommendation(`${basePath}.details.segments`, flight.segments);
                }
                if (flight.layoverAirports && flight.layoverAirports.length > 0) {
                    updateRecommendation(`${basePath}.details.layoverAirports`, flight.layoverAirports);
                }
                updateRecommendation(`${basePath}.details.layovers`, flight.layovers);
                
                // Store overnight indicators
                updateRecommendation(`${basePath}.details.hasDateChange`, flight.hasDateChange);
                updateRecommendation(`${basePath}.details.hasOvernightLayover`, flight.hasOvernightLayover);
                updateRecommendation(`${basePath}.details.isRedEye`, flight.isRedEye);
                if (flight.departure.date) {
                    updateRecommendation(`${basePath}.details.departureDate`, flight.departure.date);
                }
                if (flight.arrival.date) {
                    updateRecommendation(`${basePath}.details.arrivalDate`, flight.arrival.date);
                }
                
                console.log(`Selected flight: ${flight.route || flight.airline + ' ' + flight.flightNumber} (${flight.layovers === 0 ? 'Direct' : flight.layovers + ' stops'})`);
            };

            // Auto-fill functions for flight data
            const getAirlineName = (flightNumber) => {
                const airlineNames = {
                    'UA': 'United Airlines',
                    'AA': 'American Airlines', 
                    'DL': 'Delta Air Lines',
                    'WN': 'Southwest Airlines',
                    'B6': 'JetBlue Airways',
                    'AS': 'Alaska Airlines',
                    'NK': 'Spirit Airlines',
                    'F9': 'Frontier Airlines',
                    'G4': 'Allegiant Air',
                    'SY': 'Sun Country Airlines',
                    'VX': 'Virgin America',
                    'HA': 'Hawaiian Airlines',
                    'LH': 'Lufthansa',
                    'BA': 'British Airways',
                    'AF': 'Air France',
                    'KL': 'KLM Royal Dutch Airlines',
                    'IB': 'Iberia',
                    'AZ': 'Alitalia',
                    'LX': 'Swiss International Air Lines',
                    'OS': 'Austrian Airlines',
                    'SN': 'Brussels Airlines',
                    'SK': 'Scandinavian Airlines',
                    'AY': 'Finnair',
                    'EI': 'Aer Lingus',
                    'VS': 'Virgin Atlantic',
                    'TK': 'Turkish Airlines',
                    'EK': 'Emirates',
                    'QR': 'Qatar Airways',
                    'EY': 'Etihad Airways',
                    'SV': 'Saudi Arabian Airlines',
                    'MS': 'EgyptAir',
                    'ET': 'Ethiopian Airlines',
                    'KE': 'Kenya Airways',
                    'SQ': 'Singapore Airlines',
                    'TG': 'Thai Airways',
                    'CX': 'Cathay Pacific',
                    'JL': 'Japan Airlines',
                    'NH': 'All Nippon Airways',
                    'KE': 'Korean Air',
                    'OZ': 'Asiana Airlines',
                    'CI': 'China Airlines',
                    'BR': 'EVA Air',
                    'MH': 'Malaysia Airlines',
                    'GA': 'Garuda Indonesia',
                    'PH': 'Philippine Airlines',
                    'VN': 'Vietnam Airlines',
                    'AI': 'Air India',
                    'UK': 'Vistara',
                    'AC': 'Air Canada',
                    'WF': 'WestJet',
                    'AM': 'Aerom√©xico',
                    'AV': 'Avianca',
                    'LA': 'LATAM Airlines',
                    'AR': 'Austral L√≠neas A√©reas',
                    'QF': 'Qantas',
                    'JQ': 'Jetstar Airways',
                    'VA': 'Virgin Australia',
                    'NZ': 'Air New Zealand'
                };
                
                const airlineCode = flightNumber.replace(/\d+/, '').trim().toUpperCase();
                return airlineNames[airlineCode] || `${airlineCode} Airlines`;
            };

            const getAirportName = (airportCode) => {
                const airportNames = {
                    // US Major Airports
                    'JFK': 'John F. Kennedy International Airport',
                    'LGA': 'LaGuardia Airport',
                    'EWR': 'Newark Liberty International Airport',
                    'LAX': 'Los Angeles International Airport',
                    'ORD': 'Chicago O\'Hare International Airport',
                    'MDW': 'Chicago Midway International Airport',
                    'DFW': 'Dallas/Fort Worth International Airport',
                    'DEN': 'Denver International Airport',
                    'ATL': 'Hartsfield-Jackson Atlanta International Airport',
                    'MIA': 'Miami International Airport',
                    'FLL': 'Fort Lauderdale-Hollywood International Airport',
                    'MCO': 'Orlando International Airport',
                    'TPA': 'Tampa International Airport',
                    'LAS': 'Harry Reid International Airport',
                    'PHX': 'Phoenix Sky Harbor International Airport',
                    'SEA': 'Seattle-Tacoma International Airport',
                    'SFO': 'San Francisco International Airport',
                    'SJC': 'Norman Y. Mineta San Jos√© International Airport',
                    'OAK': 'Oakland International Airport',
                    'BOS': 'Logan International Airport',
                    'BWI': 'Baltimore/Washington International Airport',
                    'DCA': 'Ronald Reagan Washington National Airport',
                    'IAD': 'Washington Dulles International Airport',
                    'PHL': 'Philadelphia International Airport',
                    'MSP': 'Minneapolis-Saint Paul International Airport',
                    'DTW': 'Detroit Metropolitan Wayne County Airport',
                    'STL': 'Lambert-St. Louis International Airport',
                    'CLT': 'Charlotte Douglas International Airport',
                    'RDU': 'Raleigh-Durham International Airport',
                    'BNA': 'Nashville International Airport',
                    'MEM': 'Memphis International Airport',
                    'MSY': 'Louis Armstrong New Orleans International Airport',
                    'IAH': 'George Bush Intercontinental Airport',
                    'HOU': 'William P. Hobby Airport',
                    'AUS': 'Austin-Bergstrom International Airport',
                    'SAT': 'San Antonio International Airport',
                    'SLC': 'Salt Lake City International Airport',
                    'PDX': 'Portland International Airport',
                    'HNL': 'Daniel K. Inouye International Airport',
                    'ANC': 'Ted Stevens Anchorage International Airport',
                    
                    // European Major Airports
                    'LHR': 'London Heathrow Airport',
                    'LGW': 'London Gatwick Airport',
                    'STN': 'London Stansted Airport',
                    'LTN': 'London Luton Airport',
                    'CDG': 'Charles de Gaulle Airport',
                    'ORY': 'Orly Airport',
                    'FRA': 'Frankfurt Airport',
                    'MUC': 'Munich Airport',
                    'AMS': 'Amsterdam Airport Schiphol',
                    'MAD': 'Madrid-Barajas Airport',
                    'BCN': 'Barcelona-El Prat Airport',
                    'FCO': 'Leonardo da Vinci International Airport',
                    'MXP': 'Milan Malpensa Airport',
                    'LIN': 'Milan Linate Airport',
                    'ZUR': 'Zurich Airport',
                    'VIE': 'Vienna International Airport',
                    'BRU': 'Brussels Airport',
                    'CPH': 'Copenhagen Airport',
                    'ARN': 'Stockholm Arlanda Airport',
                    'HEL': 'Helsinki-Vantaa Airport',
                    'DUB': 'Dublin Airport',
                    'IST': 'Istanbul Airport',
                    'SAW': 'Sabiha G√∂k√ßen International Airport',
                    
                    // Asian Major Airports
                    'NRT': 'Narita International Airport',
                    'HND': 'Haneda Airport',
                    'ICN': 'Incheon International Airport',
                    'PVG': 'Shanghai Pudong International Airport',
                    'HKG': 'Hong Kong International Airport',
                    'SIN': 'Singapore Changi Airport',
                    'BKK': 'Suvarnabhumi Airport',
                    'KUL': 'Kuala Lumpur International Airport',
                    'CGK': 'Soekarno-Hatta International Airport',
                    'MNL': 'Ninoy Aquino International Airport',
                    'SGN': 'Tan Son Nhat International Airport',
                    'DEL': 'Indira Gandhi International Airport',
                    'BOM': 'Chhatrapati Shivaji Maharaj International Airport',
                    
                    // Middle Eastern Major Airports
                    'DXB': 'Dubai International Airport',
                    'DOH': 'Hamad International Airport',
                    'AUH': 'Abu Dhabi International Airport',
                    
                    // Canadian Major Airports
                    'YYZ': 'Lester B. Pearson International Airport',
                    'YVR': 'Vancouver International Airport',
                    'YUL': 'Montr√©al-Trudeau International Airport',
                    'YYC': 'Calgary International Airport',
                    
                    // Australian/Oceanian Major Airports
                    'SYD': 'Kingsford Smith Airport',
                    'MEL': 'Melbourne Airport',
                    'BNE': 'Brisbane Airport',
                    'PER': 'Perth Airport',
                    'AKL': 'Auckland Airport',
                    
                    // Latin American Major Airports
                    'MEX': 'Mexico City International Airport',
                    'CUN': 'Canc√∫n International Airport',
                    'GRU': 'S√£o Paulo/Guarulhos International Airport',
                    'GIG': 'Rio de Janeiro/Gale√£o International Airport',
                    'EZE': 'Ezeiza International Airport',
                    'SCL': 'Comodoro Arturo Merino Ben√≠tez International Airport',
                    'BOG': 'El Dorado International Airport',
                    'LIM': 'Jorge Ch√°vez International Airport'
                };
                
                return airportNames[airportCode.toUpperCase()] || `${airportCode.toUpperCase()} Airport`;
            };

            const calculateFlightDuration = (departureTime, arrivalTime) => {
                if (!departureTime || !arrivalTime) return '';
                
                try {
                    const [depHour, depMin] = departureTime.split(':').map(Number);
                    const [arrHour, arrMin] = arrivalTime.split(':').map(Number);
                    
                    const depMinutes = depHour * 60 + depMin;
                    let arrMinutes = arrHour * 60 + arrMin;
                    
                    if (arrMinutes < depMinutes) {
                        arrMinutes += 24 * 60; // Handle overnight flights
                    }
                    
                    const durationMinutes = arrMinutes - depMinutes;
                    const hours = Math.floor(durationMinutes / 60);
                    const minutes = durationMinutes % 60;
                    
                    return `${hours}h ${minutes}m`;
                } catch (error) {
                    console.log('Error calculating duration:', error);
                    return '';
                }
            };

            const autoFillFlightDetails = () => {
                const flightNumber = option.details.flightNumber || '';
                const departureTime = option.details.departure || '';
                const arrivalTime = option.details.arrival || '';
                const departureCode = option.details.departureAirport || '';
                const arrivalCode = option.details.arrivalAirport || '';

                // Auto-fill airline name
                if (flightNumber && !option.details.airline) {
                    const airlineName = getAirlineName(flightNumber);
                    updateRecommendation(`${basePath}.details.airline`, airlineName);
                }

                // Auto-fill airport names
                if (departureCode && !option.details.departureAirportName) {
                    const departureAirportName = getAirportName(departureCode);
                    updateRecommendation(`${basePath}.details.departureAirportName`, departureAirportName);
                }

                if (arrivalCode && !option.details.arrivalAirportName) {
                    const arrivalAirportName = getAirportName(arrivalCode);
                    updateRecommendation(`${basePath}.details.arrivalAirportName`, arrivalAirportName);
                }

                // Auto-calculate duration
                if (departureTime && arrivalTime && !option.duration) {
                    const duration = calculateFlightDuration(departureTime, arrivalTime);
                    updateRecommendation(`${basePath}.duration`, duration);
                }
            };

            const renderDetailsForm = () => {
                switch (transportType) {
                    case 'flight':
                        return (
                            <>
                                {/* Flight Search Section */}
                                <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '8px', marginBottom: '20px'}}>
                                    <h6 style={{margin: '0 0 15px 0', color: '#2d3748'}}>üîç Search Real Flights</h6>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>From Airport</label>
                                            <input
                                                type="text"
                                                value={option.details.details?.departure?.airportCode || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.details.departure.airportCode`, e.target.value.toUpperCase())}
                                                placeholder="e.g., JFK, LAX, ORD"
                                                style={{textTransform: 'uppercase'}}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>To Airport</label>
                                            <input
                                                type="text"
                                                value={option.details.details?.arrival?.airportCode || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.details.arrival.airportCode`, e.target.value.toUpperCase())}
                                                placeholder="e.g., JFK, LAX, ORD"
                                                style={{textTransform: 'uppercase'}}
                                            />
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Search Date</label>
                                            <input
                                                type="date"
                                                value={option.details.details?.departure?.date || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.details.departure.date`, e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Search Flights</label>
                                            <button 
                                                type="button"
                                                className="btn btn-primary"
                                                onClick={searchFlights}
                                                disabled={isSearching}
                                                style={{width: '100%', marginTop: '8px'}}
                                            >
                                                {isSearching ? 'üîç Searching...' : 'üîç Search Flights'}
                                            </button>
                                        </div>
                                    </div>
                                    {searchError && (
                                        <div style={{
                                            background: '#fed7d7',
                                            color: '#e53e3e',
                                            padding: '10px',
                                            borderRadius: '6px',
                                            marginTop: '10px',
                                            fontSize: '14px'
                                        }}>
                                            {searchError}
                                        </div>
                                    )}
                                </div>

                                {/* Flight Search Results */}
                                {flightSearchResults.length > 0 && (
                                    <div style={{marginBottom: '20px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                                            <h6 style={{margin: 0, color: '#2d3748'}}>‚úàÔ∏è Available Flights ({flightSearchResults.length})</h6>
                                            <div style={{fontSize: '11px', color: '#718096'}}>
                                                üåô Red-eye flight ‚Ä¢ ‚è∞ Overnight layover (6+ hrs)
                                            </div>
                                        </div>
                                        <div style={{maxHeight: '400px', overflowY: 'auto', border: '1px solid #e2e8f0', borderRadius: '8px'}}>
                                            {flightSearchResults.map((flight, index) => (
                                                <div 
                                                    key={flight.id}
                                                    style={{
                                                        padding: '15px',
                                                        borderBottom: index < flightSearchResults.length - 1 ? '1px solid #e2e8f0' : 'none',
                                                        cursor: 'pointer',
                                                        background: 'white',
                                                        transition: 'background-color 0.2s'
                                                    }}
                                                    onMouseOver={(e) => e.target.style.background = '#f7fafc'}
                                                    onMouseOut={(e) => e.target.style.background = 'white'}
                                                    onClick={() => selectFlight(flight)}
                                                >
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                                        <div style={{fontWeight: '600', color: '#2d3748'}}>
                                                            {flight.airline} {flight.flightNumber}
                                                            {flight.bookingUrl && (
                                                                <span style={{
                                                                    fontSize: '11px', 
                                                                    color: '#38a169', 
                                                                    marginLeft: '8px',
                                                                    background: '#f0fff4',
                                                                    padding: '2px 6px',
                                                                    borderRadius: '4px'
                                                                }}>
                                                                    üîó Bookable
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div style={{fontSize: '18px', fontWeight: '700', color: '#38a169'}}>
                                                            ${flight.price}
                                                        </div>
                                                    </div>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '14px', color: '#4a5568'}}>
                                                        <div>
                                                            <strong>{flight.departure.airport}</strong> {flight.departure.localTime}
                                                            {flight.hasDateChange && <span style={{fontSize: '11px', color: '#718096'}}> {flight.departure.date}</span>}
                                                            ‚Üí <strong>{flight.arrival.airport}</strong> {flight.arrival.localTime}
                                                            {flight.hasDateChange && <span style={{fontSize: '11px', color: '#718096'}}> {flight.arrival.date}</span>}
                                                        </div>
                                                        <div style={{textAlign: 'right'}}>
                                                            <div>{flight.totalDuration || flight.duration}</div>
                                                            <div style={{fontSize: '12px', color: '#718096'}}>
                                                                {flight.layovers === 0 ? 'Direct' : `${flight.layovers} stop${flight.layovers > 1 ? 's' : ''}`}
                                                                {flight.isRedEye && <span style={{color: '#9f7aea', marginLeft: '5px'}}>üåô</span>}
                                                                {flight.hasOvernightLayover && <span style={{color: '#f56565', marginLeft: '5px'}}>‚è∞</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style={{fontSize: '12px', color: '#718096', marginTop: '5px'}}>
                                                        {flight.route || `${flight.departure.airportName} ‚Üí ${flight.arrival.airportName}`}
                                                    </div>
                                                    {flight.layovers > 0 && (
                                                        <div style={{fontSize: '11px', color: '#9ca3af', marginTop: '3px', fontStyle: 'italic'}}>
                                                            via {flight.layoverAirports?.join(', ')} ‚Ä¢ {flight.segments?.length} segments
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Manual/Selected Flight Details */}
                                <div style={{background: '#f0fff4', padding: '15px', borderRadius: '8px', marginBottom: '20px'}}>
                                    <h6 style={{margin: '0 0 15px 0', color: '#2d3748'}}>‚úàÔ∏è Selected Flight Details</h6>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Flight Number</label>
                                            <input
                                                type="text"
                                                value={option.details.flightNumber || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.flightNumber`, e.target.value)}
                                                placeholder="e.g., UA467, AA123"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Airline</label>
                                            <input
                                                type="text"
                                                value={option.details.airline || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.airline`, e.target.value)}
                                                placeholder="e.g., United Airlines"
                                            />
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Departure Airport Name</label>
                                            <input
                                                type="text"
                                                value={option.details.departureAirportName || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.departureAirportName`, e.target.value)}
                                                placeholder="e.g., John F. Kennedy International Airport"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Arrival Airport Name</label>
                                            <input
                                                type="text"
                                                value={option.details.arrivalAirportName || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.arrivalAirportName`, e.target.value)}
                                                placeholder="e.g., Los Angeles International Airport"
                                            />
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Class</label>
                                            <select
                                                value={option.details.class || 'economy'}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.class`, e.target.value)}
                                            >
                                                <option value="economy">Economy</option>
                                                <option value="premium">Premium Economy</option>
                                                <option value="business">Business</option>
                                                <option value="first">First</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Aircraft Type</label>
                                            <input
                                                type="text"
                                                value={option.details.aircraft || ''}
                                                onChange={(e) => updateRecommendation(`${basePath}.details.aircraft`, e.target.value)}
                                                placeholder="e.g., Boeing 737-800"
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* Manual Flight Segment Builder */}
                                    <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '8px', marginTop: '15px'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                            <h6 style={{margin: 0, color: '#2d3748'}}>‚úàÔ∏è Manual Flight Segments</h6>
                                            <button 
                                                type="button"
                                                className="add-button"
                                                onClick={() => {
                                                    const currentSegments = option.details.segments || [];
                                                    const newSegment = {
                                                        from: '',
                                                        fromName: '',
                                                        to: '',
                                                        toName: '',
                                                        airline: option.details.airline || '',
                                                        flightNumber: '',
                                                        duration: '',
                                                        aircraft: '',
                                                        departureDate: '',
                                                        arrivalDate: '',
                                                        hasDateChange: false
                                                    };
                                                    updateRecommendation(`${basePath}.details.segments`, [...currentSegments, newSegment]);
                                                }}
                                            >
                                                Add Segment
                                            </button>
                                        </div>
                                        
                                        {(option.details.segments || []).map((segment, segIndex) => (
                                            <div key={segIndex} style={{
                                                background: 'white', 
                                                padding: '15px', 
                                                borderRadius: '8px', 
                                                marginBottom: '15px',
                                                border: '1px solid #e2e8f0'
                                            }}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                                    <h6 style={{margin: 0, color: '#2d3748'}}>Segment {segIndex + 1}</h6>
                                                    {(option.details.segments || []).length > 1 && (
                                                        <button 
                                                            type="button"
                                                            className="remove-button"
                                                            onClick={() => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments.splice(segIndex, 1);
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                        >
                                                            Remove
                                                        </button>
                                                    )}
                                                </div>
                                                
                                                <div className="form-row">
                                                    <div className="form-group">
                                                        <label>From Airport</label>
                                                        <input
                                                            type="text"
                                                            value={segment.from || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].from = e.target.value.toUpperCase();
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., ORD"
                                                            style={{textTransform: 'uppercase'}}
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>To Airport</label>
                                                        <input
                                                            type="text"
                                                            value={segment.to || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].to = e.target.value.toUpperCase();
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., IST"
                                                            style={{textTransform: 'uppercase'}}
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="form-row">
                                                    <div className="form-group">
                                                        <label>Flight Number</label>
                                                        <input
                                                            type="text"
                                                            value={segment.flightNumber || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].flightNumber = e.target.value;
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., TK 186"
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>Duration</label>
                                                        <input
                                                            type="text"
                                                            value={segment.duration || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].duration = e.target.value;
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., 3h 25m"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="form-row">
                                                    <div className="form-group">
                                                        <label>From Airport Name</label>
                                                        <input
                                                            type="text"
                                                            value={segment.fromName || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].fromName = e.target.value;
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., Chicago O'Hare International Airport"
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>To Airport Name</label>
                                                        <input
                                                            type="text"
                                                            value={segment.toName || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].toName = e.target.value;
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., Istanbul Airport"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="form-row">
                                                    <div className="form-group">
                                                        <label>Aircraft</label>
                                                        <input
                                                            type="text"
                                                            value={segment.aircraft || ''}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].aircraft = e.target.value;
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                            placeholder="e.g., Boeing 777-300ER"
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>Date Change</label>
                                                        <select
                                                            value={segment.hasDateChange ? 'true' : 'false'}
                                                            onChange={(e) => {
                                                                const currentSegments = [...(option.details.segments || [])];
                                                                currentSegments[segIndex].hasDateChange = e.target.value === 'true';
                                                                updateRecommendation(`${basePath}.details.segments`, currentSegments);
                                                            }}
                                                        >
                                                            <option value="false">Same Day</option>
                                                            <option value="true">Next Day (+1)</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        {(!option.details.segments || option.details.segments.length === 0) && (
                                            <div style={{
                                                textAlign: 'center', 
                                                color: '#718096', 
                                                fontStyle: 'italic',
                                                padding: '20px'
                                            }}>
                                                No segments added. Click "Add Segment" to create connecting flight details.
                                            </div>
                                        )}
                                    </div>

                                    {/* Individual Segment Details for Connecting Flights */}
                                    {option.details.segments && option.details.segments.length > 1 && (
                                        <div style={{background: '#fffaf0', padding: '15px', borderRadius: '8px', marginTop: '15px'}}>
                                            <h6 style={{margin: '0 0 15px 0', color: '#2d3748'}}>
                                                üîó Flight Segments ({option.details.segments.length})
                                            </h6>
                                            {option.details.segments.map((segment, segIndex) => (
                                                <div key={segIndex} style={{
                                                    background: 'white', 
                                                    padding: '10px', 
                                                    borderRadius: '6px', 
                                                    marginBottom: '10px',
                                                    border: '1px solid #e2e8f0'
                                                }}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                                        <div style={{fontWeight: '600', fontSize: '14px', color: '#2d3748'}}>
                                                            Segment {segIndex + 1}: {segment.airline} {segment.flightNumber}
                                                        </div>
                                                        <div style={{fontSize: '12px', color: '#718096'}}>
                                                            {segment.duration}
                                                        </div>
                                                    </div>
                                                    <div style={{fontSize: '13px', color: '#4a5568'}}>
                                                        <strong>{segment.from}</strong> ({segment.fromName}) ‚Üí <strong>{segment.to}</strong> ({segment.toName})
                                                        {segment.hasDateChange && (
                                                            <span style={{fontSize: '11px', color: '#f56565', marginLeft: '8px'}}>
                                                                üìÖ {segment.departureDate} ‚Üí {segment.arrivalDate}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div style={{fontSize: '11px', color: '#718096', marginTop: '4px'}}>
                                                        Aircraft: {segment.aircraft}
                                                    </div>
                                                </div>
                                            ))}
                                            {option.details.layoverAirports && option.details.layoverAirports.length > 0 && (
                                                <div style={{fontSize: '12px', color: '#718096', marginTop: '10px', fontStyle: 'italic'}}>
                                                    Layover airports: {option.details.layoverAirports.join(', ')}
                                                    {option.details.hasOvernightLayover && <span style={{color: '#f56565'}}> ‚Ä¢ Overnight layover</span>}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        );
                    case 'train':
                        return (
                            <>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Operator</label>
                                        <input
                                            type="text"
                                            value={option.details.details?.operatorName || ''}
                                            onChange={(e) => updateRecommendation(`${basePath}.details.details.operatorName`, e.target.value)}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Train Number</label>
                                        <input
                                            type="text"
                                            value={option.details.details?.trainNumber || ''}
                                            onChange={(e) => updateRecommendation(`${basePath}.details.details.trainNumber`, e.target.value)}
                                        />
                                    </div>
                                </div>
                            </>
                        );
                    case 'car':
                        return (
                            <>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Rental Company</label>
                                        <input
                                            type="text"
                                            value={option.details.details?.company || ''}
                                            onChange={(e) => updateRecommendation(`${basePath}.details.details.company`, e.target.value)}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Car Type</label>
                                        <input
                                            type="text"
                                            value={option.details.details?.carType || ''}
                                            onChange={(e) => updateRecommendation(`${basePath}.details.details.carType`, e.target.value)}
                                        />
                                    </div>
                                </div>
                            </>
                        );
                    default:
                        return null;
                }
            };

            return (
                <>
                    {/* Transport Type Selection */}
                    <div className="form-row">
                        <div className="form-group">
                            <label>Transport Type</label>
                            <select
                                value={transportType}
                                onChange={(e) => {
                                    updateRecommendation(`${basePath}.transportType`, e.target.value);
                                    // Update details structure when transport type changes
                                    updateRecommendation(`${basePath}.details`, createEmptyTransportDetails(e.target.value));
                                }}
                            >
                                <option value="flight">Flight</option>
                                <option value="train">Train</option>
                                <option value="bus">Bus</option>
                                <option value="ferry">Ferry</option>
                                <option value="car">Car Rental</option>
                            </select>
                        </div>
                    </div>

                    <div className="form-row">
                        <div className="form-group">
                            <label>Departure Time</label>
                            <input
                                type="time"
                                value={option.details.details?.departure?.time || ''}
                                onChange={(e) => updateRecommendation(`${basePath}.details.details.departure.time`, e.target.value)}
                            />
                        </div>
                        <div className="form-group">
                            <label>Arrival Time</label>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <input
                                    type="time"
                                    value={option.details.details?.arrival?.time || ''}
                                    onChange={(e) => updateRecommendation(`${basePath}.details.details.arrival.time`, e.target.value)}
                                    style={{flex: 1}}
                                />
                                {option.details.details?.arrival?.date && option.details.details?.departure?.date && 
                                 option.details.details.arrival.date !== option.details.details.departure.date && (
                                    <span style={{
                                        fontSize: '12px', 
                                        color: '#f56565', 
                                        fontWeight: '600',
                                        background: '#fed7d7',
                                        padding: '2px 6px',
                                        borderRadius: '4px'
                                    }}>
                                        +1
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>

                    {renderDetailsForm()}

                    {/* Cost Structure - iOS FlexibleCost format */}
                    <div className="form-row">
                        <div className="form-group">
                            <label>Payment Type</label>
                            <select
                                value={option.cost?.paymentType || 'cash'}
                                onChange={(e) => updateRecommendation(`${basePath}.cost.paymentType`, e.target.value)}
                            >
                                <option value="cash">Cash Only</option>
                                <option value="points">Points Only</option>
                                <option value="hybrid">Cash + Points</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Cash Amount</label>
                            <input
                                type="number"
                                value={option.cost?.cashAmount || 0}
                                onChange={(e) => {
                                    const amount = parseFloat(e.target.value);
                                    updateRecommendation(`${basePath}.cost.cashAmount`, amount);
                                    updateRecommendation(`${basePath}.cost.totalCashValue`, amount);
                                }}
                                placeholder="0"
                            />
                        </div>
                    </div>
                    <div className="form-row">
                        <div className="form-group">
                            <label>Points Amount</label>
                            <input
                                type="number"
                                value={option.cost?.pointsAmount || ''}
                                onChange={(e) => updateRecommendation(`${basePath}.cost.pointsAmount`, e.target.value ? parseInt(e.target.value) : null)}
                                placeholder="0 points"
                            />
                        </div>
                        <div className="form-group">
                            <label>Points Program</label>
                            <input
                                type="text"
                                value={option.cost?.pointsProgram || ''}
                                onChange={(e) => updateRecommendation(`${basePath}.cost.pointsProgram`, e.target.value || null)}
                                placeholder="e.g., Chase, Amex"
                            />
                        </div>
                    </div>

                    <div className="form-row">
                        <div className="form-group">
                            <label>Duration</label>
                            <input
                                type="text"
                                value={option.duration || ''}
                                onChange={(e) => updateRecommendation(`${basePath}.duration`, e.target.value)}
                                placeholder="e.g., 2h 30m"
                            />
                        </div>
                    </div>

                    <div className="form-group">
                        <label>
                            Booking URL
                            {option.bookingUrl && option.details.bookingToken && (
                                <span style={{
                                    fontSize: '11px', 
                                    color: '#38a169', 
                                    marginLeft: '8px',
                                    background: '#f0fff4',
                                    padding: '2px 6px',
                                    borderRadius: '4px'
                                }}>
                                    üîó From Google Flights
                                </span>
                            )}
                        </label>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <input
                                type="url"
                                value={option.bookingUrl || ''}
                                onChange={(e) => updateRecommendation(`${basePath}.bookingUrl`, e.target.value)}
                                style={{flex: 1}}
                                placeholder="Enter booking URL or select flight from search above"
                            />
                            {option.bookingUrl && (
                                <a 
                                    href={option.bookingUrl} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    style={{
                                        background: '#667eea',
                                        color: 'white',
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        textDecoration: 'none',
                                        fontSize: '12px',
                                        fontWeight: '500'
                                    }}
                                >
                                    üîó Open
                                </a>
                            )}
                        </div>
                    </div>

                    <div className="form-group">
                        <label>Notes</label>
                        <textarea
                            value={option.notes || ''}
                            onChange={(e) => updateRecommendation(`${basePath}.notes`, e.target.value)}
                            rows="2"
                        />
                    </div>
                </>
            );
        };

        // Booking Groups Component for round-trip flights
        const BookingGroupsSection = ({ segmentIndex, segment, updateRecommendation }) => (
            <div style={{background: '#f7fafc', padding: '20px', borderRadius: '8px', marginTop: '20px', border: '1px solid #e2e8f0'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                    <h4 style={{margin: 0, color: '#2d3748', fontSize: '16px'}}>
                        üé´ Booking Groups (Round-trip & Multi-segment bookings)
                    </h4>
                    <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={() => addBookingGroup(segmentIndex)}
                        style={{fontSize: '12px', padding: '6px 12px'}}
                    >
                        + Add Booking Group
                    </button>
                </div>
                
                <div style={{fontSize: '13px', color: '#4a5568', marginBottom: '15px', fontStyle: 'italic'}}>
                    Group transport options that should be booked together (e.g., round-trip flights, connecting segments)
                </div>

                {segment.bookingGroups && segment.bookingGroups.length > 0 ? (
                    segment.bookingGroups.map((group, groupIndex) => (
                        <div key={group.id || groupIndex} style={{
                            background: 'white', 
                            padding: '15px', 
                            borderRadius: '6px', 
                            marginBottom: '15px',
                            border: '1px solid #e2e8f0'
                        }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px'}}>
                                <h5 style={{margin: 0, color: '#2d3748', fontSize: '14px'}}>
                                    Booking Group #{groupIndex + 1}
                                    {group.isRoundTrip && <span style={{marginLeft: '8px', fontSize: '12px', color: '#38a169'}}>üîÑ Round-trip</span>}
                                    {group.isSelected && <span style={{marginLeft: '8px', fontSize: '12px', color: '#667eea'}}>‚úì Selected</span>}
                                    {group.isBooked && <span style={{marginLeft: '8px', fontSize: '12px', color: '#38a169'}}>‚úÖ Booked</span>}
                                </h5>
                                <button
                                    type="button"
                                    className="btn btn-danger"
                                    onClick={() => removeBookingGroup(segmentIndex, groupIndex)}
                                    style={{fontSize: '11px', padding: '4px 8px'}}
                                >
                                    Remove
                                </button>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Group Title</label>
                                    <input
                                        type="text"
                                        value={group.title || ''}
                                        onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].title`, e.target.value)}
                                        placeholder="e.g., Round-trip Madrid ‚Üî Rome"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Description</label>
                                    <input
                                        type="text"
                                        value={group.description || ''}
                                        onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].description`, e.target.value)}
                                        placeholder="e.g., Book both flights together for better pricing"
                                    />
                                </div>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>
                                        <input
                                            type="checkbox"
                                            checked={group.isRoundTrip || false}
                                            onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].isRoundTrip`, e.target.checked)}
                                            style={{marginRight: '8px'}}
                                        />
                                        Round-trip booking
                                    </label>
                                </div>
                                <div className="form-group">
                                    <label>
                                        <input
                                            type="checkbox"
                                            checked={group.isSelected || false}
                                            onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].isSelected`, e.target.checked)}
                                            style={{marginRight: '8px'}}
                                        />
                                        Recommended option
                                    </label>
                                </div>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Booking URL</label>
                                    <input
                                        type="url"
                                        value={group.bookingUrl || ''}
                                        onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].bookingUrl`, e.target.value)}
                                        placeholder="https://..."
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Booking Deadline</label>
                                    <input
                                        type="date"
                                        value={group.bookingDeadline || ''}
                                        onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].bookingDeadline`, e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="form-group">
                                <label>Total Cost Override (optional)</label>
                                <div className="form-row">
                                    <div className="form-group">
                                        <input
                                            type="number"
                                            value={group.totalCost?.cash || ''}
                                            onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].totalCost.cash`, parseFloat(e.target.value) || 0)}
                                            placeholder="Combined price"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <select
                                            value={group.totalCost?.currency || 'USD'}
                                            onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].totalCost.currency`, e.target.value)}
                                        >
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="GBP">GBP</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div className="form-group">
                                <label>Transport Options in this Group</label>
                                <div style={{fontSize: '12px', color: '#4a5568', marginBottom: '8px'}}>
                                    Select which transport options should be booked together:
                                </div>
                                {segment.transportOptions && segment.transportOptions.map((option, optionIndex) => (
                                    <label key={option.id || optionIndex} style={{
                                        display: 'block', 
                                        marginBottom: '5px',
                                        fontSize: '13px',
                                        cursor: 'pointer'
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={group.transportOptionIds?.includes(option.id) || false}
                                            onChange={(e) => {
                                                const currentIds = group.transportOptionIds || [];
                                                let updatedIds;
                                                if (e.target.checked) {
                                                    updatedIds = [...currentIds, option.id];
                                                } else {
                                                    updatedIds = currentIds.filter(id => id !== option.id);
                                                }
                                                updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].transportOptionIds`, updatedIds);
                                            }}
                                            style={{marginRight: '8px'}}
                                        />
                                        {option.transportType} - {option.details?.details?.departure?.airportCode || option.details?.details?.departure?.city} ‚Üí {option.details?.details?.arrival?.airportCode || option.details?.details?.arrival?.city}
                                        {option.cost?.cash > 0 && ` ($${option.cost.cash})`}
                                    </label>
                                ))}
                            </div>

                            <div className="form-group">
                                <label>Special Notes</label>
                                <textarea
                                    value={group.notes || ''}
                                    onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].notes`, e.target.value)}
                                    rows="2"
                                    placeholder="Additional booking instructions or notes..."
                                />
                            </div>

                            {/* Booking Status Section */}
                            <div style={{borderTop: '1px solid #e2e8f0', paddingTop: '10px', marginTop: '10px'}}>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>
                                            <input
                                                type="checkbox"
                                                checked={group.isBooked || false}
                                                onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].isBooked`, e.target.checked)}
                                                style={{marginRight: '8px'}}
                                            />
                                            Mark as booked
                                        </label>
                                    </div>
                                    {group.isBooked && (
                                        <>
                                            <div className="form-group">
                                                <label>Booking Reference</label>
                                                <input
                                                    type="text"
                                                    value={group.bookingReference || ''}
                                                    onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].bookingReference`, e.target.value)}
                                                    placeholder="Confirmation number"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Booked Date</label>
                                                <input
                                                    type="date"
                                                    value={group.bookedDate || ''}
                                                    onChange={(e) => updateRecommendation(`logistics.transportSegments[${segmentIndex}].bookingGroups[${groupIndex}].bookedDate`, e.target.value)}
                                                />
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    <div style={{
                        textAlign: 'center', 
                        color: '#718096', 
                        fontStyle: 'italic',
                        padding: '20px',
                        background: 'white',
                        borderRadius: '6px',
                        border: '1px dashed #cbd5e0'
                    }}>
                        No booking groups created yet. Add a booking group to enable round-trip and multi-segment bookings.
                    </div>
                )}
            </div>
        );

        // Costs Tab Component
        const CostsTab = ({ recommendation, updateRecommendation }) => {
            // Auto-calculate total from accommodation and transportation
            const accommodationTotal = recommendation.totalCost.accommodation || 0;
            const transportationTotal = recommendation.totalCost.flights || 0; // flights is used for transportation
            const grandTotal = accommodationTotal + transportationTotal;

            // Update the grand total whenever component renders
            React.useEffect(() => {
                if (recommendation.totalCost.totalEstimate !== grandTotal) {
                    updateRecommendation('totalCost.totalEstimate', grandTotal);
                }
            }, [accommodationTotal, transportationTotal, grandTotal]);

            return (
                <div className="form-section">
                    <h3>üí∞ Cost Breakdown</h3>
                    <div style={{fontSize: '14px', color: '#4a5568', marginBottom: '20px', fontStyle: 'italic'}}>
                        Enter manual totals for accommodations and transportation. Grand total will be calculated automatically.
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label>üè® Accommodation Total ($)</label>
                            <input
                                type="number"
                                step="0.01"
                                value={accommodationTotal}
                                onChange={(e) => updateRecommendation('totalCost.accommodation', parseFloat(e.target.value) || 0)}
                                placeholder="0.00"
                            />
                            <div style={{fontSize: '12px', color: '#718096', marginTop: '4px'}}>
                                Total cost for all hotels/lodging
                            </div>
                        </div>
                        <div className="form-group">
                            <label>‚úàÔ∏è Transportation Total ($)</label>
                            <input
                                type="number"
                                step="0.01"
                                value={transportationTotal}
                                onChange={(e) => updateRecommendation('totalCost.flights', parseFloat(e.target.value) || 0)}
                                placeholder="0.00"
                            />
                            <div style={{fontSize: '12px', color: '#718096', marginTop: '4px'}}>
                                Total cost for all flights, trains, buses, etc.
                            </div>
                        </div>
                    </div>
                    
                    <div className="form-row">
                        <div className="form-group">
                            <label>üí≥ Grand Total ($)</label>
                            <div style={{
                                padding: '12px 16px',
                                background: '#f7fafc',
                                border: '2px solid #e2e8f0',
                                borderRadius: '8px',
                                fontSize: '18px',
                                fontWeight: '600',
                                color: '#2d3748'
                            }}>
                                ${grandTotal.toFixed(2)}
                            </div>
                            <div style={{fontSize: '12px', color: '#718096', marginTop: '4px'}}>
                                Auto-calculated: Accommodation + Transportation
                            </div>
                        </div>
                        <div className="form-group">
                            <label>Currency</label>
                            <select
                                value={recommendation.totalCost.currency}
                                onChange={(e) => updateRecommendation('totalCost.currency', e.target.value)}
                            >
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                            </select>
                        </div>
                    </div>

                    <div style={{
                        marginTop: '20px',
                        padding: '15px',
                        background: '#e6fffa',
                        border: '1px solid #38d9a9',
                        borderRadius: '8px'
                    }}>
                        <div style={{fontSize: '14px', fontWeight: '600', color: '#065f46', marginBottom: '8px'}}>
                            üí° Cost Breakdown Summary
                        </div>
                        <div style={{fontSize: '13px', color: '#047857'}}>
                            ‚Ä¢ Accommodation: ${accommodationTotal.toFixed(2)}<br/>
                            ‚Ä¢ Transportation: ${transportationTotal.toFixed(2)}<br/>
                            ‚Ä¢ <strong>Total Trip Cost: ${grandTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            );
        };

        // Activities Tab Component (Destination-Based Recommendations)
        const ActivitiesTab = ({ recommendation, updateRecommendation }) => {
            const addActivity = (destIndex) => {
                const updated = { ...recommendation };
                if (!updated.destinations[destIndex].recommendedActivities) {
                    updated.destinations[destIndex].recommendedActivities = [];
                }
                updated.destinations[destIndex].recommendedActivities.push(createEmptyActivityRecommendation());
                updateRecommendation('destinations', updated.destinations);
            };

            const removeActivity = (destIndex, activityIndex) => {
                const updated = { ...recommendation };
                updated.destinations[destIndex].recommendedActivities.splice(activityIndex, 1);
                updateRecommendation('destinations', updated.destinations);
            };

            const addRestaurant = (destIndex) => {
                const updated = { ...recommendation };
                if (!updated.destinations[destIndex].recommendedRestaurants) {
                    updated.destinations[destIndex].recommendedRestaurants = [];
                }
                updated.destinations[destIndex].recommendedRestaurants.push(createEmptyRestaurantRecommendation());
                updateRecommendation('destinations', updated.destinations);
            };

            const removeRestaurant = (destIndex, restaurantIndex) => {
                const updated = { ...recommendation };
                updated.destinations[destIndex].recommendedRestaurants.splice(restaurantIndex, 1);
                updateRecommendation('destinations', updated.destinations);
            };

            return (
                <div className="form-section">
                    <h3>üéØ Activities & Restaurant Recommendations</h3>
                    <div style={{fontSize: '14px', color: '#4a5568', marginBottom: '20px', fontStyle: 'italic'}}>
                        Provide curated recommendations for activities and dining in each destination. Users can use these to plan their own day-by-day itinerary.
                    </div>

                    {recommendation.destinations.map((destination, destIndex) => (
                        <div key={destination.id || destIndex} style={{
                            background: '#f8fafc',
                            border: '1px solid #e2e8f0',
                            borderRadius: '12px',
                            padding: '20px',
                            marginBottom: '20px'
                        }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                <h4 style={{margin: 0, color: '#2d3748', fontSize: '18px'}}>
                                    üìç {destination.cityName || `Destination ${destIndex + 1}`}
                                </h4>
                            </div>

                            {/* Activities Section */}
                            <div style={{marginBottom: '25px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                    <h5 style={{margin: 0, color: '#2d3748', fontSize: '16px'}}>
                                        üéØ Recommended Activities
                                    </h5>
                                    <button
                                        type="button"
                                        className="btn btn-secondary"
                                        onClick={() => addActivity(destIndex)}
                                        style={{fontSize: '12px', padding: '6px 12px'}}
                                    >
                                        + Add Activity
                                    </button>
                                </div>

                                {destination.recommendedActivities && destination.recommendedActivities.length > 0 ? (
                                    destination.recommendedActivities.map((activity, activityIndex) => (
                                        <div key={activity.id || activityIndex} style={{
                                            background: 'white',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '8px',
                                            padding: '15px',
                                            marginBottom: '12px'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                                                <span style={{fontSize: '14px', fontWeight: '600', color: '#4a5568'}}>
                                                    Activity #{activityIndex + 1}
                                                </span>
                                                <button
                                                    type="button"
                                                    className="btn btn-danger"
                                                    onClick={() => removeActivity(destIndex, activityIndex)}
                                                    style={{fontSize: '10px', padding: '2px 6px'}}
                                                >
                                                    Remove
                                                </button>
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Activity Name</label>
                                                    <input
                                                        type="text"
                                                        value={activity.name || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].name`, e.target.value)}
                                                        placeholder="e.g., Sagrada Familia Tour, Park G√ºell Visit"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Category</label>
                                                    <select
                                                        value={activity.category || 'sightseeing'}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].category`, e.target.value)}
                                                    >
                                                        <option value="sightseeing">üèõÔ∏è Sightseeing</option>
                                                        <option value="cultural">üñºÔ∏è Cultural</option>
                                                        <option value="outdoor">üå≥ Outdoor</option>
                                                        <option value="entertainment">üé≠ Entertainment</option>
                                                        <option value="shopping">üõçÔ∏è Shopping</option>
                                                        <option value="nightlife">üç∫ Nightlife</option>
                                                        <option value="other">üìù Other</option>
                                                    </select>
                                                </div>
                                                <div className="form-group">
                                                    <label>Priority</label>
                                                    <select
                                                        value={activity.priority || 'medium'}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].priority`, e.target.value)}
                                                    >
                                                        <option value="high">üî• Must-See</option>
                                                        <option value="medium">üëç Recommended</option>
                                                        <option value="low">üí° If Time Permits</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="form-group">
                                                <label>Description</label>
                                                <textarea
                                                    value={activity.description || ''}
                                                    onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].description`, e.target.value)}
                                                    rows="3"
                                                    placeholder="Detailed description of the activity, what makes it special, what to expect..."
                                                />
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Location Name</label>
                                                    <input
                                                        type="text"
                                                        value={activity.location?.name || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].location.name`, e.target.value)}
                                                        placeholder="e.g., Sagrada Familia Basilica"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Address</label>
                                                    <input
                                                        type="text"
                                                        value={activity.location?.address || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].location.address`, e.target.value)}
                                                        placeholder="e.g., Carrer de Mallorca, 401, Barcelona"
                                                    />
                                                </div>
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Estimated Duration</label>
                                                    <input
                                                        type="text"
                                                        value={activity.estimatedDuration || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].estimatedDuration`, e.target.value)}
                                                        placeholder="e.g., 2-3 hours, Half day, Full day"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Best Time to Visit</label>
                                                    <input
                                                        type="text"
                                                        value={activity.bestTimeToVisit || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].bestTimeToVisit`, e.target.value)}
                                                        placeholder="e.g., Morning, Afternoon, Evening, Sunset"
                                                    />
                                                </div>
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Estimated Cost ($)</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        value={activity.estimatedCost?.cashAmount || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].estimatedCost.cashAmount`, parseFloat(e.target.value) || 0)}
                                                        placeholder="0.00"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>
                                                        <input
                                                            type="checkbox"
                                                            checked={activity.bookingRequired || false}
                                                            onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].bookingRequired`, e.target.checked)}
                                                            style={{marginRight: '8px'}}
                                                        />
                                                        Booking Required
                                                    </label>
                                                </div>
                                            </div>

                                            {activity.bookingRequired && (
                                                <div className="form-row">
                                                    <div className="form-group">
                                                        <label>Booking URL</label>
                                                        <input
                                                            type="url"
                                                            value={activity.bookingUrl || ''}
                                                            onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].bookingUrl`, e.target.value)}
                                                            placeholder="https://..."
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>Booking Instructions</label>
                                                        <input
                                                            type="text"
                                                            value={activity.bookingInstructions || ''}
                                                            onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].bookingInstructions`, e.target.value)}
                                                            placeholder="e.g., Book 48 hours in advance"
                                                        />
                                                    </div>
                                                </div>
                                            )}

                                            <div className="form-group">
                                                <label>Tips & Recommendations</label>
                                                <textarea
                                                    value={activity.tips?.join('\n') || ''}
                                                    onChange={(e) => {
                                                        const tips = e.target.value.split('\n').filter(tip => tip.trim() !== '');
                                                        updateRecommendation(`destinations[${destIndex}].recommendedActivities[${activityIndex}].tips`, tips);
                                                    }}
                                                    rows="2"
                                                    placeholder="Enter tips separated by new lines:&#10;Arrive early to avoid crowds&#10;Bring comfortable walking shoes"
                                                />
                                                <div style={{fontSize: '12px', color: '#718096', marginTop: '4px'}}>
                                                    Enter each tip on a new line
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div style={{
                                        textAlign: 'center',
                                        color: '#718096',
                                        fontStyle: 'italic',
                                        padding: '15px',
                                        background: 'white',
                                        borderRadius: '6px',
                                        border: '1px dashed #cbd5e0'
                                    }}>
                                        No activities added yet. Click "Add Activity" to start adding recommendations.
                                    </div>
                                )}
                            </div>

                            {/* Restaurants Section */}
                            <div>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                    <h5 style={{margin: 0, color: '#2d3748', fontSize: '16px'}}>
                                        üçΩÔ∏è Recommended Restaurants
                                    </h5>
                                    <button
                                        type="button"
                                        className="btn btn-secondary"
                                        onClick={() => addRestaurant(destIndex)}
                                        style={{fontSize: '12px', padding: '6px 12px'}}
                                    >
                                        + Add Restaurant
                                    </button>
                                </div>

                                {destination.recommendedRestaurants && destination.recommendedRestaurants.length > 0 ? (
                                    destination.recommendedRestaurants.map((restaurant, restaurantIndex) => (
                                        <div key={restaurant.id || restaurantIndex} style={{
                                            background: 'white',
                                            border: '1px solid #e2e8f0',
                                            borderRadius: '8px',
                                            padding: '15px',
                                            marginBottom: '12px'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                                                <span style={{fontSize: '14px', fontWeight: '600', color: '#4a5568'}}>
                                                    Restaurant #{restaurantIndex + 1}
                                                </span>
                                                <button
                                                    type="button"
                                                    className="btn btn-danger"
                                                    onClick={() => removeRestaurant(destIndex, restaurantIndex)}
                                                    style={{fontSize: '10px', padding: '2px 6px'}}
                                                >
                                                    Remove
                                                </button>
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Restaurant Name</label>
                                                    <input
                                                        type="text"
                                                        value={restaurant.name || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].name`, e.target.value)}
                                                        placeholder="e.g., Cal Pep, La Boqueria Market"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Cuisine Type</label>
                                                    <input
                                                        type="text"
                                                        value={restaurant.cuisine || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].cuisine`, e.target.value)}
                                                        placeholder="e.g., Spanish Tapas, Mediterranean, Local"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Meal Type</label>
                                                    <select
                                                        value={restaurant.mealType || 'dinner'}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].mealType`, e.target.value)}
                                                    >
                                                        <option value="breakfast">üç≥ Breakfast</option>
                                                        <option value="lunch">ü•ó Lunch</option>
                                                        <option value="dinner">üçΩÔ∏è Dinner</option>
                                                        <option value="snacks">üç¥ Snacks/Drinks</option>
                                                        <option value="all">üçΩÔ∏è All Day</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="form-group">
                                                <label>Description</label>
                                                <textarea
                                                    value={restaurant.description || ''}
                                                    onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].description`, e.target.value)}
                                                    rows="3"
                                                    placeholder="Description of the restaurant, atmosphere, what makes it special..."
                                                />
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Location Name</label>
                                                    <input
                                                        type="text"
                                                        value={restaurant.location?.name || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].location.name`, e.target.value)}
                                                        placeholder="e.g., El Born District"
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Address</label>
                                                    <input
                                                        type="text"
                                                        value={restaurant.location?.address || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].location.address`, e.target.value)}
                                                        placeholder="e.g., Pla√ßa de les Olles, 8, Barcelona"
                                                    />
                                                </div>
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>Price Range</label>
                                                    <select
                                                        value={restaurant.priceRange || '$$'}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].priceRange`, e.target.value)}
                                                    >
                                                        <option value="$">$ Budget-Friendly</option>
                                                        <option value="$$">$$ Mid-Range</option>
                                                        <option value="$$$">$$$ Upscale</option>
                                                        <option value="$$$$">$$$$ Fine Dining</option>
                                                    </select>
                                                </div>
                                                <div className="form-group">
                                                    <label>Priority</label>
                                                    <select
                                                        value={restaurant.priority || 'medium'}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].priority`, e.target.value)}
                                                    >
                                                        <option value="high">üî• Must-Try</option>
                                                        <option value="medium">üëç Recommended</option>
                                                        <option value="low">üí° If Available</option>
                                                    </select>
                                                </div>
                                                <div className="form-group">
                                                    <label>Estimated Cost ($)</label>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        value={restaurant.estimatedCost?.cashAmount || ''}
                                                        onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].estimatedCost.cashAmount`, parseFloat(e.target.value) || 0)}
                                                        placeholder="0.00"
                                                    />
                                                </div>
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label>
                                                        <input
                                                            type="checkbox"
                                                            checked={restaurant.reservationRequired || false}
                                                            onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].reservationRequired`, e.target.checked)}
                                                            style={{marginRight: '8px'}}
                                                        />
                                                        Reservation Required
                                                    </label>
                                                </div>
                                                {restaurant.reservationRequired && (
                                                    <div className="form-group">
                                                        <label>Reservation Instructions</label>
                                                        <input
                                                            type="text"
                                                            value={restaurant.reservationInstructions || ''}
                                                            onChange={(e) => updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].reservationInstructions`, e.target.value)}
                                                            placeholder="e.g., Call ahead, Book via OpenTable"
                                                        />
                                                    </div>
                                                )}
                                            </div>

                                            <div className="form-group">
                                                <label>Specialties (dishes to try)</label>
                                                <textarea
                                                    value={restaurant.specialties?.join('\n') || ''}
                                                    onChange={(e) => {
                                                        const specialties = e.target.value.split('\n').filter(item => item.trim() !== '');
                                                        updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].specialties`, specialties);
                                                    }}
                                                    rows="2"
                                                    placeholder="Enter specialties separated by new lines:&#10;Jam√≥n Ib√©rico&#10;Patatas Bravas&#10;Sangria"
                                                />
                                                <div style={{fontSize: '12px', color: '#718096', marginTop: '4px'}}>
                                                    Enter each specialty on a new line
                                                </div>
                                            </div>

                                            <div className="form-group">
                                                <label>Tips & Recommendations</label>
                                                <textarea
                                                    value={restaurant.tips?.join('\n') || ''}
                                                    onChange={(e) => {
                                                        const tips = e.target.value.split('\n').filter(tip => tip.trim() !== '');
                                                        updateRecommendation(`destinations[${destIndex}].recommendedRestaurants[${restaurantIndex}].tips`, tips);
                                                    }}
                                                    rows="2"
                                                    placeholder="Enter tips separated by new lines:&#10;Popular with locals&#10;No reservations - arrive early"
                                                />
                                                <div style={{fontSize: '12px', color: '#718096', marginTop: '4px'}}>
                                                    Enter each tip on a new line
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div style={{
                                        textAlign: 'center',
                                        color: '#718096',
                                        fontStyle: 'italic',
                                        padding: '15px',
                                        background: 'white',
                                        borderRadius: '6px',
                                        border: '1px dashed #cbd5e0'
                                    }}>
                                        No restaurants added yet. Click "Add Restaurant" to start adding recommendations.
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}

                    {(!recommendation.destinations || recommendation.destinations.length === 0) && (
                        <div style={{
                            textAlign: 'center',
                            color: '#718096',
                            fontStyle: 'italic',
                            padding: '30px',
                            background: '#f8fafc',
                            borderRadius: '8px',
                            border: '1px dashed #cbd5e0'
                        }}>
                            No destinations found. Please add destinations in the "Destinations" tab first, then return here to plan activities.
                        </div>
                    )}
                </div>
            );
        };

        // User Points Display Component
        const UserPointsDisplay = ({ currentUser }) => {
            const [pointsProfile, setPointsProfile] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchUserPoints = async () => {
                    if (!currentUser) return;
                    
                    try {
                        const doc = await firebase.firestore().collection('userPoints').doc(currentUser.uid).get();
                        if (doc.exists) {
                            setPointsProfile(doc.data());
                        }
                    } catch (error) {
                        console.error('Error fetching user points:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchUserPoints();
            }, [currentUser]);

            if (loading) return <div>Loading points...</div>;
            if (!pointsProfile) return null;

            return (
                <div style={{
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    padding: '20px',
                    borderRadius: '12px',
                    marginBottom: '30px'
                }}>
                    <h3 style={{margin: '0 0 15px 0', fontSize: '18px'}}>üí≥ User Points Balance</h3>
                    
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px'}}>
                        {/* Credit Card Points */}
                        {pointsProfile.creditCardPoints && Object.keys(pointsProfile.creditCardPoints).length > 0 && (
                            <div style={{background: 'rgba(255,255,255,0.1)', padding: '12px', borderRadius: '8px'}}>
                                <div style={{fontSize: '14px', opacity: '0.9', marginBottom: '8px'}}>üí≥ Credit Cards</div>
                                {Object.entries(pointsProfile.creditCardPoints).map(([program, points]) => (
                                    <div key={program} style={{fontSize: '13px', marginBottom: '4px'}}>
                                        <strong>{program}:</strong> {points.toLocaleString()} pts
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Hotel Points */}
                        {pointsProfile.hotelPoints && Object.keys(pointsProfile.hotelPoints).length > 0 && (
                            <div style={{background: 'rgba(255,255,255,0.1)', padding: '12px', borderRadius: '8px'}}>
                                <div style={{fontSize: '14px', opacity: '0.9', marginBottom: '8px'}}>üè® Hotels</div>
                                {Object.entries(pointsProfile.hotelPoints).map(([program, points]) => (
                                    <div key={program} style={{fontSize: '13px', marginBottom: '4px'}}>
                                        <strong>{program}:</strong> {points.toLocaleString()} pts
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Airline Points */}
                        {pointsProfile.airlinePoints && Object.keys(pointsProfile.airlinePoints).length > 0 && (
                            <div style={{background: 'rgba(255,255,255,0.1)', padding: '12px', borderRadius: '8px'}}>
                                <div style={{fontSize: '14px', opacity: '0.9', marginBottom: '8px'}}>‚úàÔ∏è Airlines</div>
                                {Object.entries(pointsProfile.airlinePoints).map(([program, points]) => (
                                    <div key={program} style={{fontSize: '13px', marginBottom: '4px'}}>
                                        <strong>{program}:</strong> {points.toLocaleString()} pts
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div style={{fontSize: '12px', opacity: '0.8', marginTop: '12px'}}>
                        Last updated: {pointsProfile.lastUpdated ? formatDate(pointsProfile.lastUpdated) : 'Never'}
                    </div>
                </div>
            );
        };

        // Trip List Component
        const TripsList = ({ currentUser, onSelectTrip }) => {
            const [trips, setTrips] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchTrips = async () => {
                    if (!currentUser) return;
                    
                    try {
                        const snapshot = await firebase.firestore()
                            .collection('trips')
                            .orderBy('createdAt', 'desc')
                            .limit(50) // Limit to latest 50 trips for performance
                            .get();
                        
                        const tripsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        setTrips(tripsData);
                    } catch (error) {
                        console.error('Error fetching trips:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchTrips();
            }, [currentUser]);

            if (loading) return <div className="loading">Loading trips...</div>;

            return (
                <div>
                    <h3>üìã All Trips</h3>
                    
                    {trips.length === 0 ? (
                        <div style={{
                            textAlign: 'center',
                            color: '#718096',
                            fontStyle: 'italic',
                            padding: '40px',
                            background: '#f8fafc',
                            borderRadius: '8px',
                            border: '1px dashed #cbd5e0'
                        }}>
                            No trips found. Users haven't submitted any trip requests yet.
                        </div>
                    ) : (
                        <div className="trip-grid">
                            {trips.map(trip => (
                                <TripCard key={trip.id} trip={trip} onSelect={() => onSelectTrip(trip)} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Trip Card Component with Complete Intake Information
        const TripCard = ({ trip, onSelect }) => {
            const getStatusColor = (status) => {
                switch (status) {
                    case 'completed': return '#38a169';
                    case 'in_progress': return '#3182ce';
                    case 'cancelled': return '#e53e3e';
                    default: return '#d69e2e';
                }
            };

            const formatDestinations = (trip) => {
                if (trip.destinations && trip.destinations.length > 0) {
                    return trip.destinations.join(' ‚Üí ');
                }
                return trip.destination || 'Unknown';
            };

            const formatDateRange = (startDate, endDate) => {
                try {
                    const start = new Date(startDate.seconds * 1000);
                    const end = new Date(endDate.seconds * 1000);
                    return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
                } catch (error) {
                    return 'Invalid dates';
                }
            };

            return (
                <div className="trip-card" onClick={onSelect}>
                    <div className="trip-meta">
                        Trip ID: {trip.id.slice(-8)} ‚Ä¢ Created {formatDate(trip.createdAt)}
                    </div>
                    
                    <div className="trip-title">
                        üåç {formatDestinations(trip)}
                    </div>
                    
                    <div className="trip-destinations">
                        üìÖ {formatDateRange(trip.startDate, trip.endDate)}
                        {trip.flexibleDates && <span style={{color: '#667eea', marginLeft: '8px'}}>üìù Flexible</span>}
                    </div>

                    <div style={{margin: '12px 0', fontSize: '14px', color: '#4a5568'}}>
                        <div><strong>Travel Style:</strong> {trip.travelStyle || 'Not specified'}</div>
                        <div><strong>Group Size:</strong> {trip.groupSize || 'Not specified'}</div>
                        <div><strong>Budget:</strong> {trip.budget || 'Not specified'}</div>
                        {trip.flightClass && <div><strong>Flight Class:</strong> {trip.flightClass}</div>}
                    </div>

                    {trip.interests && trip.interests.length > 0 && (
                        <div style={{margin: '8px 0'}}>
                            <div style={{fontSize: '12px', color: '#718096', marginBottom: '4px'}}>Interests:</div>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '4px'}}>
                                {trip.interests.map((interest, index) => (
                                    <span key={index} style={{
                                        background: '#e6fffa',
                                        color: '#234e52',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '11px'
                                    }}>
                                        {interest}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}

                    {trip.specialRequests && (
                        <div style={{
                            margin: '8px 0',
                            padding: '8px',
                            background: '#f7fafc',
                            borderRadius: '6px',
                            fontSize: '12px',
                            color: '#4a5568'
                        }}>
                            <strong>Special Requests:</strong> {trip.specialRequests}
                        </div>
                    )}

                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginTop: '12px'
                    }}>
                        <span className="status-badge" style={{
                            background: getStatusColor(trip.status),
                            color: 'white'
                        }}>
                            {trip.status === 'in_progress' ? 'In Progress' : 
                             trip.status === 'completed' ? 'Completed' : 
                             trip.status.charAt(0).toUpperCase() + trip.status.slice(1)}
                        </span>
                        
                        <button 
                            className="btn btn-primary"
                            style={{fontSize: '12px', padding: '6px 12px'}}
                            onClick={(e) => {
                                e.stopPropagation();
                                onSelect();
                            }}
                        >
                            View Details
                        </button>
                    </div>
                </div>
            );
        };


        // Trip Detail View Component
        const TripDetailView = ({ trip, onBack, currentUser }) => {
            const formatDateRange = (startDate, endDate) => {
                try {
                    const start = new Date(startDate.seconds * 1000);
                    const end = new Date(endDate.seconds * 1000);
                    return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
                } catch (error) {
                    return 'Invalid dates';
                }
            };

            const formatDestinations = (trip) => {
                if (trip.destinations && trip.destinations.length > 0) {
                    return trip.destinations.join(' ‚Üí ');
                }
                return trip.destination || 'Unknown';
            };

            return (
                <div>
                    {/* Header with Back Button */}
                    <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        marginBottom: '30px',
                        padding: '20px',
                        background: 'white',
                        borderRadius: '12px',
                        boxShadow: '0 2px 10px rgba(0,0,0,0.08)'
                    }}>
                        <button 
                            className="btn btn-secondary"
                            onClick={onBack}
                            style={{marginRight: '20px'}}
                        >
                            ‚Üê Back to Trips
                        </button>
                        <div>
                            <h2 style={{margin: '0 0 8px 0'}}>üåç {formatDestinations(trip)}</h2>
                            <div style={{color: '#718096', fontSize: '14px'}}>
                                Trip ID: {trip.id} ‚Ä¢ Created {formatDate(trip.createdAt)}
                            </div>
                        </div>
                    </div>

                    {/* Trip Details Grid */}
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '30px', marginBottom: '30px'}}>
                        
                        {/* Basic Trip Information */}
                        <div className="section">
                            <h3>üìã Trip Information</h3>
                            <div style={{fontSize: '14px', lineHeight: '1.8'}}>
                                <div><strong>Destinations:</strong> {formatDestinations(trip)}</div>
                                <div><strong>Dates:</strong> {formatDateRange(trip.startDate, trip.endDate)}</div>
                                <div><strong>Flexible Dates:</strong> {trip.flexibleDates ? 'Yes' : 'No'}</div>
                                <div><strong>Status:</strong> 
                                    <span style={{
                                        marginLeft: '8px',
                                        padding: '2px 8px',
                                        borderRadius: '12px',
                                        fontSize: '12px',
                                        background: trip.status === 'completed' ? '#c6f6d5' : 
                                                   trip.status === 'in_progress' ? '#bee3f8' : '#fed7d7',
                                        color: trip.status === 'completed' ? '#276749' : 
                                               trip.status === 'in_progress' ? '#2b6cb0' : '#c53030'
                                    }}>
                                        {trip.status.charAt(0).toUpperCase() + trip.status.slice(1)}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Travel Preferences */}
                        <div className="section">
                            <h3>‚úàÔ∏è Travel Preferences</h3>
                            <div style={{fontSize: '14px', lineHeight: '1.8'}}>
                                <div><strong>Travel Style:</strong> {trip.travelStyle || 'Not specified'}</div>
                                <div><strong>Group Size:</strong> {trip.groupSize || 'Not specified'}</div>
                                <div><strong>Budget:</strong> {trip.budget || 'Not specified'}</div>
                                <div><strong>Flight Class:</strong> {trip.flightClass || 'Not specified'}</div>
                                <div><strong>Payment Method:</strong> {trip.paymentMethod || 'Not specified'}</div>
                            </div>
                        </div>
                    </div>

                    {/* Interests */}
                    {trip.interests && trip.interests.length > 0 && (
                        <div className="section" style={{marginBottom: '30px'}}>
                            <h3>üéØ Interests & Activities</h3>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                {trip.interests.map((interest, index) => (
                                    <span key={index} style={{
                                        background: '#e6fffa',
                                        color: '#234e52',
                                        padding: '6px 12px',
                                        borderRadius: '20px',
                                        fontSize: '13px',
                                        fontWeight: '500'
                                    }}>
                                        {interest}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Special Requests */}
                    {trip.specialRequests && (
                        <div className="section" style={{marginBottom: '30px'}}>
                            <h3>üìù Special Requests</h3>
                            <div style={{
                                padding: '15px',
                                background: '#f7fafc',
                                borderRadius: '8px',
                                fontSize: '14px',
                                lineHeight: '1.6',
                                color: '#4a5568'
                            }}>
                                {trip.specialRequests}
                            </div>
                        </div>
                    )}

                    {/* Recommendation Status */}
                    {trip.destinationRecommendation || trip.recommendation ? (
                        <div className="section">
                            <h3>üéØ Recommendation Status</h3>
                            <div style={{
                                padding: '20px',
                                background: '#e6fffa',
                                border: '1px solid #38d9a9',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{fontSize: '16px', fontWeight: '600', color: '#065f46', marginBottom: '8px'}}>
                                    ‚úÖ Recommendation Available
                                </div>
                                <div style={{fontSize: '14px', color: '#047857'}}>
                                    A detailed recommendation has been created for this trip.
                                </div>
                                <button 
                                    className="btn btn-primary"
                                    style={{marginTop: '15px'}}
                                    onClick={() => {
                                        // You can add navigation to edit the recommendation here
                                        alert('Navigate to recommendation editor - this can be implemented based on your needs');
                                    }}
                                >
                                    View/Edit Recommendation
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="section">
                            <h3>üéØ Recommendation Status</h3>
                            <div style={{
                                padding: '20px',
                                background: '#fef5e7',
                                border: '1px solid #f6e05e',
                                borderRadius: '8px',
                                textAlign: 'center'
                            }}>
                                <div style={{fontSize: '16px', fontWeight: '600', color: '#744210', marginBottom: '8px'}}>
                                    ‚è≥ No Recommendation Yet
                                </div>
                                <div style={{fontSize: '14px', color: '#8d4600', marginBottom: '15px'}}>
                                    This trip needs a recommendation to be created.
                                </div>
                                <button 
                                    className="btn btn-primary"
                                    onClick={() => {
                                        alert('This would navigate to create a new recommendation for this trip');
                                    }}
                                >
                                    Create Recommendation
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Recommendation Creator Component (placeholder for existing functionality)
        const RecommendationCreator = ({ currentUser }) => {
            return (
                <div className="section">
                    <h3>‚ûï Create New Recommendation</h3>
                    <div style={{
                        padding: '40px',
                        textAlign: 'center',
                        background: '#f8fafc',
                        borderRadius: '8px',
                        border: '1px dashed #cbd5e0'
                    }}>
                        <div style={{fontSize: '16px', color: '#4a5568', marginBottom: '15px'}}>
                            This is where the existing recommendation creation functionality would go.
                        </div>
                        <div style={{fontSize: '14px', color: '#718096'}}>
                            The tabs for Destinations, Logistics, Activities, and Costs can be integrated here.
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component with Authentication
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                // Set up authentication state listener
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setCurrentUser(user);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const handleSignOut = async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            };

            if (isLoading) {
                return (
                    <div style={{
                        minHeight: '100vh',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        background: '#f5f7fa'
                    }}>
                        <div style={{textAlign: 'center', color: '#718096'}}>
                            <div style={{fontSize: '18px'}}>Loading...</div>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return <AuthenticationView onSignIn={setCurrentUser} />;
            }

            return <Dashboard currentUser={currentUser} onSignOut={handleSignOut} />;
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>